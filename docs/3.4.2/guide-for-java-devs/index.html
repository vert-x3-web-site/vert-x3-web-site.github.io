<!DOCTYPE html>
<html lang="en">
<head>
  <title>A gentle guide to asynchronous programming with Eclipse Vert.x for Java developers - Vert.x</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name="description">
  <link href="http://vertx.io/stylesheets/docs.css" media="screen" rel="stylesheet">
  <link href="http://vertx.io/stylesheets/font-awesome.min.css" media="screen" rel="stylesheet">
  <link href="http://vertx.io/javascripts/styles/rainbow.min.css" media="screen" rel="stylesheet">
  <!-- IE 6-8 support of HTML 5 elements -->
  <!--[if lt IE 9]>
  <script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script>
  <![endif]-->

  <link rel="apple-touch-icon" sizes="57x57" href="http://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="http://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="http://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="http://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="http://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="http://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="http://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="http://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="http://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="http://vertx.io/assets/favicons/vertx-favicon-7/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="http://vertx.io/assets/favicons/vertx-favicon-7/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="http://vertx.io/assets/favicons/vertx-favicon-7/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="http://vertx.io/assets/favicons/vertx-favicon-7/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="http://vertx.io/assets/favicons/vertx-favicon-7/manifest.json">
  <link rel="mask-icon" href="http://vertx.io/assets/favicons/vertx-favicon-7/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#7d3194">
  <meta name="msapplication-TileImage" content="http://vertx.io/assets/favicons/vertx-favicon-7/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link href="http://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel="stylesheet" type="text/css">
  <link rel="alternate" type="application/rss+xml" title="RSS"
     href="http://vertx.io/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');
  </script>
</head>
<body>

<a href="http://www.reactivemanifesto.org/" id="reactive-manifesto-banner">
  <img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000"
    src="http://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png">
</a>

<a id="skippy" class="sr-only sr-only-focusable" href="#content"><div class="container"><span class="skiplink-text">Skip to main content</span></div></a>

<header class="navbar navbar-default navbar-static-top" id="top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#vertx-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="http://vertx.io/" class="navbar-brand"><img alt="Brand" src="http://vertx.io/assets/logo-sm.png"></a>
    </div>
    <nav class="collapse navbar-collapse" id="vertx-navbar-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://vertx.io/download/">Download</a></li>
        <li><a href="http://vertx.io/docs/3.4.2/">Documentation</a></li>
        <li><a href="https://github.com/vert-x3/wiki/wiki">Wiki</a></li>
        <li><a href="http://vertx.io/community/">Community</a></li>
        <li><a href="http://vertx.io/materials/">Materials</a></li>
        <li><a href="http://vertx.io/blog/">Blog</a></li>        
      </ul>
    </nav>
  </div>
</header>



  <div class="page-header" id="content">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1>A gentle guide to asynchronous programming with Eclipse Vert.x for Java developers</h1>
          
        </div>
      </div>
    </div>
  </div>



<div id="content">
  <div class="container docs-content">
    <div class="row">
      <div class="col-sm-12 col-md-push-9 col-md-3 hidden-xs hidden-sm">
        <div id="sidebar" data-spy="affix">
          <ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_about_this_guide">About this guide</a></li>
<li><a href="#_what_is_vert_x">What is Vert.x?</a></li>
<li><a href="#_core_vert_x_concepts">Core Vert.x concepts</a></li>
</ul>
</li>
<li><a href="#_a_minimally_viable_wiki_written_with_vert_x">A minimally viable wiki written with Vert.x</a>
<ul class="sectlevel2">
<li><a href="#_bootstrapping_a_maven_project">Bootstrapping a Maven project</a></li>
<li><a href="#_adding_the_required_dependencies">Adding the required dependencies</a></li>
<li><a href="#_anatomy_of_a_verticle">Anatomy of a verticle</a></li>
<li><a href="#_a_word_on_vert_x_future_objects_and_callbacks">A word on Vert.x future objects and callbacks</a></li>
<li><a href="#_wiki_verticle_initialization_phases">Wiki verticle initialization phases</a></li>
<li><a href="#_http_router_handlers">HTTP router handlers</a></li>
<li><a href="#_running_the_application">Running the application</a></li>
</ul>
</li>
<li><a href="#_refactoring_into_independent_and_reusable_verticles">Refactoring into independent and reusable verticles</a>
<ul class="sectlevel2">
<li><a href="#_architecture_and_technical_choices">Architecture and technical choices</a></li>
<li><a href="#_the_http_server_verticle">The HTTP server verticle</a></li>
<li><a href="#_the_database_verticle">The database verticle</a></li>
<li><a href="#_deploying_the_verticles_from_a_main_verticle">Deploying the verticles from a main verticle</a></li>
</ul>
</li>
<li><a href="#_refactoring_to_vert_x_services">Refactoring to Vert.x services</a>
<ul class="sectlevel2">
<li><a href="#_maven_configuration_changes">Maven configuration changes</a></li>
<li><a href="#_database_service_interface">Database service interface</a></li>
<li><a href="#_database_service_implementation">Database service implementation</a></li>
<li><a href="#_exposing_the_database_service_from_the_database_verticle">Exposing the database service from the database verticle</a></li>
<li><a href="#_obtaining_a_database_service_proxy">Obtaining a database service proxy</a></li>
</ul>
</li>
<li><a href="#_testing_vert_x_code">Testing Vert.x code</a>
<ul class="sectlevel2">
<li><a href="#_getting_started">Getting started</a></li>
<li><a href="#_testing_database_operations">Testing database operations</a></li>
</ul>
</li>
<li><a href="#_integrating_with_a_3rd_party_web_service">Integrating with a 3rd-party web service</a>
<ul class="sectlevel2">
<li><a href="#_scenario_backing_up_to_github_gist">Scenario: backing up to GitHub Gist</a></li>
<li><a href="#_updating_the_database_service">Updating the database service</a></li>
<li><a href="#_the_web_client_api">The web client API</a></li>
<li><a href="#_creating_anonymous_gists">Creating anonymous Gists</a></li>
</ul>
</li>
<li><a href="#_exposing_a_web_api">Exposing a web API</a>
<ul class="sectlevel2">
<li><a href="#_web_sub_routers">Web sub-routers</a></li>
<li><a href="#_handlers">Handlers</a></li>
<li><a href="#_unit_testing_the_api">Unit testing the API</a></li>
</ul>
</li>
<li><a href="#_securing_and_controlling_access">Securing and controlling access</a>
<ul class="sectlevel2">
<li><a href="#_https_support_in_vert_x">HTTPS support in Vert.x</a></li>
<li><a href="#_access_control_and_authentication">Access control and authentication</a></li>
<li><a href="#_authenticating_web_api_requests_with_jwt">Authenticating web API requests with JWT</a></li>
</ul>
</li>
<li><a href="#_reactive_programming_with_rxjava">Reactive programming with RxJava</a>
<ul class="sectlevel2">
<li><a href="#_enabling_the_rxjava_apis">Enabling the RxJava APIs</a></li>
<li><a href="#_deploying_verticles_in_order">Deploying verticles in order</a></li>
<li><a href="#_executing_authorization_queries_concurrently">Executing authorization queries concurrently</a></li>
<li><a href="#_working_with_database_connections">Working with database connections</a></li>
<li><a href="#_bridging_the_gap_between_callbacks_and_rxjava">Bridging the gap between callbacks and RxJava</a></li>
<li><a href="#_data_flows">Data flows</a></li>
</ul>
</li>
<li><a href="#_client_side_web_application_using_angularjs">Client-side web application using AngularJS</a>
<ul class="sectlevel2">
<li><a href="#_single_page_application">Single page application</a></li>
<li><a href="#_vert_x_backend">Vert.x Backend</a></li>
<li><a href="#_angularjs_frontend">AngularJS frontend</a></li>
</ul>
</li>
<li><a href="#_real_time_web_features_using_cross_border_messaging_over_the_event_bus">Real-time web features using cross-border messaging over the event bus</a>
<ul class="sectlevel2">
<li><a href="#_setting_up_the_sockjs_event_bus_bridge">Setting up the SockJS event bus bridge</a></li>
<li><a href="#_sending_the_markdown_content_over_the_event_bus_for_processing">Sending the Markdown content over the event bus for processing</a></li>
<li><a href="#_warning_the_user_when_the_page_is_modified">Warning the user when the page is modified</a></li>
</ul>
</li>
<li><a href="#_conclusion">Conclusion</a>
<ul class="sectlevel2">
<li><a href="#_summary">Summary</a></li>
<li><a href="#_going_further">Going further</a></li>
<li><a href="#_that_s_all_folks">That&#8217;s all folks!</a></li>
</ul>
</li>
</ul>
        </div>
      </div>
      <div class="col-sm-12 col-md-pull-3 col-md-9">
        <div class="toc hidden-md hidden-lg">
          <h2>Table of Contents</h2>
          <ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#_about_this_guide">About this guide</a></li>
<li><a href="#_what_is_vert_x">What is Vert.x?</a></li>
<li><a href="#_core_vert_x_concepts">Core Vert.x concepts</a></li>
</ul>
</li>
<li><a href="#_a_minimally_viable_wiki_written_with_vert_x">A minimally viable wiki written with Vert.x</a>
<ul class="sectlevel2">
<li><a href="#_bootstrapping_a_maven_project">Bootstrapping a Maven project</a></li>
<li><a href="#_adding_the_required_dependencies">Adding the required dependencies</a></li>
<li><a href="#_anatomy_of_a_verticle">Anatomy of a verticle</a></li>
<li><a href="#_a_word_on_vert_x_future_objects_and_callbacks">A word on Vert.x future objects and callbacks</a></li>
<li><a href="#_wiki_verticle_initialization_phases">Wiki verticle initialization phases</a></li>
<li><a href="#_http_router_handlers">HTTP router handlers</a></li>
<li><a href="#_running_the_application">Running the application</a></li>
</ul>
</li>
<li><a href="#_refactoring_into_independent_and_reusable_verticles">Refactoring into independent and reusable verticles</a>
<ul class="sectlevel2">
<li><a href="#_architecture_and_technical_choices">Architecture and technical choices</a></li>
<li><a href="#_the_http_server_verticle">The HTTP server verticle</a></li>
<li><a href="#_the_database_verticle">The database verticle</a></li>
<li><a href="#_deploying_the_verticles_from_a_main_verticle">Deploying the verticles from a main verticle</a></li>
</ul>
</li>
<li><a href="#_refactoring_to_vert_x_services">Refactoring to Vert.x services</a>
<ul class="sectlevel2">
<li><a href="#_maven_configuration_changes">Maven configuration changes</a></li>
<li><a href="#_database_service_interface">Database service interface</a></li>
<li><a href="#_database_service_implementation">Database service implementation</a></li>
<li><a href="#_exposing_the_database_service_from_the_database_verticle">Exposing the database service from the database verticle</a></li>
<li><a href="#_obtaining_a_database_service_proxy">Obtaining a database service proxy</a></li>
</ul>
</li>
<li><a href="#_testing_vert_x_code">Testing Vert.x code</a>
<ul class="sectlevel2">
<li><a href="#_getting_started">Getting started</a></li>
<li><a href="#_testing_database_operations">Testing database operations</a></li>
</ul>
</li>
<li><a href="#_integrating_with_a_3rd_party_web_service">Integrating with a 3rd-party web service</a>
<ul class="sectlevel2">
<li><a href="#_scenario_backing_up_to_github_gist">Scenario: backing up to GitHub Gist</a></li>
<li><a href="#_updating_the_database_service">Updating the database service</a></li>
<li><a href="#_the_web_client_api">The web client API</a></li>
<li><a href="#_creating_anonymous_gists">Creating anonymous Gists</a></li>
</ul>
</li>
<li><a href="#_exposing_a_web_api">Exposing a web API</a>
<ul class="sectlevel2">
<li><a href="#_web_sub_routers">Web sub-routers</a></li>
<li><a href="#_handlers">Handlers</a></li>
<li><a href="#_unit_testing_the_api">Unit testing the API</a></li>
</ul>
</li>
<li><a href="#_securing_and_controlling_access">Securing and controlling access</a>
<ul class="sectlevel2">
<li><a href="#_https_support_in_vert_x">HTTPS support in Vert.x</a></li>
<li><a href="#_access_control_and_authentication">Access control and authentication</a></li>
<li><a href="#_authenticating_web_api_requests_with_jwt">Authenticating web API requests with JWT</a></li>
</ul>
</li>
<li><a href="#_reactive_programming_with_rxjava">Reactive programming with RxJava</a>
<ul class="sectlevel2">
<li><a href="#_enabling_the_rxjava_apis">Enabling the RxJava APIs</a></li>
<li><a href="#_deploying_verticles_in_order">Deploying verticles in order</a></li>
<li><a href="#_executing_authorization_queries_concurrently">Executing authorization queries concurrently</a></li>
<li><a href="#_working_with_database_connections">Working with database connections</a></li>
<li><a href="#_bridging_the_gap_between_callbacks_and_rxjava">Bridging the gap between callbacks and RxJava</a></li>
<li><a href="#_data_flows">Data flows</a></li>
</ul>
</li>
<li><a href="#_client_side_web_application_using_angularjs">Client-side web application using AngularJS</a>
<ul class="sectlevel2">
<li><a href="#_single_page_application">Single page application</a></li>
<li><a href="#_vert_x_backend">Vert.x Backend</a></li>
<li><a href="#_angularjs_frontend">AngularJS frontend</a></li>
</ul>
</li>
<li><a href="#_real_time_web_features_using_cross_border_messaging_over_the_event_bus">Real-time web features using cross-border messaging over the event bus</a>
<ul class="sectlevel2">
<li><a href="#_setting_up_the_sockjs_event_bus_bridge">Setting up the SockJS event bus bridge</a></li>
<li><a href="#_sending_the_markdown_content_over_the_event_bus_for_processing">Sending the Markdown content over the event bus for processing</a></li>
<li><a href="#_warning_the_user_when_the_page_is_modified">Warning the user when the page is modified</a></li>
</ul>
</li>
<li><a href="#_conclusion">Conclusion</a>
<ul class="sectlevel2">
<li><a href="#_summary">Summary</a></li>
<li><a href="#_going_further">Going further</a></li>
<li><a href="#_that_s_all_folks">That&#8217;s all folks!</a></li>
</ul>
</li>
</ul>
        </div>
        <div id="preamble">
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You can read the latest published version of the guide at <a href="http://vertx.io/docs/3.4.2/guide-for-java-devs/" class="bare">http://vertx.io/docs/3.4.2/guide-for-java-devs/</a>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This document is also <a href="guide-for-java-devs.pdf">available as a PDF</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide is a gentle introduction to asynchronous programming with Vert.x, primarily aimed at developers familiar with mainstream non-asynchronous web development frameworks and libraries (e.g., Java EE, Spring).</p>
</div>
<div class="sect2">
<h3 id="_about_this_guide">About this guide</h3>
<div class="paragraph">
<p>We assume that the reader is familiar with the Java programming language and its ecosystem.</p>
</div>
<div class="paragraph">
<p>We will start from a wiki web application backed by a relational database and server-side rendering of pages; then we will evolve the application through several steps until it becomes a modern single-page application with "real-time".<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup> web features.
Along the way you will learn to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Design a web application with server-side rendering of pages through templates, and using a relational database for persisting data.</p>
</li>
<li>
<p>Cleanly isolate each technical component as a reusable event processing unit called a <em>verticle</em>.</p>
</li>
<li>
<p>Extract Vert.x services for facilitating the design of verticles that communicate with each other seamlessly both within the same JVM process or among distributed nodes in a cluster.</p>
</li>
<li>
<p>Testing code with asynchronous operations.</p>
</li>
<li>
<p>Integrating with third-party services exposing a HTTP/JSON web API.</p>
</li>
<li>
<p>Exposing a HTTP/JSON web API.</p>
</li>
<li>
<p>Securing and controlling access using HTTPS, user authentication for web browser sessions and JWT tokens for third-party client applications.</p>
</li>
<li>
<p>Refactoring some code to use reactive programming with the popular RxJava library and its Vert.x integration.</p>
</li>
<li>
<p>Client-side programming of a single-page application with AngularJS.</p>
</li>
<li>
<p>Real-time web programming using the unified Vert.x event bus integration over SockJS.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The source of both this document and the code examples are available from <a href="https://github.com/vert-x3/vertx-guide-for-java-devs" class="bare">https://github.com/vert-x3/vertx-guide-for-java-devs</a>.
We welcome issue reports, feedback and pull-requests!
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_what_is_vert_x">What is Vert.x?</h3>
<div class="quoteblock">
<blockquote>
Eclipse Vert.x is a toolkit for building reactive applications on the JVM.
</blockquote>
<div class="attribution">
&#8212; Vert.x website
</div>
</div>
<div class="paragraph">
<p>Eclipse Vert.x (which we will just call <em>Vert.x</em> in the remainder of this document) is an opensource project at the Eclipse Foundation.
Vert.x was initiated in 2012 by Tim Fox.</p>
</div>
<div class="paragraph">
<p>Vert.x is not a framework but a toolkit: the core library defines the fundamental APIs for writing asynchronous networked applications, and then you can pick the useful modules for your application (e.g., database connection, monitoring, authentication, logging, service discovery, clustering support, etc).
Vert.x is based on the <a href="http://netty.io/">Netty project</a>, a high-performance asynchronous networking library for the JVM.
Vert.x will let you access the Netty internals <em>if need be</em>, but in general you will better benefit from the higher-level APIs that Vert.x provides while not sacrificing performance compared to <em>raw</em> Netty.</p>
</div>
<div class="paragraph">
<p>Vert.x does not impose any packaging or build environment.
Since Vert.x core itself is just a regular Jar library it can be embedded inside applications packaged as a set of Jars, a single Jar with all dependencies, or it can even be deployed inside popular component and application containers.</p>
</div>
<div class="paragraph">
<p>Because Vert.x was designed for asynchronous communications it can deal with more concurrent network connections with less threads than synchronous APIs such as Java servlets or <code>java.net</code> socket classes.
Vert.x is useful for a large range of applications: high volume message / event processing, micro-services, API gateways, HTTP APIs for mobile applications, etc.
Vert.x and its ecosystem provide all sorts of technical tools for building end-to-end reactive applications.</p>
</div>
<div class="paragraph">
<p>While it may sound like Vert.x is only useful for demanding applications, the present guide also states that Vert.x works very well for more traditional web applications.
As we will see, the code will remain relatively easy to comprehend, but if the application needs to face a sudden peak in traffic then the code is already written with the essential ingredient for scaling up: <em>asynchronous processing of events</em>.</p>
</div>
<div class="paragraph">
<p>Finally, it is worth mentioning that Vert.x is <em>polyglot</em> as it supports a wide range of popular JVM languages: Java, Groovy, Scala, Kotlin, JavaScript, Ruby and Ceylon.
The goal when supporting a language in Vert.x is not just to provide access to the APIs, but also to make sure that the language-specific APIs are idiomatic in each target language (e.g., using Scala futures in place of Vert.x futures).
It is well-possible to develop different technical parts of a Vert.x application using different JVM languages.</p>
</div>
</div>
<div class="sect2">
<h3 id="_core_vert_x_concepts">Core Vert.x concepts</h3>
<div class="paragraph">
<p>There are 2 key concepts to learn in Vert.x:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>what a <em>verticle</em> is, and</p>
</li>
<li>
<p>how the <em>event bus</em> allows verticles to communicate.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_threading_and_programming_models">Threading and programming models</h4>
<div class="paragraph">
<p>Many networking libraries and frameworks rely on a simple threading strategy: each network client is being assigned a thread upon connection, and this thread deals with the client until it disconnects.
This is the case with Servlet or networking code written with the <code>java.io</code> and <code>java.net</code> packages.
While this <em>"synchronous I/O"</em> threading model has the advantage of remaining simple to comprehend, it hurts scalability with too many concurrent connections as system threads are not cheap, and under heavy loads an operating system kernel spends significant time <em>just</em> on thread scheduling management.
In such cases we need to move to <em>"asynchronous I/O"</em> for which Vert.x provides a solid foundation.</p>
</div>
<div class="paragraph">
<p>The unit of deployment in Vert.x is called a <em>Verticle</em>.
A verticle processes incoming events over an <em>event-loop</em>, where events can be anything like receiving network buffers, timing events, or messages sent by other verticles.
Event-loops are typical in asynchronous programming models:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="intro/images/event-loop.png" alt="event loop">
</div>
</div>
<div class="paragraph">
<p>Each event shall be processed in a <em>reasonable</em> amount of time to not block the event loop.
This means that <em>thread blocking</em> operations shall not be performed while executed on the event loop, exactly like processing events in a graphical user interface (e.g., freezing a Java / Swing interface by doing a slow network request).
As we will see later in this guide, Vert.x offers mechanisms to deal with blocking operations outside of the event loop.
In any case Vert.x emits warnings in logs when the event loop has been processing an event for <em>too long</em>, which is also configurable to match application-specific requirements (e.g., when working on slower IoT ARM boards).</p>
</div>
<div class="paragraph">
<p>Every event loop is attached to a thread.
By default Vert.x attaches 2 event loops per CPU core thread.
The direct consequence is that a regular verticle always processes events on the same thread, so there is no need to use thread coordination mechanisms to manipulate a verticle state (e.g, Java class fields).</p>
</div>
<div class="paragraph">
<p>A verticle can be passed some configuration (e.g., credentials, network addresses, etc) and a verticle can be deployed several times:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="intro/images/verticle-threading-config.png" alt="verticle threading config">
</div>
</div>
<div class="paragraph">
<p>Incoming network data are being received from accepting threads then passed as events to the corresponding verticles.
When a verticle opens a network server and is deployed more than once, then the events are being distributed to the verticle instances in a round-robin fashion which is very useful for maximizing CPU usage with lots of concurrent networked requests.
Finally, verticles have a simple start / stop life-cycle, and verticles can deploy other verticles.</p>
</div>
</div>
<div class="sect3">
<h4 id="_event_bus">Event bus</h4>
<div class="paragraph">
<p>Verticles form technical units of deployments of code in Vert.x.
The Vert.x <em>event bus</em> is the main tool for different verticles to communicate through asynchronous message passing.
For instance suppose that we have a verticle for dealing with HTTP requests, and a verticle for managing access to the database.
The event bus allows the HTTP verticle to send a request to the database verticle that performs a SQL query, and responds back to the HTTP verticle:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="intro/images/event-bus.png" alt="event bus">
</div>
</div>
<div class="paragraph">
<p>The event-bus allows passing any kind of data, although JSON is the preferred exchange format since it allows verticles written in different languages to communicate, and more generally JSON is a popular general-purpose semi-structured data marshaling text format.</p>
</div>
<div class="paragraph">
<p>Message can be sent to <em>destinations</em> which are free-form strings.
The event bus supports the following communication patterns:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>point-to-point messaging, and</p>
</li>
<li>
<p>request-response messaging and</p>
</li>
<li>
<p>publish / subscribe for broadcasting messages.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The event bus allows verticles to transparently communicate not just within the same JVM process:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when network clustering is activated, the event bus is <em>distributed</em> so that messages can be sent to verticles running on other application nodes,</p>
</li>
<li>
<p>the event-bus can be accessed through a simple TCP protocol for third-party applications to communicate,</p>
</li>
<li>
<p>the event-bus can also be exposed over general-purpose messaging bridges (e.g, AMQP, Stomp),</p>
</li>
<li>
<p>a SockJS bridge allows web applications to seamlessly communicate over the event bus from JavaScript running in the browser by receiving and publishing messages just like any verticle would do.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_a_minimally_viable_wiki_written_with_vert_x">A minimally viable wiki written with Vert.x</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The corresponding source code is in the <code>step-1</code> folder of the guide repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We are going to start with a first iteration and the simplest code possible to have a wiki written with Vert.x.
While the next iterations will introduce more elegance into the code base as well as proper testing, we will see that quick prototyping with Vert.x is both a simple and a realistic target.</p>
</div>
<div class="paragraph">
<p>At this stage the wiki will use server-side rendering of HTML pages and data persistence through a JDBC connection.
To do so, we will use the following libraries.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://vertx.io/docs/3.4.2/vertx-web/java/">Vert.x web</a> as while the Vert.x core library <em>does</em> support the creation of HTTP servers, it does not provide elegant APIs to deal with routing, handling of request payloads, etc.</p>
</li>
<li>
<p><a href="http://vertx.io/docs/3.4.2/vertx-jdbc-client/java/">Vert.x JDBC client</a> to provide an asynchronous API over JDBC.</p>
</li>
<li>
<p><a href="http://freemarker.org/">Apache FreeMarker</a> to render server-side pages as it is an uncomplicated template engine.</p>
</li>
<li>
<p><a href="https://github.com/rjeschke/txtmark">Txtmark</a> to render Markdown text to HTML, allowing the edition of wiki pages in Markdown.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_bootstrapping_a_maven_project">Bootstrapping a Maven project</h3>
<div class="paragraph">
<p>This guide makes the choice of using <a href="https://maven.apache.org">Apache Maven</a> as the build tool, primarily because it is very well integrated with the major integrated development environments.
You can equally use another build tool such as <a href="https://gradle.org/">Gradle</a>.</p>
</div>
<div class="paragraph">
<p>The Vert.x community offers a template project structure from <a href="https://github.com/vert-x3/vertx-maven-starter" class="bare">https://github.com/vert-x3/vertx-maven-starter</a> that can be cloned.
Since you will likely want to use (Git) version control as well, the fastest route is to clone the repository, delete its <code>.git/</code> folder and then create a new Git repository:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>git clone https://github.com/vert-x3/vertx-maven-starter.git vertx-wiki
cd vertx-wiki
rm -rf .git
git init</pre>
</div>
</div>
<div class="paragraph">
<p>The project offers a sample verticle as well as a unit test.
You can safely delete all <code>.java</code> files beneath <code>src/</code> to hack on the wiki, but before doing so you may test that the project builds and runs successfully:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mvn package exec:java</pre>
</div>
</div>
<div class="paragraph">
<p>You will notice that the Maven project <code>pom.xml</code> does 2 interesting things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>it uses the <a href="https://maven.apache.org/plugins/maven-shade-plugin/">Maven Shade Plugin</a> to create a single Jar archive with all required dependencies, suffixed by <code>-fat.jar</code>, also called <em>"a fat Jar"</em>, and</p>
</li>
<li>
<p>it uses the <a href="http://www.mojohaus.org/exec-maven-plugin/">Exec Maven Plugin</a> to provide the <code>exec:java</code> goal that in turns starts the application through the Vert.x <code>io.vertx.core.Launcher</code> class. This is actually equivalent to running using the <code>vertx</code> command-line tool that ships in the Vert.x distribution.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Finally, you will notice the presence of the <code>redeploy.sh</code> and <code>redeploy.bat</code> scripts that you can alternatively use for automatic compilation and redeployment upon code changes.
Note that doing so requires ensuring that the <code>VERTICLE</code> variable in these scripts matches the main verticle to be used.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Alternatively, the Fabric8 project hosts <a href="https://vmp.fabric8.io/">a Vert.x Maven plugin</a>.
It has goals to initialize, build, package and run a Vert.x project.</p>
</div>
<div class="paragraph">
<p>To generate a similar project as by cloning the Git starter repository:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mkdir vertx-wiki
cd vertx-wiki
mvn io.fabric8:vertx-maven-plugin:1.0.7:setup -DvertxVersion=3.4.2
git init</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_adding_the_required_dependencies">Adding the required dependencies</h3>
<div class="paragraph">
<p>The first batch of dependencies to add to the Maven <code>pom.xml</code> file are those for the web processing and rendering:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.vertx<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>vertx-web<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.vertx<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>vertx-web-templ-freemarker<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>com.github.rjeschke<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>txtmark<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>0.13<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
As the <code>vertx-web-templ-freemarker</code> name suggests, Vert.x web provides pluggable support for popular template engines: Handlebars, Jade, MVEL, Pebble, Thymeleaf and of course Freemarker.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second set of dependencies are those required for JDBC database access:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.vertx<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>vertx-jdbc-client<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.hsqldb<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>hsqldb<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>2.3.4<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Vert.x JDBC client library provides access to any JDBC-compliant database, but of course our project needs to have a JDBC driver on the <em>classpath</em>.</p>
</div>
<div class="paragraph">
<p><a href="http://hsqldb.org/">HSQLDB</a> is well-known relational database that is written in Java.
It is quite popular when used as an embedded database to avoid the requirement of having a third-party database server running separately.
It is also popular for unit and integration testing as it offers a (volatile) in-memory storage.</p>
</div>
<div class="paragraph">
<p>HSQLDB as an embedded database is a good fit to get us started.
It stores data in local files, and since the HSQLDB library Jar provides a JDBC driver the Vert.x JDBC configuration will be straightforward.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Vert.x also offers dedicated <a href="http://vertx.io/docs/3.4.2/vertx-mysql-postgresql-client/java/">MySQL and PostgreSQL client</a> libraries.</p>
</div>
<div class="paragraph">
<p>Of course you can use the general-purpose Vert.x JDBC client to connect to MySQL or PostgreSQL databases, but these libraries offers better performance by working with these 2 database server network protocols rather than going through the (blocking) JDBC APIs.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Vert.x also provides libraries to deal with the popular non-relational databases <a href="http://vertx.io/docs/3.4.2/vertx-mongo-client/java/">MongoDB</a> and <a href="http://vertx.io/docs/3.4.2/vertx-redis-client/java/">Redis</a>.
The larger community offers integration with other storage systems like Apache Cassandra, OrientDB or ElasticSearch.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_anatomy_of_a_verticle">Anatomy of a verticle</h3>
<div class="paragraph">
<p>The verticle for our wiki consists of a single <code>io.vertx.guides.wiki.MainVerticle</code> Java class.
This class extends <code>io.vertx.core.AbstractVerticle</code>, the base class for verticles that mainly provides:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>life-cycle <code>start</code> and <code>stop</code> methods to override,</p>
</li>
<li>
<p>a <em>protected</em> field called <code>vertx</code> that references the Vert.x environment where the verticle is being deployed,</p>
</li>
<li>
<p>an accessor to some configuration object that allows passing external configuration to a verticle.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To get started our verticle can just override the <code>start</code> method as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MainVerticle</span> <span class="directive">extends</span> AbstractVerticle {

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> start(<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; startFuture) <span class="directive">throws</span> <span class="exception">Exception</span> {
    startFuture.complete();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are 2 forms of <code>start</code> (and <code>stop</code>) methods: 1 with no argument and 1 with a <em>future</em> object reference.
The no-argument variants imply that the verticle initialization or house-keeping phases always succeed unless an exception is being thrown.
The variants with a <em>future</em> object provide a more fine-grained approach to <em>eventually</em> signal that operations succeeded or not.
Indeed, some initialization or cleanup code may require asynchronous operations, so reporting via a <em>future</em> object naturally fits with asynchronous idioms.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_word_on_vert_x_future_objects_and_callbacks">A word on Vert.x future objects and callbacks</h3>
<div class="paragraph">
<p>Vert.x futures are not JDK futures: they can be composed and queried in a non-blocking fashion.
They shall be used for simple coordination of asynchronous tasks, and especially those of deploying verticles and checking if they were successfully deployed or not.</p>
</div>
<div class="paragraph">
<p>The Vert.x core APIs are based on callbacks to notify of asynchronous events.
The seasoned developer will naturally think that this opens the door to the so-called <em>"callback hell"</em> where multiple levels of nested callbacks render the code difficult to comprehend as illustrated by this fictional code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">foo.a(<span class="integer">1</span>, res1 -&gt; {
  <span class="keyword">if</span> (res1.succeeded()) {
    bar.b(<span class="string"><span class="delimiter">&quot;</span><span class="content">abc</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>, res2 -&gt; {
      <span class="keyword">if</span> (res.succeeded()) {
         baz.c(res3 -&gt; {
           dosomething(res1, res2, res3, res4 -&gt; {
               <span class="comment">// (...)</span>
           });
         });
      }
    });
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>While the core APIs could have been designed to favor promises and futures, the choice of callbacks is actually interesting since it allows different programming abstractions to be used.
Vert.x is a largely un-opinionated project, and callbacks allow the implementation of different models that better cope with asynchronous programming: reactive extensions (via RxJava), promises and futures, fibers (using bytecode instrumentation), etc.</p>
</div>
<div class="paragraph">
<p>Since all Vert.x APIs are callback-oriented before other abstractions like RxJava can be leveraged, this guide only uses callbacks in the first sections to ensure that the reader gets familiar with the core concepts in Vert.x.
It is also arguably easier to start with callbacks to draw a line between the many sections of asynchronous code.
Once it becomes evident in the sample code that callbacks do not always lead to easily readable code, we will introduce the RxJava support to show how the same asynchronous code can be better expressed by thinking in streams of processed events.</p>
</div>
</div>
<div class="sect2">
<h3 id="_wiki_verticle_initialization_phases">Wiki verticle initialization phases</h3>
<div class="paragraph">
<p>To get our wiki running, we need to perform a 2-phases initialization:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>we need to establish a JDBC database connection, and also make sure that the database schema is in place, and</p>
</li>
<li>
<p>we need to start a HTTP server for the web application.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Each phase can fail (e.g., the HTTP server TCP port is already being used), and they should not run in parallel as the web application code first needs the database access to work.</p>
</div>
<div class="paragraph">
<p>To make our code <em>cleaner</em> we will define 1 method per phase, and adopt a pattern of returning a <em>future / promise</em> object to notify when each of the phases completes, and whether it did so successfully or not:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; prepareDatabase() {
  <span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; future = <span class="predefined-type">Future</span>.future();
  <span class="comment">// (...)</span>
  <span class="keyword">return</span> future;
}

<span class="directive">private</span> <span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; startHttpServer() {
  <span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; future = <span class="predefined-type">Future</span>.future();
  <span class="comment">// (...)</span>
  <span class="keyword">return</span> future;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By having each method returning a <em>future</em> object, the implementation of the <code>start</code> method becomes a composition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> start(<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; startFuture) <span class="directive">throws</span> <span class="exception">Exception</span> {
  <span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; steps = prepareDatabase().compose(v -&gt; startHttpServer());
  steps.setHandler(startFuture.completer());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the <em>future</em> of <code>prepareDatabase</code> completes successfully, then <code>startHttpServer</code> is called and the <code>steps</code> future completes depending of the outcome of the future returned by <code>startHttpServer</code>.
<code>startHttpServer</code> is never called if <code>prepareDatabase</code> encounters an error, in which case the <code>steps</code> <em>future</em> is in a <em>failed</em> state and becomes completed with the exception describing the error.</p>
</div>
<div class="paragraph">
<p>Eventually <code>steps</code> completes: <code>setHandler</code> defines a handler to be called upon completion.
In our case we simply want to complete <code>startFuture</code> with <code>steps</code> and use the <code>completer</code> method to obtain a handler.
This is equivalent to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; steps = prepareDatabase().compose(v -&gt; startHttpServer());
steps.setHandler(ar -&gt; {  <b class="conum">(1)</b>
  <span class="keyword">if</span> (ar.succeeded()) {
    startFuture.complete();
  } <span class="keyword">else</span> {
    startFuture.fail(ar.cause());
  }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>ar</code> is of type <code>AsyncResult&lt;Void&gt;</code>.
<code>AsyncResult&lt;T&gt;</code> is used to pass the result of an asynchronous processing and may either yield a value of type <code>T</code> on success or a failure exception is the processing failed.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_database_initialization">Database initialization</h4>
<div class="paragraph">
<p>The wiki database schema consists of a single table <code>Pages</code> with the following columns:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primary key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Characters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of a wiki page, must be unique</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Content</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Markdown text of a wiki page</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The database operations will be typical <em>create, read, update, delete</em> operations.
To get us started, we simply store the corresponding SQL queries as static fields of the <code>MainVerticle</code> class.
Note that they are written in a SQL dialect that HSQLDB understands, but that other relational databases may not necessarily support:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SQL_CREATE_PAGES_TABLE = <span class="string"><span class="delimiter">&quot;</span><span class="content">create table if not exists Pages (Id integer identity primary key, Name varchar(255) unique, Content clob)</span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SQL_GET_PAGE = <span class="string"><span class="delimiter">&quot;</span><span class="content">select Id, Content from Pages where Name = ?</span><span class="delimiter">&quot;</span></span>; <b class="conum">(1)</b>
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SQL_CREATE_PAGE = <span class="string"><span class="delimiter">&quot;</span><span class="content">insert into Pages values (NULL, ?, ?)</span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SQL_SAVE_PAGE = <span class="string"><span class="delimiter">&quot;</span><span class="content">update Pages set Content = ? where Id = ?</span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SQL_ALL_PAGES = <span class="string"><span class="delimiter">&quot;</span><span class="content">select Name from Pages</span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SQL_DELETE_PAGE = <span class="string"><span class="delimiter">&quot;</span><span class="content">delete from Pages where Id = ?</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>?</code> in the queries are placeholders to pass data when executing queries, and the Vert.x JDBC client prevents from SQL injections.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The application verticle needs to keep a reference to a <code>JDBCClient</code> object (from the <code>io.vertx.ext.jdbc</code> package) that serves as the connection to the database.
We do so using a field in <code>MainVerticle</code>, and we also create a general-purpose logger from the <code>org.slf4j</code> package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> JDBCClient dbClient;

<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> LOGGER = LoggerFactory.getLogger(MainVerticle.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last but not least, here is the complete implementation of the <code>prepareDatabase</code> method.
It attempts to obtain a JDBC client connection, then performs a SQL query to create the <code>Pages</code> table unless it already exists:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; prepareDatabase() {
  <span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; future = <span class="predefined-type">Future</span>.future();

  dbClient = JDBCClient.createShared(vertx, <span class="keyword">new</span> JsonObject()  <b class="conum">(1)</b>
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:file:db/wiki</span><span class="delimiter">&quot;</span></span>)   <b class="conum">(2)</b>
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">driver_class</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.hsqldb.jdbcDriver</span><span class="delimiter">&quot;</span></span>)   <b class="conum">(3)</b>
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">max_pool_size</span><span class="delimiter">&quot;</span></span>, <span class="integer">30</span>));   <b class="conum">(4)</b>

  dbClient.getConnection(ar -&gt; {    <b class="conum">(5)</b>
    <span class="keyword">if</span> (ar.failed()) {
      LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Could not open a database connection</span><span class="delimiter">&quot;</span></span>, ar.cause());
      future.fail(ar.cause());    <b class="conum">(6)</b>
    } <span class="keyword">else</span> {
      SQLConnection connection = ar.result();   <b class="conum">(7)</b>
      connection.execute(SQL_CREATE_PAGES_TABLE, create -&gt; {
        connection.close();   <b class="conum">(8)</b>
        <span class="keyword">if</span> (create.failed()) {
          LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database preparation error</span><span class="delimiter">&quot;</span></span>, create.cause());
          future.fail(create.cause());
        } <span class="keyword">else</span> {
          future.complete();  <b class="conum">(9)</b>
        }
      });
    }
  });

  <span class="keyword">return</span> future;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>createShared</code> creates a shared connection to be shared among verticles known to the <code>vertx</code> instance, which in general is a good thing.</p>
</li>
<li>
<p>The JDBC client connection is made by passing a Vert.x JSON object. Here <code>url</code> is the JDBC URL.</p>
</li>
<li>
<p>Just like <code>url</code>, <code>driver_class</code> is specific to the JDBC driver being used and points to the driver class.</p>
</li>
<li>
<p><code>max_pool_size</code> is the number of concurrent connections. We chose 30 here, but it is just an arbitrary number.</p>
</li>
<li>
<p>Getting a connection is an asynchronous operation that gives us an <code>AsyncResult&lt;SQLConnection&gt;</code>. It must then be tested to see if the connection could be established or not (<code>AsyncResult</code> is actually a super-interface of <code>Future</code>).</p>
</li>
<li>
<p>If the SQL connection could not be obtained, then the method <em>future</em> is completed to fail with the <code>AsyncResult</code>-provided exception via the <code>cause</code> method.</p>
</li>
<li>
<p>The <code>SQLConnection</code> is the result of the successful <code>AsyncResult</code>. We can use it to perform a SQL query.</p>
</li>
<li>
<p>Before checking whether the SQL query succeeded or not, we must release it by calling <code>close</code>, otherwise the JDBC client connection pool can eventually drain.</p>
</li>
<li>
<p>We complete the method <em>future</em> object with a success.</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The SQL database modules supported by the Vert.x project do not currently offer anything beyond passing SQL queries (e.g., an object-relationnal mapper) as they focus on providing asynchronous access to databases.
However, nothing forbids using <a href="https://github.com/vert-x3/vertx-awesome">more advanced modules from the community</a>, and we especially recommend checking out projects like <a href="https://github.com/jklingsporn/vertx-jooq">this jOOq generator for Vert.x</a> or <a href="https://github.com/BraintagsGmbH/vertx-pojo-mapper">this POJO mapper</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_notes_about_logging">Notes about logging</h4>
<div class="paragraph">
<p>The previous subsection introduced a logger, and we opted for the <a href="https://www.slf4j.org/">SFL4J library</a>.
Vert.x is also unopinionated on logging: you can choose any popular Java logging library.
We recommend SLF4J since it is a popular logging abstraction and unification library in the Java ecosystem.</p>
</div>
<div class="paragraph">
<p>We also recommend using <a href="https://logback.qos.ch/">Logback</a> as a logger implementation.
Integrating both SLF4J and Logback can be done by adding two dependencies, or just <code>logback-classic</code> that points to both libraries (incidentally they are from the same author):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>ch.qos.logback<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>logback-classic<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>1.2.3<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default SLF4J outputs many log events to the console from Vert.x, Netty, C3PO and the wiki application.
We can reduce the verbosity by adding the a <code>src/main/resources/logback.xml</code> configuration file (see <a href="https://logback.qos.ch/" class="bare">https://logback.qos.ch/</a> for more details):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;configuration&gt;</span>

  <span class="tag">&lt;appender</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STDOUT</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ch.qos.logback.core.ConsoleAppender</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;encoder&gt;</span>
      <span class="tag">&lt;pattern&gt;</span>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n<span class="tag">&lt;/pattern&gt;</span>
    <span class="tag">&lt;/encoder&gt;</span>
  <span class="tag">&lt;/appender&gt;</span>

  <span class="tag">&lt;logger</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.mchange.v2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">warn</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;logger</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">io.netty</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">warn</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;logger</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">io.vertx</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">info</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;logger</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">io.vertx.guides.wiki</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">debug</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

  <span class="tag">&lt;root</span> <span class="attribute-name">level</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">debug</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;appender-ref</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STDOUT</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/root&gt;</span>

<span class="tag">&lt;/configuration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Last but not least HSQLDB does not integrate well with loggers when embedded.
By default it tries to reconfigure the logging system in place, so we need to disable it by passing a <code>-Dhsqldb.reconfig_logging=false</code> property to the Java Virtual Machine when executing applications.</p>
</div>
</div>
<div class="sect3">
<h4 id="_http_server_initialization">HTTP server initialization</h4>
<div class="paragraph">
<p>The HTTP server makes use of the <code>vertx-web</code> project to easily define <em>dispatching routes</em> for incoming HTTP requests.
Indeed, the Vert.x core API allows to start HTTP servers and listen for incoming connections, but it does not provide any facility to, say, have different handlers depending on the requested URL or processing request bodies.
This is the role of a <em>router</em> as it dispatches requests to different processing handlers depending on the URL, the HTTP method, etc.</p>
</div>
<div class="paragraph">
<p>The initialization consists in setting up a <em>request router</em>, then starting the HTTP server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; startHttpServer() {
  <span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; future = <span class="predefined-type">Future</span>.future();
  HttpServer server = vertx.createHttpServer();   <b class="conum">(1)</b>

  Router router = Router.router(vertx);   <b class="conum">(2)</b>
  router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::indexHandler);
  router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/wiki/:page</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::pageRenderingHandler); <b class="conum">(3)</b>
  router.post().handler(BodyHandler.create());  <b class="conum">(4)</b>
  router.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/save</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::pageUpdateHandler);
  router.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/create</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::pageCreateHandler);
  router.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/delete</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::pageDeletionHandler);

  server
    .requestHandler(router::accept)   <b class="conum">(5)</b>
    .listen(<span class="integer">8080</span>, ar -&gt; {   <b class="conum">(6)</b>
      <span class="keyword">if</span> (ar.succeeded()) {
        LOGGER.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">HTTP server running on port 8080</span><span class="delimiter">&quot;</span></span>);
        future.complete();
      } <span class="keyword">else</span> {
        LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Could not start a HTTP server</span><span class="delimiter">&quot;</span></span>, ar.cause());
        future.fail(ar.cause());
      }
    });

  <span class="keyword">return</span> future;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>vertx</code> context object provides methods to create HTTP servers, clients, TCP/UDP servers and clients, etc.</p>
</li>
<li>
<p>The <code>Router</code> class comes from <code>vertx-web</code>: <code>io.vertx.ext.web.Router</code>.</p>
</li>
<li>
<p>Routes have their own handlers, and they can be defined by URL and/or by HTTP method. For short handlers a Java lambda is an option, but for more elaborated handlers it is a good idea to reference private methods instead. Note that URLs can be parametric: <code>/wiki/:page</code> will match a request like <code>/wiki/Hello</code>, in which case a <code>page</code> parameter will be available with value <code>Hello</code>.</p>
</li>
<li>
<p>This makes all HTTP POST requests got through a first handler, here <code>io.vertx.ext.web.handler.BodyHandler</code>. This handler automatically decodes the body from the HTTP requests (e.g., form submissions), which can then be manipulated as Vert.x buffer objects.</p>
</li>
<li>
<p>The router object can be used as a HTTP server handler, which then dispatches to other handlers as defined above.</p>
</li>
<li>
<p>Starting a HTTP server is an asynchronous operation, so an <code>AsyncResult&lt;HttpServer&gt;</code> needs to be checked for success. By the way the <code>8080</code> parameter specifies the TCP port to be used by the server.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_http_router_handlers">HTTP router handlers</h3>
<div class="paragraph">
<p>The HTTP router instance of the <code>startHttpServer</code> method points to different handlers based on URL patterns and HTTP methods.
Each handlers deals with a HTTP request, performs a database query, and renders HTML from a FreeMarker template.</p>
</div>
<div class="sect3">
<h4 id="_index_page_handler">Index page handler</h4>
<div class="paragraph">
<p>The index page provides a list of pointers to all wiki entries and a field to create a new one:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-1/images/index.png" alt="Wiki index">
</div>
</div>
<div class="paragraph">
<p>The implementation is a straightforward <code>select *</code> SQL query where data is then passed to the FreeMarker engine to render the HTML response.</p>
</div>
<div class="paragraph">
<p>The <code>indexHandler</code> method code is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">final</span> FreeMarkerTemplateEngine templateEngine = FreeMarkerTemplateEngine.create();

<span class="directive">private</span> <span class="type">void</span> indexHandler(RoutingContext context) {
  dbClient.getConnection(car -&gt; {
    <span class="keyword">if</span> (car.succeeded()) {
      SQLConnection connection = car.result();
      connection.query(SQL_ALL_PAGES, res -&gt; {
        connection.close();

        <span class="keyword">if</span> (res.succeeded()) {
          <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; pages = res.result() <b class="conum">(1)</b>
            .getResults()
            .stream()
            .map(json -&gt; json.getString(<span class="integer">0</span>))
            .sorted()
            .collect(Collectors.toList());

          context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Wiki home</span><span class="delimiter">&quot;</span></span>);  <b class="conum">(2)</b>
          context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">pages</span><span class="delimiter">&quot;</span></span>, pages);
          templateEngine.render(context, <span class="string"><span class="delimiter">&quot;</span><span class="content">templates</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/index.ftl</span><span class="delimiter">&quot;</span></span>, ar -&gt; {   <b class="conum">(3)</b>
            <span class="keyword">if</span> (ar.succeeded()) {
              context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/html</span><span class="delimiter">&quot;</span></span>);
              context.response().end(ar.result());  <b class="conum">(4)</b>
            } <span class="keyword">else</span> {
              context.fail(ar.cause());
            }
          });

        } <span class="keyword">else</span> {
          context.fail(res.cause());  <b class="conum">(5)</b>
        }
      });
    } <span class="keyword">else</span> {
      context.fail(car.cause());
    }
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>SQL query results are being returned as instances of <code>JsonArray</code> and <code>JsonObject</code>.</p>
</li>
<li>
<p>The <code>RoutingContext</code> instance can be used to put arbitrary key / value data that is then available from templates, or chained router handlers.</p>
</li>
<li>
<p>Rendering a template is an asynchronous operation that leads us to the usual <code>AsyncResult</code> handling pattern.</p>
</li>
<li>
<p>The <code>AsyncResult</code> contains the template rendering as a <code>String</code> in case of success, and we can end the HTTP response stream with the value.</p>
</li>
<li>
<p>In case of failure the <code>fail</code> method from <code>RoutingContext</code> provides a sensible way to return a HTTP 500 error to the HTTP client.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>FreeMarker templates shall be placed in the <code>src/main/resources/templates</code> folder.
The <code>index.ftl</code> template code is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="error">&lt;</span>#include &quot;header.ftl&quot;<span class="error">&gt;</span>

<span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">row</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-12 mt-1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">float-xs-right</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;form</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-inline</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/create</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">post</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-group</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-control</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">placeholder</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">New page name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;/div&gt;</span>
        <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-primary</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Create<span class="tag">&lt;/button&gt;</span>
      <span class="tag">&lt;/form&gt;</span>
    <span class="tag">&lt;/div&gt;</span>
    <span class="tag">&lt;h1</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">display-4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${context.title}<span class="tag">&lt;/h1&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-12 mt-1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="error">&lt;</span>#list context.pages<span class="error">&gt;</span>
    <span class="tag">&lt;h2&gt;</span>Pages:<span class="tag">&lt;/h2&gt;</span>
    <span class="tag">&lt;ul&gt;</span>
      <span class="error">&lt;</span>#items as page<span class="error">&gt;</span>
        <span class="tag">&lt;li&gt;</span><span class="tag">&lt;a</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/wiki/${page}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${page}<span class="tag">&lt;/a&gt;</span><span class="tag">&lt;/li&gt;</span>
      <span class="tag">&lt;/</span>#items<span class="error">&gt;</span>
    <span class="tag">&lt;/ul&gt;</span>
  <span class="error">&lt;</span>#else<span class="error">&gt;</span>
    <span class="tag">&lt;p&gt;</span>The wiki is currently empty!<span class="tag">&lt;/p&gt;</span>
  <span class="tag">&lt;/</span>#list<span class="error">&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

<span class="tag">&lt;/div&gt;</span>

<span class="error">&lt;</span>#include &quot;footer.ftl&quot;<span class="error">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Key / value data stored in the <code>RoutingContext</code> object is made available through the <code>context</code> FreeMarker variable.</p>
</div>
<div class="paragraph">
<p>Since lots of templates have common header and footers, we extracted the following code in <code>header.ftl</code> and <code>footer.ftl</code>:</p>
</div>
<div class="listingblock">
<div class="title"><code>header.ftl</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;html</span> <span class="attribute-name">lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">en</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;head&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">viewport</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">width=device-width, initial-scale=1, shrink-to-fit=no</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attribute-name">http-equiv</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">x-ua-compatible</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ie=edge</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;link</span> <span class="attribute-name">rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;title&gt;</span>${context.title} | A Sample Vert.x-powered Wiki<span class="tag">&lt;/title&gt;</span>
<span class="tag">&lt;/head&gt;</span>
<span class="tag">&lt;body&gt;</span>

<span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">container</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title"><code>footer.ftl</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;/div&gt;</span> <span class="comment">&lt;!-- .container --&gt;</span>

<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha384-BLiI7JTZm+JWlgKa0M0kGRpJbF2J8q+qreVrKBC47e3K6BW78kGLrCkeRX6I9RoK</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>

<span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_wiki_page_rendering_handler">Wiki page rendering handler</h4>
<div class="paragraph">
<p>This handler deals with HTTP GET requests to have wiki pages being rendered, as in:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-1/images/page.png" alt="Wiki page">
</div>
</div>
<div class="paragraph">
<p>The page also provides a button to edit the content in Markdown.
Instead of having a separate handler and template, we simply rely on JavaScript and CSS to toggle the editor on and off when the button is being clicked:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-1/images/edit.png" alt="Wiki editor">
</div>
</div>
<div class="paragraph">
<p>The <code>pageRenderingHandler</code> method code is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> EMPTY_PAGE_MARKDOWN =
  <span class="string"><span class="delimiter">&quot;</span><span class="content"># A new page</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> +
    <span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> +
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Feel-free to write in Markdown!</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>;

<span class="directive">private</span> <span class="type">void</span> pageRenderingHandler(RoutingContext context) {
  <span class="predefined-type">String</span> page = context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>);   <b class="conum">(1)</b>

  dbClient.getConnection(car -&gt; {
    <span class="keyword">if</span> (car.succeeded()) {

      SQLConnection connection = car.result();
      connection.queryWithParams(SQL_GET_PAGE, <span class="keyword">new</span> JsonArray().add(page), fetch -&gt; {  <b class="conum">(2)</b>
        connection.close();
        <span class="keyword">if</span> (fetch.succeeded()) {

          JsonArray row = fetch.result().getResults()
            .stream()
            .findFirst()
            .orElseGet(() -&gt; <span class="keyword">new</span> JsonArray().add(-<span class="integer">1</span>).add(EMPTY_PAGE_MARKDOWN));
          <span class="predefined-type">Integer</span> id = row.getInteger(<span class="integer">0</span>);
          <span class="predefined-type">String</span> rawContent = row.getString(<span class="integer">1</span>);

          context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, page);
          context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, id);
          context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">newPage</span><span class="delimiter">&quot;</span></span>, fetch.result().getResults().size() == <span class="integer">0</span> ? <span class="string"><span class="delimiter">&quot;</span><span class="content">yes</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">no</span><span class="delimiter">&quot;</span></span>);
          context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawContent</span><span class="delimiter">&quot;</span></span>, rawContent);
          context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, Processor.process(rawContent));  <b class="conum">(3)</b>
          context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">timestamp</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Date</span>().toString());

          templateEngine.render(context, <span class="string"><span class="delimiter">&quot;</span><span class="content">templates</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/page.ftl</span><span class="delimiter">&quot;</span></span>, ar -&gt; {
            <span class="keyword">if</span> (ar.succeeded()) {
              context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/html</span><span class="delimiter">&quot;</span></span>);
              context.response().end(ar.result());
            } <span class="keyword">else</span> {
              context.fail(ar.cause());
            }
          });
        } <span class="keyword">else</span> {
          context.fail(fetch.cause());
        }
      });

    } <span class="keyword">else</span> {
      context.fail(car.cause());
    }
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>URL parameters (<code>/wiki/:name</code> here) can be accessed through the context request object.</p>
</li>
<li>
<p>Passing argument values to SQL queries is done using a <code>JsonArray</code>, with the elements in order of the <code>?</code> symbols in the SQL query.</p>
</li>
<li>
<p>The <code>Processor</code> class comes from the <em>txtmark</em> Markdown rendering library that we use.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>page.ftl</code> FreeMarker template code is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="error">&lt;</span>#include &quot;header.ftl&quot;<span class="error">&gt;</span>

<span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">row</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-12 mt-1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">float-xs-right</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;a</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-outline-primary</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">button</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">aria-pressed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Home<span class="tag">&lt;/a&gt;</span>
        <span class="tag">&lt;button</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-outline-warning</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">button</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">data-toggle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">collapse</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">data-target</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#editor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">aria-expanded</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">aria-controls</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">editor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Edit<span class="tag">&lt;/button&gt;</span>
      <span class="tag">&lt;/span&gt;</span>
    <span class="tag">&lt;h1</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">display-4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text-muted</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>{<span class="tag">&lt;/span&gt;</span>
    ${context.title}
      <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text-muted</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>}<span class="tag">&lt;/span&gt;</span>
    <span class="tag">&lt;/h1&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-12 mt-1 clearfix</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ${context.content}
  <span class="tag">&lt;/div&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-12 collapsable collapse clearfix</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">editor</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;form</span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/save</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">post</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-group</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hidden</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${context.id}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hidden</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${context.title}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hidden</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">newPage</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${context.newPage}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;textarea</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-control</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">rows</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">15</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${context.rawContent}<span class="tag">&lt;/textarea&gt;</span>
      <span class="tag">&lt;/div&gt;</span>
      <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-primary</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Save<span class="tag">&lt;/button&gt;</span>
    <span class="error">&lt;</span>#if context.id != -1<span class="error">&gt;</span>
      <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">formaction</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/delete</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-danger float-xs-right</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Delete<span class="tag">&lt;/button&gt;</span>
    <span class="tag">&lt;/</span>#if<span class="error">&gt;</span>
    <span class="tag">&lt;/form&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-12 mt-1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;hr</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mt-1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;p</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">small</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Rendered: ${context.timestamp}<span class="tag">&lt;/p&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

<span class="tag">&lt;/div&gt;</span>

<span class="error">&lt;</span>#include &quot;footer.ftl&quot;<span class="error">&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_page_creation_handler">Page creation handler</h4>
<div class="paragraph">
<p>The index page offers a field to create a new page, and its surrounding HTML form points to a URL that is being managed by this handler.
The strategy isn&#8217;t actually to create a new entry in the database, but simply to redirect to a wiki page URL with the name to create.
Since the wiki page doesn&#8217;t exist, the <code>pageRenderingHandler</code> method will use a default text for new pages, and a user can eventually create that page by editing then saving it.</p>
</div>
<div class="paragraph">
<p>The handler is the <code>pageCreateHandler</code> method, and its implementation is a redirection through a HTTP 303 status code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> pageCreateHandler(RoutingContext context) {
  <span class="predefined-type">String</span> pageName = context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>);
  <span class="predefined-type">String</span> location = <span class="string"><span class="delimiter">&quot;</span><span class="content">/wiki/</span><span class="delimiter">&quot;</span></span> + pageName;
  <span class="keyword">if</span> (pageName == <span class="predefined-constant">null</span> || pageName.isEmpty()) {
    location = <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>;
  }
  context.response().setStatusCode(<span class="integer">303</span>);
  context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Location</span><span class="delimiter">&quot;</span></span>, location);
  context.response().end();
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_page_saving_handler">Page saving handler</h4>
<div class="paragraph">
<p>The <code>pageUpdateHandler</code> method deals with HTTP POST requests when saving a wiki page.
This happens both when updating an existing page (issuing a SQL <code>update</code> query) or saving a new page (issuing a SQL <code>insert</code> query):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> pageUpdateHandler(RoutingContext context) {
  <span class="predefined-type">String</span> id = context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>);   <b class="conum">(1)</b>
  <span class="predefined-type">String</span> title = context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>);
  <span class="predefined-type">String</span> markdown = context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>);
  <span class="type">boolean</span> newPage = <span class="string"><span class="delimiter">&quot;</span><span class="content">yes</span><span class="delimiter">&quot;</span></span>.equals(context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">newPage</span><span class="delimiter">&quot;</span></span>));  <b class="conum">(2)</b>

  dbClient.getConnection(car -&gt; {
    <span class="keyword">if</span> (car.succeeded()) {
      SQLConnection connection = car.result();
      <span class="predefined-type">String</span> sql = newPage ? SQL_CREATE_PAGE : SQL_SAVE_PAGE;
      JsonArray params = <span class="keyword">new</span> JsonArray();   <b class="conum">(3)</b>
      <span class="keyword">if</span> (newPage) {
        params.add(title).add(markdown);
      } <span class="keyword">else</span> {
        params.add(markdown).add(id);
      }
      connection.updateWithParams(sql, params, res -&gt; {   <b class="conum">(4)</b>
        connection.close();
        <span class="keyword">if</span> (res.succeeded()) {
          context.response().setStatusCode(<span class="integer">303</span>);    <b class="conum">(5)</b>
          context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Location</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/wiki/</span><span class="delimiter">&quot;</span></span> + title);
          context.response().end();
        } <span class="keyword">else</span> {
          context.fail(res.cause());
        }
      });
    } <span class="keyword">else</span> {
      context.fail(car.cause());
    }
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Form parameters sent through a HTTP POST request are available from the <code>RoutingContext</code> object. Note that without a <code>BodyHandler</code> within the <code>Router</code> configuration chain these values would not be available, and the form submission payload would need to be manually decoded from the HTTP POST request payload.</p>
</li>
<li>
<p>We rely on a form hidden field rendered in the <code>page.ftl</code> FreeMarker template to know if we are updating an existing page or saving a new page.</p>
</li>
<li>
<p>Again, preparing the SQL query with parameters uses a <code>JsonArray</code> to pass values.</p>
</li>
<li>
<p>The <code>updateWithParams</code> method is used for <code>insert</code> / <code>update</code> / <code>delete</code> SQL queries.</p>
</li>
<li>
<p>Upon success, we simply redirect to the page that has been edited.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_page_deletion_handler">Page deletion handler</h4>
<div class="paragraph">
<p>The implementation of the <code>pageDeletionHandler</code> method is straightforward: given a wiki entry identifier, it issues a <code>delete</code> SQL query then redirects to the wiki index page:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> pageDeletionHandler(RoutingContext context) {
  <span class="predefined-type">String</span> id = context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>);
  dbClient.getConnection(car -&gt; {
    <span class="keyword">if</span> (car.succeeded()) {
      SQLConnection connection = car.result();
      connection.updateWithParams(SQL_DELETE_PAGE, <span class="keyword">new</span> JsonArray().add(id), res -&gt; {
        connection.close();
        <span class="keyword">if</span> (res.succeeded()) {
          context.response().setStatusCode(<span class="integer">303</span>);
          context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Location</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>);
          context.response().end();
        } <span class="keyword">else</span> {
          context.fail(res.cause());
        }
      });
    } <span class="keyword">else</span> {
      context.fail(car.cause());
    }
  });
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_application">Running the application</h3>
<div class="paragraph">
<p>At this stage we have a working, self-contained wiki application.</p>
</div>
<div class="paragraph">
<p>To run it we first need to build it with Maven:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ mvn clean package</pre>
</div>
</div>
<div class="paragraph">
<p>Since the build produces a Jar will all required dependencies embedded (including Vert.x and a JDBC database), running the wiki is as simple as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ java -jar target/wiki-step-1-1.0.1-fat.jar</pre>
</div>
</div>
<div class="paragraph">
<p>You can then point your favorite web browser to <a href="http://localhost:8080/" class="bare">http://localhost:8080/</a> and enjoy using the wiki.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_refactoring_into_independent_and_reusable_verticles">Refactoring into independent and reusable verticles</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The corresponding source code is in the <code>step-2</code> folder of the guide repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The first iteration got us a working wiki application.
Still, its implementation suffers from the following issues:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>HTTP requests processing and database access code are interleaved within the same methods, and</p>
</li>
<li>
<p>lots of configuration data (e.g., port numbers, JDBC driver, etc) are hard-coded strings in the code.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_architecture_and_technical_choices">Architecture and technical choices</h3>
<div class="paragraph">
<p>This second iteration is about refactoring the code into independent and reusable verticles:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-2/images/verticles-refactoring.png" alt="Verticles refactoring">
</div>
</div>
<div class="paragraph">
<p>We will deploy 2 verticles to deal with HTTP requests, and 1 verticle for encapsulating persistence through the database.
The 2 resulting verticles will not have direct references to each other as they will only agree on destination names in the event bus as well as message formats.
This provides a simple yet effective decoupling.</p>
</div>
<div class="paragraph">
<p>The messages sent on the event bus will be encoded in JSON.
While Vert.x supports flexible serialization schemes on the event bus for demanding or highly-specific contexts, it is generally a wise choice to go with JSON data.
Another advantage of using JSON is that it is a language-agnostic text format.
As Vert.x is <em>polyglot</em>, JSON is ideal shall verticles written in different languages need to communicate via message passing.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_http_server_verticle">The HTTP server verticle</h3>
<div class="paragraph">
<p>The verticle class preamble and <code>start</code> method look as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">HttpServerVerticle</span> <span class="directive">extends</span> AbstractVerticle {

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> LOGGER = LoggerFactory.getLogger(HttpServerVerticle.class);

  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CONFIG_HTTP_SERVER_PORT = <span class="string"><span class="delimiter">&quot;</span><span class="content">http.server.port</span><span class="delimiter">&quot;</span></span>;  <b class="conum">(1)</b>
  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CONFIG_WIKIDB_QUEUE = <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.queue</span><span class="delimiter">&quot;</span></span>;

  <span class="directive">private</span> <span class="predefined-type">String</span> wikiDbQueue = <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.queue</span><span class="delimiter">&quot;</span></span>;

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> start(<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; startFuture) <span class="directive">throws</span> <span class="exception">Exception</span> {

    wikiDbQueue = config().getString(CONFIG_WIKIDB_QUEUE, <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.queue</span><span class="delimiter">&quot;</span></span>);  <b class="conum">(2)</b>

    HttpServer server = vertx.createHttpServer();

    Router router = Router.router(vertx);
    router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::indexHandler);
    router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/wiki/:page</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::pageRenderingHandler);
    router.post().handler(BodyHandler.create());
    router.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/save</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::pageUpdateHandler);
    router.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/create</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::pageCreateHandler);
    router.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/delete</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::pageDeletionHandler);

    <span class="type">int</span> portNumber = config().getInteger(CONFIG_HTTP_SERVER_PORT, <span class="integer">8080</span>);  <b class="conum">(3)</b>
    server
      .requestHandler(router::accept)
      .listen(portNumber, ar -&gt; {
        <span class="keyword">if</span> (ar.succeeded()) {
          LOGGER.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">HTTP server running on port </span><span class="delimiter">&quot;</span></span> + portNumber);
          startFuture.complete();
        } <span class="keyword">else</span> {
          LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Could not start a HTTP server</span><span class="delimiter">&quot;</span></span>, ar.cause());
          startFuture.fail(ar.cause());
        }
      });
  }

  <span class="comment">// (...)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We expose public constants for the verticle configuration parameters: the HTTP port number and the name of the event bus destination to post messages to the database verticle.</p>
</li>
<li>
<p>The <code>AbstractVerticle#config()</code> method allows accessing the verticle configuration that has been provided. The second parameter is a default value in case no specific value was given.</p>
</li>
<li>
<p>Configuration values can not just be <code>String</code> objects but also integers, boolean values, complex JSON data, etc.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The rest of the class is mostly an extract of the HTTP-only code, with what was previously database code being replaced with event bus messages.
Here is the <code>indexHandler</code> method code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">final</span> FreeMarkerTemplateEngine templateEngine = FreeMarkerTemplateEngine.create();

<span class="directive">private</span> <span class="type">void</span> indexHandler(RoutingContext context) {

  DeliveryOptions options = <span class="keyword">new</span> DeliveryOptions().addHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">action</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">all-pages</span><span class="delimiter">&quot;</span></span>); <b class="conum">(2)</b>

  vertx.eventBus().send(wikiDbQueue, <span class="keyword">new</span> JsonObject(), options, reply -&gt; {  <b class="conum">(1)</b>
    <span class="keyword">if</span> (reply.succeeded()) {
      JsonObject body = (JsonObject) reply.result().body();   <b class="conum">(3)</b>
      context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Wiki home</span><span class="delimiter">&quot;</span></span>);
      context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">pages</span><span class="delimiter">&quot;</span></span>, body.getJsonArray(<span class="string"><span class="delimiter">&quot;</span><span class="content">pages</span><span class="delimiter">&quot;</span></span>).getList());
      templateEngine.render(context, <span class="string"><span class="delimiter">&quot;</span><span class="content">templates</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/index.ftl</span><span class="delimiter">&quot;</span></span>, ar -&gt; {
        <span class="keyword">if</span> (ar.succeeded()) {
          context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/html</span><span class="delimiter">&quot;</span></span>);
          context.response().end(ar.result());
        } <span class="keyword">else</span> {
          context.fail(ar.cause());
        }
      });
    } <span class="keyword">else</span> {
      context.fail(reply.cause());
    }
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>vertx</code> object gives access to the event bus, and we send a message to queue for the database vertice.</p>
</li>
<li>
<p>Delivery options allow us to specify headers, payload codecs and timeouts.</p>
</li>
<li>
<p>Upon success a reply contains a payload.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As we can see, an event bus message consists of a body, options, and it can optionally expect a reply.
In the event that no response is expected there is a variant of the <code>send</code> method does not have a handler.</p>
</div>
<div class="paragraph">
<p>We encode payloads as JSON objects, and we specify which action the database verticle should do through a message header called <code>action</code>.</p>
</div>
<div class="paragraph">
<p>The rest of the verticle code consists in the router handlers that also use the event-bus to fetch and store data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> EMPTY_PAGE_MARKDOWN =
<span class="string"><span class="delimiter">&quot;</span><span class="content"># A new page</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> +
  <span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> +
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Feel-free to write in Markdown!</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>;

<span class="directive">private</span> <span class="type">void</span> pageRenderingHandler(RoutingContext context) {

  <span class="predefined-type">String</span> requestedPage = context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>);
  JsonObject request = <span class="keyword">new</span> JsonObject().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>, requestedPage);

  DeliveryOptions options = <span class="keyword">new</span> DeliveryOptions().addHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">action</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">get-page</span><span class="delimiter">&quot;</span></span>);
  vertx.eventBus().send(wikiDbQueue, request, options, reply -&gt; {

    <span class="keyword">if</span> (reply.succeeded()) {
      JsonObject body = (JsonObject) reply.result().body();

      <span class="type">boolean</span> found = body.getBoolean(<span class="string"><span class="delimiter">&quot;</span><span class="content">found</span><span class="delimiter">&quot;</span></span>);
      <span class="predefined-type">String</span> rawContent = body.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawContent</span><span class="delimiter">&quot;</span></span>, EMPTY_PAGE_MARKDOWN);
      context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, requestedPage);
      context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, body.getInteger(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, -<span class="integer">1</span>));
      context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">newPage</span><span class="delimiter">&quot;</span></span>, found ? <span class="string"><span class="delimiter">&quot;</span><span class="content">no</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">yes</span><span class="delimiter">&quot;</span></span>);
      context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawContent</span><span class="delimiter">&quot;</span></span>, rawContent);
      context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, Processor.process(rawContent));
      context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">timestamp</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Date</span>().toString());

      templateEngine.render(context, <span class="string"><span class="delimiter">&quot;</span><span class="content">templates</span><span class="delimiter">&quot;</span></span>,<span class="string"><span class="delimiter">&quot;</span><span class="content">/page.ftl</span><span class="delimiter">&quot;</span></span>, ar -&gt; {
        <span class="keyword">if</span> (ar.succeeded()) {
          context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/html</span><span class="delimiter">&quot;</span></span>);
          context.response().end(ar.result());
        } <span class="keyword">else</span> {
          context.fail(ar.cause());
        }
      });

    } <span class="keyword">else</span> {
      context.fail(reply.cause());
    }
  });
}

<span class="directive">private</span> <span class="type">void</span> pageUpdateHandler(RoutingContext context) {

  <span class="predefined-type">String</span> title = context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>);
  JsonObject request = <span class="keyword">new</span> JsonObject()
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>))
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, title)
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>, context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>));

  DeliveryOptions options = <span class="keyword">new</span> DeliveryOptions();
  <span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">yes</span><span class="delimiter">&quot;</span></span>.equals(context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">newPage</span><span class="delimiter">&quot;</span></span>))) {
    options.addHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">action</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">create-page</span><span class="delimiter">&quot;</span></span>);
  } <span class="keyword">else</span> {
    options.addHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">action</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">save-page</span><span class="delimiter">&quot;</span></span>);
  }

  vertx.eventBus().send(wikiDbQueue, request, options, reply -&gt; {
    <span class="keyword">if</span> (reply.succeeded()) {
      context.response().setStatusCode(<span class="integer">303</span>);
      context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Location</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/wiki/</span><span class="delimiter">&quot;</span></span> + title);
      context.response().end();
    } <span class="keyword">else</span> {
      context.fail(reply.cause());
    }
  });
}

<span class="directive">private</span> <span class="type">void</span> pageCreateHandler(RoutingContext context) {
  <span class="predefined-type">String</span> pageName = context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>);
  <span class="predefined-type">String</span> location = <span class="string"><span class="delimiter">&quot;</span><span class="content">/wiki/</span><span class="delimiter">&quot;</span></span> + pageName;
  <span class="keyword">if</span> (pageName == <span class="predefined-constant">null</span> || pageName.isEmpty()) {
    location = <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>;
  }
  context.response().setStatusCode(<span class="integer">303</span>);
  context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Location</span><span class="delimiter">&quot;</span></span>, location);
  context.response().end();
}

<span class="directive">private</span> <span class="type">void</span> pageDeletionHandler(RoutingContext context) {
  <span class="predefined-type">String</span> id = context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>);
  JsonObject request = <span class="keyword">new</span> JsonObject().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, id);
  DeliveryOptions options = <span class="keyword">new</span> DeliveryOptions().addHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">action</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">delete-page</span><span class="delimiter">&quot;</span></span>);
  vertx.eventBus().send(wikiDbQueue, request, options, reply -&gt; {
    <span class="keyword">if</span> (reply.succeeded()) {
      context.response().setStatusCode(<span class="integer">303</span>);
      context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Location</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>);
      context.response().end();
    } <span class="keyword">else</span> {
      context.fail(reply.cause());
    }
  });
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_database_verticle">The database verticle</h3>
<div class="paragraph">
<p>Connecting to a database using JDBC requires of course a driver and configuration, which we had hard-coded in the first iteration.
While this verticle will turn them to configuration parameters, we will also go a step further by loading the SQL queries from a properties file.
The queries will be loaded from a file passed as a configuration parameter or from a default resource if none is being provided.
The advantage of this approach is that the verticle can adapt both to different JDBC drivers <em>and</em> SQL dialects.</p>
</div>
<div class="paragraph">
<p>The verticle class preamble consists mainly of configuration key definitions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WikiDatabaseVerticle</span> <span class="directive">extends</span> AbstractVerticle {

  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CONFIG_WIKIDB_JDBC_URL = <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.jdbc.url</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CONFIG_WIKIDB_JDBC_DRIVER_CLASS = <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.jdbc.driver_class</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CONFIG_WIKIDB_JDBC_MAX_POOL_SIZE = <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.jdbc.max_pool_size</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CONFIG_WIKIDB_SQL_QUERIES_RESOURCE_FILE = <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.sqlqueries.resource.file</span><span class="delimiter">&quot;</span></span>;

  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CONFIG_WIKIDB_QUEUE = <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.queue</span><span class="delimiter">&quot;</span></span>;

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> LOGGER = LoggerFactory.getLogger(WikiDatabaseVerticle.class);

  <span class="comment">// (...)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>SQL queries are being stored in a properties file, with the default ones for HSQLDB being located in <code>src/main/resources/db-queries.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>create-pages-table=create table if not exists Pages (Id integer identity primary key, Name varchar(255) unique, Content clob)
get-page=select Id, Content from Pages where Name = ?
create-page=insert into Pages values (NULL, ?, ?)
save-page=update Pages set Content = ? where Id = ?
all-pages=select Name from Pages
delete-page=delete from Pages where Id = ?</pre>
</div>
</div>
<div class="paragraph">
<p>The following code from the <code>WikiDatabaseVerticle</code> class loads the SQL queries from a file, and make them available from a map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">enum</span> SqlQuery {
  CREATE_PAGES_TABLE,
  ALL_PAGES,
  GET_PAGE,
  CREATE_PAGE,
  SAVE_PAGE,
  DELETE_PAGE
}

<span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">HashMap</span>&lt;SqlQuery, <span class="predefined-type">String</span>&gt; sqlQueries = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();

<span class="directive">private</span> <span class="type">void</span> loadSqlQueries() <span class="directive">throws</span> <span class="exception">IOException</span> {

  <span class="predefined-type">String</span> queriesFile = config().getString(CONFIG_WIKIDB_SQL_QUERIES_RESOURCE_FILE);
  <span class="predefined-type">InputStream</span> queriesInputStream;
  <span class="keyword">if</span> (queriesFile != <span class="predefined-constant">null</span>) {
    queriesInputStream = <span class="keyword">new</span> <span class="predefined-type">FileInputStream</span>(queriesFile);
  } <span class="keyword">else</span> {
    queriesInputStream = getClass().getResourceAsStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">/db-queries.properties</span><span class="delimiter">&quot;</span></span>);
  }

  <span class="predefined-type">Properties</span> queriesProps = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
  queriesProps.load(queriesInputStream);
  queriesInputStream.close();

  sqlQueries.put(SqlQuery.CREATE_PAGES_TABLE, queriesProps.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">create-pages-table</span><span class="delimiter">&quot;</span></span>));
  sqlQueries.put(SqlQuery.ALL_PAGES, queriesProps.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">all-pages</span><span class="delimiter">&quot;</span></span>));
  sqlQueries.put(SqlQuery.GET_PAGE, queriesProps.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">get-page</span><span class="delimiter">&quot;</span></span>));
  sqlQueries.put(SqlQuery.CREATE_PAGE, queriesProps.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">create-page</span><span class="delimiter">&quot;</span></span>));
  sqlQueries.put(SqlQuery.SAVE_PAGE, queriesProps.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">save-page</span><span class="delimiter">&quot;</span></span>));
  sqlQueries.put(SqlQuery.DELETE_PAGE, queriesProps.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">delete-page</span><span class="delimiter">&quot;</span></span>));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use the <code>SqlQuery</code> enumeration type to avoid string constants later in the code.
The code of the verticle <code>start</code> method is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> JDBCClient dbClient;

<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> start(<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; startFuture) <span class="directive">throws</span> <span class="exception">Exception</span> {

  <span class="comment">/*
   * Note: this uses blocking APIs, but data is small...
   */</span>
  loadSqlQueries();  <b class="conum">(1)</b>

  dbClient = JDBCClient.createShared(vertx, <span class="keyword">new</span> JsonObject()
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span>, config().getString(CONFIG_WIKIDB_JDBC_URL, <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:file:db/wiki</span><span class="delimiter">&quot;</span></span>))
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">driver_class</span><span class="delimiter">&quot;</span></span>, config().getString(CONFIG_WIKIDB_JDBC_DRIVER_CLASS, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.hsqldb.jdbcDriver</span><span class="delimiter">&quot;</span></span>))
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">max_pool_size</span><span class="delimiter">&quot;</span></span>, config().getInteger(CONFIG_WIKIDB_JDBC_MAX_POOL_SIZE, <span class="integer">30</span>)));

  dbClient.getConnection(ar -&gt; {
    <span class="keyword">if</span> (ar.failed()) {
      LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Could not open a database connection</span><span class="delimiter">&quot;</span></span>, ar.cause());
      startFuture.fail(ar.cause());
    } <span class="keyword">else</span> {
      SQLConnection connection = ar.result();
      connection.execute(sqlQueries.get(SqlQuery.CREATE_PAGES_TABLE), create -&gt; {   <b class="conum">(2)</b>
        connection.close();
        <span class="keyword">if</span> (create.failed()) {
          LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database preparation error</span><span class="delimiter">&quot;</span></span>, create.cause());
          startFuture.fail(create.cause());
        } <span class="keyword">else</span> {
          vertx.eventBus().consumer(config().getString(CONFIG_WIKIDB_QUEUE, <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.queue</span><span class="delimiter">&quot;</span></span>), <span class="local-variable">this</span>::onMessage);  <b class="conum">(3)</b>
          startFuture.complete();
        }
      });
    }
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Interestingly we break an important principle in Vert.x which is to avoid blocking APIs, but since there are no asynchronous APIs for accessing resources on the classpath our options are limited. We could use the Vert.x <code>executeBlocking</code> method to offload the blocking I/O operations from the event loop to a worker thread, but since the data is very small there is no obvious benefit in doing so.</p>
</li>
<li>
<p>Here is an example of using SQL queries.</p>
</li>
<li>
<p>The <code>consumer</code> method registers an event bus destination handler.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The event bus message handler is the <code>onMessage</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">enum</span> ErrorCodes {
  NO_ACTION_SPECIFIED,
  BAD_ACTION,
  DB_ERROR
}

<span class="directive">public</span> <span class="type">void</span> onMessage(Message&lt;JsonObject&gt; message) {

  <span class="keyword">if</span> (!message.headers().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">action</span><span class="delimiter">&quot;</span></span>)) {
    LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">No action header specified for message with headers {} and body {}</span><span class="delimiter">&quot;</span></span>,
      message.headers(), message.body().encodePrettily());
    message.fail(ErrorCodes.NO_ACTION_SPECIFIED.ordinal(), <span class="string"><span class="delimiter">&quot;</span><span class="content">No action header specified</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">return</span>;
  }
  <span class="predefined-type">String</span> action = message.headers().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">action</span><span class="delimiter">&quot;</span></span>);

  <span class="keyword">switch</span> (action) {
    <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">all-pages</span><span class="delimiter">&quot;</span></span>:
      fetchAllPages(message);
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">get-page</span><span class="delimiter">&quot;</span></span>:
      fetchPage(message);
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">create-page</span><span class="delimiter">&quot;</span></span>:
      createPage(message);
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">save-page</span><span class="delimiter">&quot;</span></span>:
      savePage(message);
      <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">delete-page</span><span class="delimiter">&quot;</span></span>:
      deletePage(message);
      <span class="keyword">break</span>;
    <span class="keyword">default</span>:
      message.fail(ErrorCodes.BAD_ACTION.ordinal(), <span class="string"><span class="delimiter">&quot;</span><span class="content">Bad action: </span><span class="delimiter">&quot;</span></span> + action);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We defined a <code>ErrorCodes</code> enumeration for errors, which we use to report back to the message sender.
To do so, the <code>fail</code> method of the <code>Message</code> class provides a convenient shortcut to reply with an error, and the original message sender gets a failed <code>AsyncResult</code>.</p>
</div>
<div class="paragraph">
<p>The rest of the class consists of private methods called when <code>onMessage</code> dispatches incoming messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> fetchAllPages(Message&lt;JsonObject&gt; message) {

  dbClient.getConnection(car -&gt; {
    <span class="keyword">if</span> (car.succeeded()) {
      SQLConnection connection = car.result();
      connection.query(sqlQueries.get(SqlQuery.ALL_PAGES), res -&gt; {
        connection.close();
        <span class="keyword">if</span> (res.succeeded()) {
          <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; pages = res.result()
            .getResults()
            .stream()
            .map(json -&gt; json.getString(<span class="integer">0</span>))
            .sorted()
            .collect(Collectors.toList());
          message.reply(<span class="keyword">new</span> JsonObject().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">pages</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> JsonArray(pages)));
        } <span class="keyword">else</span> {
          reportQueryError(message, res.cause());
        }
      });
    } <span class="keyword">else</span> {
      reportQueryError(message, car.cause());
    }
  });
}

<span class="directive">private</span> <span class="type">void</span> fetchPage(Message&lt;JsonObject&gt; message) {

  <span class="predefined-type">String</span> requestedPage = message.body().getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>);

  dbClient.getConnection(car -&gt; {
    <span class="keyword">if</span> (car.succeeded()) {
      SQLConnection connection = car.result();
      connection.queryWithParams(sqlQueries.get(SqlQuery.GET_PAGE), <span class="keyword">new</span> JsonArray().add(requestedPage), fetch -&gt; {
        connection.close();
        <span class="keyword">if</span> (fetch.succeeded()) {
          JsonObject response = <span class="keyword">new</span> JsonObject();
          <span class="predefined-type">ResultSet</span> resultSet = fetch.result();
          <span class="keyword">if</span> (resultSet.getNumRows() == <span class="integer">0</span>) {
            response.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">found</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>);
          } <span class="keyword">else</span> {
            response.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">found</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);
            JsonArray row = resultSet.getResults().get(<span class="integer">0</span>);
            response.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, row.getInteger(<span class="integer">0</span>));
            response.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawContent</span><span class="delimiter">&quot;</span></span>, row.getString(<span class="integer">1</span>));
          }
          message.reply(response);
        } <span class="keyword">else</span> {
          reportQueryError(message, fetch.cause());
        }
      });
    } <span class="keyword">else</span> {
      reportQueryError(message, car.cause());
    }
  });

}

<span class="directive">private</span> <span class="type">void</span> createPage(Message&lt;JsonObject&gt; message) {
  JsonObject request = message.body();

  dbClient.getConnection(car -&gt; {

    <span class="keyword">if</span> (car.succeeded()) {
      SQLConnection connection = car.result();
      JsonArray data = <span class="keyword">new</span> JsonArray()
        .add(request.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>))
        .add(request.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>));

      connection.updateWithParams(sqlQueries.get(SqlQuery.CREATE_PAGE), data, res -&gt; {
        connection.close();
        <span class="keyword">if</span> (res.succeeded()) {
          message.reply(<span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>);
        } <span class="keyword">else</span> {
          reportQueryError(message, res.cause());
        }
      });
    } <span class="keyword">else</span> {
      reportQueryError(message, car.cause());
    }
  });
}

<span class="directive">private</span> <span class="type">void</span> savePage(Message&lt;JsonObject&gt; message) {
  JsonObject request = message.body();

  dbClient.getConnection(car -&gt; {

    <span class="keyword">if</span> (car.succeeded()) {
      SQLConnection connection = car.result();
      JsonArray data = <span class="keyword">new</span> JsonArray()
        .add(request.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>))
        .add(request.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>));

      connection.updateWithParams(sqlQueries.get(SqlQuery.SAVE_PAGE), data, res -&gt; {
        connection.close();
        <span class="keyword">if</span> (res.succeeded()) {
          message.reply(<span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>);
        } <span class="keyword">else</span> {
          reportQueryError(message, res.cause());
        }
      });
    } <span class="keyword">else</span> {
      reportQueryError(message, car.cause());
    }
  });
}

<span class="directive">private</span> <span class="type">void</span> deletePage(Message&lt;JsonObject&gt; message) {
  dbClient.getConnection(car -&gt; {
    <span class="keyword">if</span> (car.succeeded()) {
      SQLConnection connection = car.result();
      JsonArray data = <span class="keyword">new</span> JsonArray().add(message.body().getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>));
      connection.updateWithParams(sqlQueries.get(SqlQuery.DELETE_PAGE), data, res -&gt; {
        connection.close();
        <span class="keyword">if</span> (res.succeeded()) {
          message.reply(<span class="string"><span class="delimiter">&quot;</span><span class="content">ok</span><span class="delimiter">&quot;</span></span>);
        } <span class="keyword">else</span> {
          reportQueryError(message, res.cause());
        }
      });
    } <span class="keyword">else</span> {
      reportQueryError(message, car.cause());
    }
  });
}

<span class="directive">private</span> <span class="type">void</span> reportQueryError(Message&lt;JsonObject&gt; message, <span class="predefined-type">Throwable</span> cause) {
  LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database query error</span><span class="delimiter">&quot;</span></span>, cause);
  message.fail(ErrorCodes.DB_ERROR.ordinal(), cause.getMessage());
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploying_the_verticles_from_a_main_verticle">Deploying the verticles from a main verticle</h3>
<div class="paragraph">
<p>We still have a <code>MainVerticle</code> class, but instead of containing all the business logic like in the initial iteration, its sole purpose is to bootstrap the application and deploy other verticles.</p>
</div>
<div class="paragraph">
<p>The code consists in deploying 1 instance of <code>WikiDatabaseVerticle</code> and 2 instances of <code>HttpServerVerticle</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MainVerticle</span> <span class="directive">extends</span> AbstractVerticle {

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> start(<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; startFuture) <span class="directive">throws</span> <span class="exception">Exception</span> {

    <span class="predefined-type">Future</span>&lt;<span class="predefined-type">String</span>&gt; dbVerticleDeployment = <span class="predefined-type">Future</span>.future();  <b class="conum">(1)</b>
    vertx.deployVerticle(<span class="keyword">new</span> WikiDatabaseVerticle(), dbVerticleDeployment.completer());  <b class="conum">(2)</b>

    dbVerticleDeployment.compose(id -&gt; {  <b class="conum">(3)</b>

      <span class="predefined-type">Future</span>&lt;<span class="predefined-type">String</span>&gt; httpVerticleDeployment = <span class="predefined-type">Future</span>.future();
      vertx.deployVerticle(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">io.vertx.guides.wiki.HttpServerVerticle</span><span class="delimiter">&quot;</span></span>,  <b class="conum">(4)</b>
        <span class="keyword">new</span> DeploymentOptions().setInstances(<span class="integer">2</span>),    <b class="conum">(5)</b>
        httpVerticleDeployment.completer());

      <span class="keyword">return</span> httpVerticleDeployment;  <b class="conum">(6)</b>

    }).setHandler(ar -&gt; {   <b class="conum">(7)</b>
      <span class="keyword">if</span> (ar.succeeded()) {
        startFuture.complete();
      } <span class="keyword">else</span> {
        startFuture.fail(ar.cause());
      }
    });
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Deploying a verticle is an asynchronous operation, so we need a <code>Future</code> for that. The <code>String</code> parametric type is because a verticle gets an identifier when successfully deployed.</p>
</li>
<li>
<p>One option is to create a verticle instance with <code>new</code>, and pass the object reference to the <code>deploy</code> method. The <code>completer</code> return value is a handler that simply completes its future.</p>
</li>
<li>
<p>Sequential composition with <code>compose</code> allows to run one asynchronous operation after the other. When the initial future completes successfully, the composition function is invoked.</p>
</li>
<li>
<p>A class name as a string is also an option to specify a verticle to deploy. For other JVM languages string-based conventions allow a module / script to be specified.</p>
</li>
<li>
<p>The <code>DeploymentOption</code> class allows to specify a number of parameters and especially the number of instances to deploy.</p>
</li>
<li>
<p>The composition function returns the next future. Its completion will trigger the completion of the composite operation.</p>
</li>
<li>
<p>We define a handler that eventually completes the <code>MainVerticle</code> start future.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The astute reader will probably wonder how we can deploy the code for a HTTP server on the same TCP port twice and not expect any error for either of the instances, since the TCP port will already be in use.
With many web frameworks we would need to choose different TCP ports, and have a frontal HTTP proxy to perform load balancing between the ports.</p>
</div>
<div class="paragraph">
<p>There is no need to do that with Vert.x as multiple verticles can share the same TCP ports.
Incoming connections are simply distributed in a round-robin fashion from accepting threads.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_refactoring_to_vert_x_services">Refactoring to Vert.x services</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The corresponding source code is in the <code>step-3</code> folder of the guide repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous refactoring was a big step forward compared to our initial implementation, as we extracted independent and configurable verticles connected using asynchronous messages on the event bus.
We also saw that we could deploy several instances of a given verticle to better cope with load and to better leverage CPU cores.</p>
</div>
<div class="paragraph">
<p>In this section we see how to design and use Vert.x services.
The main advantage of a service is that it defines an interface for doing certain operations that a verticle exposes.
We also leverage code generation for all the event bus messaging plumbing, instead of crafting it ourselves like we did in the previous section.</p>
</div>
<div class="paragraph">
<p>We are also going to refactor the code into different Java packages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>step-3/src/main/java/
└── io
    └── vertx
        └── guides
            └── wiki
                ├── MainVerticle.java
                ├── database
                │   ├── ErrorCodes.java
                │   ├── SqlQuery.java
                │   ├── WikiDatabaseService.java
                │   ├── WikiDatabaseServiceImpl.java
                │   ├── WikiDatabaseVerticle.java
                │   └── package-info.java
                └── http
                    └── HttpServerVerticle.java</pre>
</div>
</div>
<div class="paragraph">
<p><code>io.vertx.guides.wiki</code> will now contain the main verticle, <code>io.vertx.guides.wiki.database</code> the database verticle and service, and <code>io.vertx.guides.wiki.http</code> the HTTP server verticle.</p>
</div>
<div class="sect2">
<h3 id="_maven_configuration_changes">Maven configuration changes</h3>
<div class="paragraph">
<p>First, we need to add the following 2 dependencies to our project.
Obviously we need the <code>vertx-service-proxy</code> APIs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.vertx<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>vertx-service-proxy<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We need the Vert.x code generation module as a compilation-time only dependency (hence the <code>provided</code> scope):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.vertx<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>vertx-codegen<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;scope&gt;</span>provided<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we have to tweak the <code>maven-compiler-plugin</code> configuration to use code generation, which is done via a <code>javac</code> annotation processor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>3.5.1<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;configuration&gt;</span>
    <span class="tag">&lt;source&gt;</span>1.8<span class="tag">&lt;/source&gt;</span>
    <span class="tag">&lt;target&gt;</span>1.8<span class="tag">&lt;/target&gt;</span>
    <span class="tag">&lt;useIncrementalCompilation&gt;</span>false<span class="tag">&lt;/useIncrementalCompilation&gt;</span>

    <span class="tag">&lt;annotationProcessors&gt;</span>
      <span class="tag">&lt;annotationProcessor&gt;</span>io.vertx.codegen.CodeGenProcessor<span class="tag">&lt;/annotationProcessor&gt;</span>
    <span class="tag">&lt;/annotationProcessors&gt;</span>
    <span class="tag">&lt;generatedSourcesDirectory&gt;</span>${project.basedir}/src/main/generated<span class="tag">&lt;/generatedSourcesDirectory&gt;</span>
    <span class="tag">&lt;compilerArgs&gt;</span>
      <span class="tag">&lt;arg&gt;</span>-AoutputDirectory=${project.basedir}/src/main<span class="tag">&lt;/arg&gt;</span>
    <span class="tag">&lt;/compilerArgs&gt;</span>

  <span class="tag">&lt;/configuration&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the generated code is put in <code>src/main/generated</code>, which some integrated development environments like IntelliJ IDEA will automatically pick up on the classpath.</p>
</div>
<div class="paragraph">
<p>It is also a good idea to update the <code>maven-clean-plugin</code> to remove those generated files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>maven-clean-plugin<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>3.0.0<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;configuration&gt;</span>
    <span class="tag">&lt;filesets&gt;</span>
      <span class="tag">&lt;fileset&gt;</span>
        <span class="tag">&lt;directory&gt;</span>${project.basedir}/src/main/generated<span class="tag">&lt;/directory&gt;</span>
      <span class="tag">&lt;/fileset&gt;</span>
    <span class="tag">&lt;/filesets&gt;</span>
  <span class="tag">&lt;/configuration&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The full documentation on Vert.x services is available at <a href="http://vertx.io/docs/3.4.2/vertx-service-proxy/java/" class="bare">http://vertx.io/docs/3.4.2/vertx-service-proxy/java/</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_database_service_interface">Database service interface</h3>
<div class="paragraph">
<p>Defining a service interface is as simple as defining a Java interface, except that there are certain rules to respect for code generation to work and also to ensure inter-operability with other code in Vert.x.</p>
</div>
<div class="paragraph">
<p>The beginning of the interface definition is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ProxyGen</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">WikiDatabaseService</span> {

  <span class="annotation">@Fluent</span>
  WikiDatabaseService fetchAllPages(<span class="predefined-type">Handler</span>&lt;AsyncResult&lt;JsonArray&gt;&gt; resultHandler);

  <span class="annotation">@Fluent</span>
  WikiDatabaseService fetchPage(<span class="predefined-type">String</span> name, <span class="predefined-type">Handler</span>&lt;AsyncResult&lt;JsonObject&gt;&gt; resultHandler);

  <span class="annotation">@Fluent</span>
  WikiDatabaseService createPage(<span class="predefined-type">String</span> title, <span class="predefined-type">String</span> markdown, <span class="predefined-type">Handler</span>&lt;AsyncResult&lt;<span class="predefined-type">Void</span>&gt;&gt; resultHandler);

  <span class="annotation">@Fluent</span>
  WikiDatabaseService savePage(<span class="type">int</span> id, <span class="predefined-type">String</span> markdown, <span class="predefined-type">Handler</span>&lt;AsyncResult&lt;<span class="predefined-type">Void</span>&gt;&gt; resultHandler);

  <span class="annotation">@Fluent</span>
  WikiDatabaseService deletePage(<span class="type">int</span> id, <span class="predefined-type">Handler</span>&lt;AsyncResult&lt;<span class="predefined-type">Void</span>&gt;&gt; resultHandler);

  <span class="comment">// (...)</span></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>ProxyGen</code> annotation is used to trigger the code generation of a proxy for clients of that service.</p>
</li>
<li>
<p>The <code>Fluent</code> annotation is optional, but allows <em>fluent</em> interfaces where operations can be chained by returning the service instance. This is mostly useful for the code generator when the service shall be consumed from other JVM languages.</p>
</li>
<li>
<p>Parameter types need to be strings, Java primitive types, JSON objects or arrays, any enumeration type or a <code>java.util</code> collection (<code>List</code> / <code>Set</code> / <code>Map</code>) of the previous types. The only way to support arbitrary Java classes is to have them as Vert.x data objects, annotated with <code>@DataObject</code>. The last opportunity to pass other types is service reference types.</p>
</li>
<li>
<p>Since services provide asynchronous results, the last argument of a service method needs to be a <code>Handler&lt;AsyncResult&lt;T&gt;&gt;</code> where <code>T</code> is any of the types suitable for code generation as described above.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It is a good practice that service interfaces provide static methods to create instances of both the actual service implementation and proxy for client code over the event bus.</p>
</div>
<div class="paragraph">
<p>We define <code>create</code> as simply delegating to the implementation class and its constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">static</span> WikiDatabaseService create(JDBCClient dbClient, <span class="predefined-type">HashMap</span>&lt;SqlQuery, <span class="predefined-type">String</span>&gt; sqlQueries, <span class="predefined-type">Handler</span>&lt;AsyncResult&lt;WikiDatabaseService&gt;&gt; readyHandler) {
  <span class="keyword">return</span> <span class="keyword">new</span> WikiDatabaseServiceImpl(dbClient, sqlQueries, readyHandler);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Vert.x code generator creates the proxy class and names it by suffixing with <code>VertxEBProxy</code>.
Constructors of these proxy classes need a reference to the Vert.x context as well as a destination address on the event bus:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">static</span> WikiDatabaseService createProxy(Vertx vertx, <span class="predefined-type">String</span> address) {
  <span class="keyword">return</span> <span class="keyword">new</span> WikiDatabaseServiceVertxEBProxy(vertx, address);
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>SqlQuery</code> and <code>ErrorCodes</code> enumeration types that were inner classes in the previous iteration have been extracted to package-protected types, see <code>SqlQuery.java</code> and <code>ErrorCodes.java</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_database_service_implementation">Database service implementation</h3>
<div class="paragraph">
<p>The service implementation is a straightforward port of the previous <code>WikiDatabaseVerticle</code> class code.
The essential difference is the support of the asynchronous result handler in the constructor (to report the initialization outcome) and in the service methods (to report the operation success).</p>
</div>
<div class="paragraph">
<p>The class code is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">WikiDatabaseServiceImpl</span> <span class="directive">implements</span> WikiDatabaseService {

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> LOGGER = LoggerFactory.getLogger(WikiDatabaseServiceImpl.class);

  <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">HashMap</span>&lt;SqlQuery, <span class="predefined-type">String</span>&gt; sqlQueries;
  <span class="directive">private</span> <span class="directive">final</span> JDBCClient dbClient;

  WikiDatabaseServiceImpl(JDBCClient dbClient, <span class="predefined-type">HashMap</span>&lt;SqlQuery, <span class="predefined-type">String</span>&gt; sqlQueries, <span class="predefined-type">Handler</span>&lt;AsyncResult&lt;WikiDatabaseService&gt;&gt; readyHandler) {
    <span class="local-variable">this</span>.dbClient = dbClient;
    <span class="local-variable">this</span>.sqlQueries = sqlQueries;

    dbClient.getConnection(ar -&gt; {
      <span class="keyword">if</span> (ar.failed()) {
        LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Could not open a database connection</span><span class="delimiter">&quot;</span></span>, ar.cause());
        readyHandler.handle(<span class="predefined-type">Future</span>.failedFuture(ar.cause()));
      } <span class="keyword">else</span> {
        SQLConnection connection = ar.result();
        connection.execute(sqlQueries.get(SqlQuery.CREATE_PAGES_TABLE), create -&gt; {
          connection.close();
          <span class="keyword">if</span> (create.failed()) {
            LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database preparation error</span><span class="delimiter">&quot;</span></span>, create.cause());
            readyHandler.handle(<span class="predefined-type">Future</span>.failedFuture(create.cause()));
          } <span class="keyword">else</span> {
            readyHandler.handle(<span class="predefined-type">Future</span>.succeededFuture(<span class="local-variable">this</span>));
          }
        });
      }
    });
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> WikiDatabaseService fetchAllPages(<span class="predefined-type">Handler</span>&lt;AsyncResult&lt;JsonArray&gt;&gt; resultHandler) {
    dbClient.getConnection(car -&gt; {
      <span class="keyword">if</span> (car.succeeded()) {
        SQLConnection connection = car.result();
        connection.query(sqlQueries.get(SqlQuery.ALL_PAGES), res -&gt; {
          connection.close();
          <span class="keyword">if</span> (res.succeeded()) {
            JsonArray pages = <span class="keyword">new</span> JsonArray(res.result()
              .getResults()
              .stream()
              .map(json -&gt; json.getString(<span class="integer">0</span>))
              .sorted()
              .collect(Collectors.toList()));
            resultHandler.handle(<span class="predefined-type">Future</span>.succeededFuture(pages));
          } <span class="keyword">else</span> {
            LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database query error</span><span class="delimiter">&quot;</span></span>, res.cause());
            resultHandler.handle(<span class="predefined-type">Future</span>.failedFuture(res.cause()));
          }
        });
      } <span class="keyword">else</span> {
        LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database query error</span><span class="delimiter">&quot;</span></span>, car.cause());
        resultHandler.handle(<span class="predefined-type">Future</span>.failedFuture(car.cause()));
      }
    });
    <span class="keyword">return</span> <span class="local-variable">this</span>;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> WikiDatabaseService fetchPage(<span class="predefined-type">String</span> name, <span class="predefined-type">Handler</span>&lt;AsyncResult&lt;JsonObject&gt;&gt; resultHandler) {
    dbClient.getConnection(car -&gt; {
      <span class="keyword">if</span> (car.succeeded()) {
        SQLConnection connection = car.result();
        connection.queryWithParams(sqlQueries.get(SqlQuery.GET_PAGE), <span class="keyword">new</span> JsonArray().add(name), fetch -&gt; {
          connection.close();
          <span class="keyword">if</span> (fetch.succeeded()) {
            JsonObject response = <span class="keyword">new</span> JsonObject();
            <span class="predefined-type">ResultSet</span> resultSet = fetch.result();
            <span class="keyword">if</span> (resultSet.getNumRows() == <span class="integer">0</span>) {
              response.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">found</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>);
            } <span class="keyword">else</span> {
              response.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">found</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);
              JsonArray row = resultSet.getResults().get(<span class="integer">0</span>);
              response.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, row.getInteger(<span class="integer">0</span>));
              response.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawContent</span><span class="delimiter">&quot;</span></span>, row.getString(<span class="integer">1</span>));
            }
            resultHandler.handle(<span class="predefined-type">Future</span>.succeededFuture(response));
          } <span class="keyword">else</span> {
            LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database query error</span><span class="delimiter">&quot;</span></span>, fetch.cause());
            resultHandler.handle(<span class="predefined-type">Future</span>.failedFuture(fetch.cause()));
          }
        });
      } <span class="keyword">else</span> {
        LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database query error</span><span class="delimiter">&quot;</span></span>, car.cause());
        resultHandler.handle(<span class="predefined-type">Future</span>.failedFuture(car.cause()));
      }
    });
    <span class="keyword">return</span> <span class="local-variable">this</span>;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> WikiDatabaseService createPage(<span class="predefined-type">String</span> title, <span class="predefined-type">String</span> markdown, <span class="predefined-type">Handler</span>&lt;AsyncResult&lt;<span class="predefined-type">Void</span>&gt;&gt; resultHandler) {
    dbClient.getConnection(car -&gt; {

      <span class="keyword">if</span> (car.succeeded()) {
        SQLConnection connection = car.result();
        JsonArray data = <span class="keyword">new</span> JsonArray().add(title).add(markdown);
        connection.updateWithParams(sqlQueries.get(SqlQuery.CREATE_PAGE), data, res -&gt; {
          connection.close();
          <span class="keyword">if</span> (res.succeeded()) {
            resultHandler.handle(<span class="predefined-type">Future</span>.succeededFuture());
          } <span class="keyword">else</span> {
            LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database query error</span><span class="delimiter">&quot;</span></span>, res.cause());
            resultHandler.handle(<span class="predefined-type">Future</span>.failedFuture(res.cause()));
          }
        });
      } <span class="keyword">else</span> {
        LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database query error</span><span class="delimiter">&quot;</span></span>, car.cause());
        resultHandler.handle(<span class="predefined-type">Future</span>.failedFuture(car.cause()));
      }
    });
    <span class="keyword">return</span> <span class="local-variable">this</span>;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> WikiDatabaseService savePage(<span class="type">int</span> id, <span class="predefined-type">String</span> markdown, <span class="predefined-type">Handler</span>&lt;AsyncResult&lt;<span class="predefined-type">Void</span>&gt;&gt; resultHandler) {
    dbClient.getConnection(car -&gt; {

      <span class="keyword">if</span> (car.succeeded()) {
        SQLConnection connection = car.result();
        JsonArray data = <span class="keyword">new</span> JsonArray().add(markdown).add(id);
        connection.updateWithParams(sqlQueries.get(SqlQuery.SAVE_PAGE), data, res -&gt; {
          connection.close();
          <span class="keyword">if</span> (res.succeeded()) {
            resultHandler.handle(<span class="predefined-type">Future</span>.succeededFuture());
          } <span class="keyword">else</span> {
            LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database query error</span><span class="delimiter">&quot;</span></span>, res.cause());
            resultHandler.handle(<span class="predefined-type">Future</span>.failedFuture(res.cause()));
          }
        });
      } <span class="keyword">else</span> {
        LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database query error</span><span class="delimiter">&quot;</span></span>, car.cause());
        resultHandler.handle(<span class="predefined-type">Future</span>.failedFuture(car.cause()));
      }
    });
    <span class="keyword">return</span> <span class="local-variable">this</span>;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> WikiDatabaseService deletePage(<span class="type">int</span> id, <span class="predefined-type">Handler</span>&lt;AsyncResult&lt;<span class="predefined-type">Void</span>&gt;&gt; resultHandler) {
    dbClient.getConnection(car -&gt; {
      <span class="keyword">if</span> (car.succeeded()) {
        SQLConnection connection = car.result();
        JsonArray data = <span class="keyword">new</span> JsonArray().add(id);
        connection.updateWithParams(sqlQueries.get(SqlQuery.DELETE_PAGE), data, res -&gt; {
          connection.close();
          <span class="keyword">if</span> (res.succeeded()) {
            resultHandler.handle(<span class="predefined-type">Future</span>.succeededFuture());
          } <span class="keyword">else</span> {
            LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database query error</span><span class="delimiter">&quot;</span></span>, res.cause());
            resultHandler.handle(<span class="predefined-type">Future</span>.failedFuture(res.cause()));
          }
        });
      } <span class="keyword">else</span> {
        LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database query error</span><span class="delimiter">&quot;</span></span>, car.cause());
        resultHandler.handle(<span class="predefined-type">Future</span>.failedFuture(car.cause()));
      }
    });
    <span class="keyword">return</span> <span class="local-variable">this</span>;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is one last step required before the proxy code generation works: the service package needs to have a <code>package-info.java</code> annotated to define a Vert.x module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ModuleGen</span>(groupPackage = <span class="string"><span class="delimiter">&quot;</span><span class="content">io.vertx.guides.wiki.database</span><span class="delimiter">&quot;</span></span>, name = <span class="string"><span class="delimiter">&quot;</span><span class="content">wiki-database</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">package</span> <span class="namespace">io.vertx.guides.wiki.database</span>;

<span class="keyword">import</span> <span class="include">io.vertx.codegen.annotations.ModuleGen</span>;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exposing_the_database_service_from_the_database_verticle">Exposing the database service from the database verticle</h3>
<div class="paragraph">
<p>As most of the database handling code has been moved to <code>WikiDatabaseServiceImpl</code>, the <code>WikiDatabaseVerticle</code> class now consists of 2 methods: the <code>start</code> method to register the service and a utility method to load SQL queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">WikiDatabaseVerticle</span> <span class="directive">extends</span> AbstractVerticle {

  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CONFIG_WIKIDB_JDBC_URL = <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.jdbc.url</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CONFIG_WIKIDB_JDBC_DRIVER_CLASS = <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.jdbc.driver_class</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CONFIG_WIKIDB_JDBC_MAX_POOL_SIZE = <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.jdbc.max_pool_size</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CONFIG_WIKIDB_SQL_QUERIES_RESOURCE_FILE = <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.sqlqueries.resource.file</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> CONFIG_WIKIDB_QUEUE = <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.queue</span><span class="delimiter">&quot;</span></span>;

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> start(<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; startFuture) <span class="directive">throws</span> <span class="exception">Exception</span> {

    <span class="predefined-type">HashMap</span>&lt;SqlQuery, <span class="predefined-type">String</span>&gt; sqlQueries = loadSqlQueries();

    JDBCClient dbClient = JDBCClient.createShared(vertx, <span class="keyword">new</span> JsonObject()
      .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span>, config().getString(CONFIG_WIKIDB_JDBC_URL, <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:file:db/wiki</span><span class="delimiter">&quot;</span></span>))
      .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">driver_class</span><span class="delimiter">&quot;</span></span>, config().getString(CONFIG_WIKIDB_JDBC_DRIVER_CLASS, <span class="string"><span class="delimiter">&quot;</span><span class="content">org.hsqldb.jdbcDriver</span><span class="delimiter">&quot;</span></span>))
      .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">max_pool_size</span><span class="delimiter">&quot;</span></span>, config().getInteger(CONFIG_WIKIDB_JDBC_MAX_POOL_SIZE, <span class="integer">30</span>)));

    WikiDatabaseService.create(dbClient, sqlQueries, ready -&gt; {
      <span class="keyword">if</span> (ready.succeeded()) {
        ProxyHelper.registerService(WikiDatabaseService.class, vertx, ready.result(), CONFIG_WIKIDB_QUEUE); <b class="conum">(1)</b>
        startFuture.complete();
      } <span class="keyword">else</span> {
        startFuture.fail(ready.cause());
      }
    });
  }

  <span class="comment">/*
   * Note: this uses blocking APIs, but data is small...
   */</span>
  <span class="directive">private</span> <span class="predefined-type">HashMap</span>&lt;SqlQuery, <span class="predefined-type">String</span>&gt; loadSqlQueries() <span class="directive">throws</span> <span class="exception">IOException</span> {

    <span class="predefined-type">String</span> queriesFile = config().getString(CONFIG_WIKIDB_SQL_QUERIES_RESOURCE_FILE);
    <span class="predefined-type">InputStream</span> queriesInputStream;
    <span class="keyword">if</span> (queriesFile != <span class="predefined-constant">null</span>) {
      queriesInputStream = <span class="keyword">new</span> <span class="predefined-type">FileInputStream</span>(queriesFile);
    } <span class="keyword">else</span> {
      queriesInputStream = getClass().getResourceAsStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">/db-queries.properties</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="predefined-type">Properties</span> queriesProps = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
    queriesProps.load(queriesInputStream);
    queriesInputStream.close();

    <span class="predefined-type">HashMap</span>&lt;SqlQuery, <span class="predefined-type">String</span>&gt; sqlQueries = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
    sqlQueries.put(SqlQuery.CREATE_PAGES_TABLE, queriesProps.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">create-pages-table</span><span class="delimiter">&quot;</span></span>));
    sqlQueries.put(SqlQuery.ALL_PAGES, queriesProps.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">all-pages</span><span class="delimiter">&quot;</span></span>));
    sqlQueries.put(SqlQuery.GET_PAGE, queriesProps.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">get-page</span><span class="delimiter">&quot;</span></span>));
    sqlQueries.put(SqlQuery.CREATE_PAGE, queriesProps.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">create-page</span><span class="delimiter">&quot;</span></span>));
    sqlQueries.put(SqlQuery.SAVE_PAGE, queriesProps.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">save-page</span><span class="delimiter">&quot;</span></span>));
    sqlQueries.put(SqlQuery.DELETE_PAGE, queriesProps.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">delete-page</span><span class="delimiter">&quot;</span></span>));
    <span class="keyword">return</span> sqlQueries;
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We register the service here.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Registering a service requires an interface class, a Vert.x context, an implementation and an event bus destination.</p>
</div>
<div class="paragraph">
<p>The <code>WikiDatabaseServiceVertxEBProxy</code> generated class handles receiving messages on the event bus and then dispatching them to the <code>WikiDatabaseServiceImpl</code>.
What it does is actually very close to what we did in the previous section: messages are being sent with a <code>action</code> header to specify which method to invoke, and parameters are encoded in JSON.</p>
</div>
</div>
<div class="sect2">
<h3 id="_obtaining_a_database_service_proxy">Obtaining a database service proxy</h3>
<div class="paragraph">
<p>The final step to refactoring to Vert.x services is to adapt the HTTP server verticle to obtain a proxy to the database service.</p>
</div>
<div class="paragraph">
<p>All we need to do for that is creating the proxy when the verticle starts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> WikiDatabaseService dbService;

<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> start(<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Void</span>&gt; startFuture) <span class="directive">throws</span> <span class="exception">Exception</span> {

  <span class="predefined-type">String</span> wikiDbQueue = config().getString(CONFIG_WIKIDB_QUEUE, <span class="string"><span class="delimiter">&quot;</span><span class="content">wikidb.queue</span><span class="delimiter">&quot;</span></span>);
  dbService = WikiDatabaseService.createProxy(vertx, wikiDbQueue);

  HttpServer server = vertx.createHttpServer();
  <span class="comment">// (...)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We just need to make sure to use the same event bus destination as the service that was published by  <code>WikiDatabaseVerticle</code>.</p>
</div>
<div class="paragraph">
<p>The <code>WikiDatabaseServiceVertxProxyHandler</code> generated class deals with forwarding calls as event bus messages.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
It is still perfectly possible to consume a Vert.x service directly via event bus messages since this is what generated proxys do.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_vert_x_code">Testing Vert.x code</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The corresponding source code is in the <code>step-4</code> folder of the guide repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Up to this point we have been developing the wiki implementation without testing.
This is of course not a good practice, so let us see how to write tests for Vert.x code.</p>
</div>
<div class="sect2">
<h3 id="_getting_started">Getting started</h3>
<div class="paragraph">
<p>The <code>vertx-unit</code> module provides utilities to test asynchronous operations in Vert.x.
Aside from that, you can use your testing framework of choice like JUnit.</p>
</div>
<div class="paragraph">
<p>With JUnit, the required Maven dependencies are the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>junit<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>junit<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>4.12<span class="tag">&lt;/version&gt;</span>
  <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.vertx<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>vertx-unit<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>JUnit tests need to be annotated with the <code>VertxUnitRunner</code> runner to use the <code>vertx-unit</code> features:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RunWith</span>(VertxUnitRunner.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SomeTest</span> {
  <span class="comment">// (...)</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With that runner, JUnit test and life-cycle methods accept a <code>TestContext</code> argument.
This object provides access to basic assertions, a context to store data, and several async-oriented helpers that we will see in this section.</p>
</div>
<div class="paragraph">
<p>To illustrate that, let us consider an asynchronous scenario where we want to check that a timer task has been called once, and that a periodic task has been called 3 times.
Since that code is asynchronous, the test method exits before the test completes, so making that test pass or fail also needs to be done in an asynchronous fashion:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span> <span class="comment">/*(timeout=5000)*/</span>  <b class="conum">(8)</b>
<span class="directive">public</span> <span class="type">void</span> async_behavior(TestContext context) { <b class="conum">(1)</b>
  Vertx vertx = Vertx.vertx();  <b class="conum">(2)</b>
  context.assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>);  <b class="conum">(3)</b>
  Async a1 = context.async();   <b class="conum">(4)</b>
  Async a2 = context.async(<span class="integer">3</span>);  <b class="conum">(5)</b>
  vertx.setTimer(<span class="integer">100</span>, n -&gt; a1.complete());  <b class="conum">(6)</b>
  vertx.setPeriodic(<span class="integer">100</span>, n -&gt; a2.countDown());  <b class="conum">(7)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>TestContext</code> is a parameter provided by the runner.</p>
</li>
<li>
<p>Since we are in unit tests, we need to create a Vert.x context.</p>
</li>
<li>
<p>Here is an example of a basic <code>TestContext</code> assertion.</p>
</li>
<li>
<p>We get a first <code>Async</code> object that can later be completed (or failed).</p>
</li>
<li>
<p>This <code>Async</code> object works as a countdown that completes successfully after 3 calls.</p>
</li>
<li>
<p>We complete when the timer fires.</p>
</li>
<li>
<p>Each periodic task tick triggers a countdown. The test passes when all <code>Async</code> objects have completed.</p>
</li>
<li>
<p>There is a default (long) timeout for asynchronous test cases, but it can be overridden through the JUnit <code>@Test</code> annotation.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_testing_database_operations">Testing database operations</h3>
<div class="paragraph">
<p>The database service is a good fit for writing tests.</p>
</div>
<div class="paragraph">
<p>We first need to deploy the database verticle.
We will configure the JDBC connection to be HSQLDB with an in-memory storage, and upon success we will fetch a service proxy for our test cases.</p>
</div>
<div class="paragraph">
<p>Since these operations are involving, we leverage the JUnit <em>before</em> / <em>after</em> life-cycle methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> Vertx vertx;
<span class="directive">private</span> WikiDatabaseService service;

<span class="annotation">@Before</span>
<span class="directive">public</span> <span class="type">void</span> prepare(TestContext context) <span class="directive">throws</span> <span class="exception">InterruptedException</span> {
  vertx = Vertx.vertx();

  JsonObject conf = <span class="keyword">new</span> JsonObject()  <b class="conum">(1)</b>
    .put(WikiDatabaseVerticle.CONFIG_WIKIDB_JDBC_URL, <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:mem:testdb;shutdown=true</span><span class="delimiter">&quot;</span></span>)
    .put(WikiDatabaseVerticle.CONFIG_WIKIDB_JDBC_MAX_POOL_SIZE, <span class="integer">4</span>);

  vertx.deployVerticle(<span class="keyword">new</span> WikiDatabaseVerticle(), <span class="keyword">new</span> DeploymentOptions().setConfig(conf),
    context.asyncAssertSuccess(id -&gt;  <b class="conum">(2)</b>
      service = WikiDatabaseService.createProxy(vertx, WikiDatabaseVerticle.CONFIG_WIKIDB_QUEUE)));
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We only override some of the verticle settings, the others will have default values.</p>
</li>
<li>
<p><code>asyncAssertSuccess</code> is useful to provide a handler that checks for the success of an asynchronous operation. There is a variant with no arguments, and a variant like this one where we can chain the result to another handler.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Cleaning up the Vert.x context is straightforward, and again we use <code>asyncAssertSuccess</code> to ensure that no error was encountered:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@After</span>
<span class="directive">public</span> <span class="type">void</span> finish(TestContext context) {
  vertx.close(context.asyncAssertSuccess());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service operations are essentially CRUD operations, so a JUnit test case combining all of them is a fine way to test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> crud_operations(TestContext context) {
  Async async = context.async();

  service.createPage(<span class="string"><span class="delimiter">&quot;</span><span class="content">Test</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Some content</span><span class="delimiter">&quot;</span></span>, context.asyncAssertSuccess(v1 -&gt; {

    service.fetchPage(<span class="string"><span class="delimiter">&quot;</span><span class="content">Test</span><span class="delimiter">&quot;</span></span>, context.asyncAssertSuccess(json1 -&gt; {
      context.assertTrue(json1.getBoolean(<span class="string"><span class="delimiter">&quot;</span><span class="content">found</span><span class="delimiter">&quot;</span></span>));
      context.assertTrue(json1.containsKey(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>));
      context.assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">Some content</span><span class="delimiter">&quot;</span></span>, json1.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawContent</span><span class="delimiter">&quot;</span></span>));

      service.savePage(json1.getInteger(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">Yo!</span><span class="delimiter">&quot;</span></span>, context.asyncAssertSuccess(v2 -&gt; {

        service.fetchAllPages(context.asyncAssertSuccess(array1 -&gt; {
          context.assertEquals(<span class="integer">1</span>, array1.size());

          service.fetchPage(<span class="string"><span class="delimiter">&quot;</span><span class="content">Test</span><span class="delimiter">&quot;</span></span>, context.asyncAssertSuccess(json2 -&gt; {
            context.assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">Yo!</span><span class="delimiter">&quot;</span></span>, json2.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">rawContent</span><span class="delimiter">&quot;</span></span>));

            service.deletePage(json1.getInteger(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>), v3 -&gt; {

              service.fetchAllPages(context.asyncAssertSuccess(array2 -&gt; {
                context.assertTrue(array2.isEmpty());
                async.complete();  <b class="conum">(1)</b>
              }));
            });
          }));
        }));
      }));
    }));
  }));
  async.awaitSuccess(<span class="integer">5000</span>); <b class="conum">(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This is where the sole <code>Async</code> eventually completes.</p>
</li>
<li>
<p>This is an alternative to exiting the test case method and relying on a JUnit timeout. Here the execution on the test case thread waits until either the <code>Async</code> completes or the timeout period elapses.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integrating_with_a_3rd_party_web_service">Integrating with a 3rd-party web service</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The corresponding source code is in the <code>step-5</code> folder of the guide repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Modern applications rarely live on a separated island as they need to integrate with other (distributed) application and services.
Integration is very often achieved using APIs exposed over the versatile HTTP protocol.</p>
</div>
<div class="paragraph">
<p>This section shows how to integrate with a 3rd-party web service using the HTTP client APIs of Vert.x.</p>
</div>
<div class="sect2">
<h3 id="_scenario_backing_up_to_github_gist">Scenario: backing up to GitHub Gist</h3>
<div class="paragraph">
<p>The <a href="https://gist.github.com/">GitHub Gist service</a> is popular for sharing code snippets to the world.
Other services can use it, an example being the <a href="https://medium.com">Medium publishing platform</a> where links to Gists allow code snippets to be embedded inside publications.</p>
</div>
<div class="paragraph">
<p>GitHub exposes a <a href="https://developer.github.com/v3/">detailed API</a> for fetching, creating, updating and deleting Gists.
The API uses HTTPS endpoints starting at <a href="https://api.github.com/" class="bare">https://api.github.com/</a> and JSON payloads.</p>
</div>
<div class="paragraph">
<p>While many operations require authorization from the client using OAuth authentication, <a href="https://developer.github.com/v3/gists/#create-a-gist">creating a Gist is possible while being anonymous</a>.
We are going to leverage this feature to backup our wiki pages as Gists.</p>
</div>
<div class="paragraph">
<p>A new button is going to be added on the wiki index page:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-5/images/backup-button.png" alt="backup button">
</div>
</div>
<div class="paragraph">
<p>Clicking the <em>backup</em> button will trigger the creating of a Gist:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-5/images/gist-created.png" alt="gist created">
</div>
</div>
<div class="paragraph">
<p>A backup Gist consists of 1 file per wiki page, with the content being the raw Markdown text:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-5/images/gist.png" alt="gist">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_the_database_service">Updating the database service</h3>
<div class="paragraph">
<p>Before we dive into the web client API and perform HTTP requests to another service, we need to update the database service API to fetch all the wiki pages data in one pass.
This corresponds to the following SQL query to add to <code>db-queries.properties</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>all-pages-data=select * from Pages</pre>
</div>
</div>
<div class="paragraph">
<p>A new method is added to the <code>WikiDatabaseService</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Fluent</span>
WikiDatabaseService fetchAllPagesData(<span class="predefined-type">Handler</span>&lt;AsyncResult&lt;<span class="predefined-type">List</span>&lt;JsonObject&gt;&gt;&gt; resultHandler);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation in <code>WikiDatabaseServiceImpl</code> is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> WikiDatabaseService fetchAllPagesData(<span class="predefined-type">Handler</span>&lt;AsyncResult&lt;<span class="predefined-type">List</span>&lt;JsonObject&gt;&gt;&gt; resultHandler) {
  dbClient.getConnection(car -&gt; {
    <span class="keyword">if</span> (car.succeeded()) {
      SQLConnection connection = car.result();
      connection.query(sqlQueries.get(SqlQuery.ALL_PAGES_DATA), queryResult -&gt; {
        <span class="keyword">if</span> (queryResult.succeeded()) {
          resultHandler.handle(<span class="predefined-type">Future</span>.succeededFuture(queryResult.result().getRows()));
        } <span class="keyword">else</span> {
          LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database query error</span><span class="delimiter">&quot;</span></span>, queryResult.cause());
          resultHandler.handle(<span class="predefined-type">Future</span>.failedFuture(queryResult.cause()));
        }
      });
    } <span class="keyword">else</span> {
      LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Database query error</span><span class="delimiter">&quot;</span></span>, car.cause());
      resultHandler.handle(<span class="predefined-type">Future</span>.failedFuture(car.cause()));
    }
  });
  <span class="keyword">return</span> <span class="local-variable">this</span>;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_web_client_api">The web client API</h3>
<div class="paragraph">
<p>The Vert.x core library offers a <code>createHttpClient</code> method from the <code>vertx</code> context object.
Instances of <code>io.vertx.core.http.HttpClient</code> provides low-level methods for doing all kinds of HTTP requests with a fine-grained control over the protocol and the stream of events.</p>
</div>
<div class="paragraph">
<p>The web client API provides a simpler facade, especially for simplifying the payload data (un)marshaling.
This API comes in the form of a new dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.vertx<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>vertx-web-client<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;version&gt;</span>${vertx.version}<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following is a sample usage from a unit test.
The test starts a HTTP server and then it does a HTTP GET request with the web client API to check that the request to the server succeeded:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> start_http_server(TestContext context) {
  Async async = context.async();

  vertx.createHttpServer().requestHandler(req -&gt;
    req.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>).end(<span class="string"><span class="delimiter">&quot;</span><span class="content">Ok</span><span class="delimiter">&quot;</span></span>))
  .listen(<span class="integer">8080</span>, context.asyncAssertSuccess(server -&gt; {

    WebClient webClient = WebClient.create(vertx);

      webClient.get(<span class="integer">8080</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>).send(ar -&gt; {
        <span class="keyword">if</span> (ar.succeeded()) {
          HttpResponse&lt;<span class="predefined-type">Buffer</span>&gt; response = ar.result();
          context.assertTrue(response.headers().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>));
          context.assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>, response.getHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>));
          context.assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">Ok</span><span class="delimiter">&quot;</span></span>, response.body().toString());
          webClient.close();
          async.complete();
        } <span class="keyword">else</span> {
          async.resolve(<span class="predefined-type">Future</span>.failedFuture(ar.cause()));
        }
      });
    }));
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_anonymous_gists">Creating anonymous Gists</h3>
<div class="paragraph">
<p>We first need a web client object to issue HTTP requests to the Gist API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">webClient = WebClient.create(vertx, <span class="keyword">new</span> WebClientOptions()
  .setSsl(<span class="predefined-constant">true</span>)
  .setUserAgent(<span class="string"><span class="delimiter">&quot;</span><span class="content">vert-x3</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Since requests are made using HTTPS, we need to configure the web client with SSL support.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The GitHub API requires a valid <code>User-Agent</code> header and requests a GitHub account or organization identifier.
We override the default user agent with <code>vert-x3</code> but you may opt to use your own value instead.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We then modify the web router configuration in the <code>HttpServerVerticle</code> class to add a new route for triggering backups:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/backup</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::backupHandler);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code for this handler is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> backupHandler(RoutingContext context) {
  dbService.fetchAllPagesData(reply -&gt; {
    <span class="keyword">if</span> (reply.succeeded()) {

      JsonObject filesObject = <span class="keyword">new</span> JsonObject();
      JsonObject gistPayload = <span class="keyword">new</span> JsonObject() <b class="conum">(1)</b>
        .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">files</span><span class="delimiter">&quot;</span></span>, filesObject)
        .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">description</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">A wiki backup</span><span class="delimiter">&quot;</span></span>)
        .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);

      reply
        .result()
        .forEach(page -&gt; {
          JsonObject fileObject = <span class="keyword">new</span> JsonObject(); <b class="conum">(2)</b>
          filesObject.put(page.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">NAME</span><span class="delimiter">&quot;</span></span>), fileObject);
          fileObject.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>, page.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">CONTENT</span><span class="delimiter">&quot;</span></span>));
        });

      webClient.post(<span class="integer">443</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">api.github.com</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/gists</span><span class="delimiter">&quot;</span></span>) <b class="conum">(3)</b>
        .putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Accept</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">application/vnd.github.v3+json</span><span class="delimiter">&quot;</span></span>) <b class="conum">(4)</b>
        .putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>)
        .as(BodyCodec.jsonObject()) <b class="conum">(5)</b>
        .sendJsonObject(gistPayload, ar -&gt; {  <b class="conum">(6)</b>
          <span class="keyword">if</span> (ar.succeeded()) {
            HttpResponse&lt;JsonObject&gt; response = ar.result();
            <span class="keyword">if</span> (response.statusCode() == <span class="integer">201</span>) {
              context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">backup_gist_url</span><span class="delimiter">&quot;</span></span>, response.body().getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">html_url</span><span class="delimiter">&quot;</span></span>));  <b class="conum">(7)</b>
              indexHandler(context);
            } <span class="keyword">else</span> {
              <span class="predefined-type">StringBuilder</span> message = <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>()
                .append(<span class="string"><span class="delimiter">&quot;</span><span class="content">Could not backup the wiki: </span><span class="delimiter">&quot;</span></span>)
                .append(response.statusMessage());
              JsonObject body = response.body();
              <span class="keyword">if</span> (body != <span class="predefined-constant">null</span>) {
                message.append(<span class="predefined-type">System</span>.getProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">line.separator</span><span class="delimiter">&quot;</span></span>))
                  .append(body.encodePrettily());
              }
              LOGGER.error(message.toString());
              context.fail(<span class="integer">502</span>);
            }
          } <span class="keyword">else</span> {
            <span class="predefined-type">Throwable</span> err = ar.cause();
            LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">HTTP Client error</span><span class="delimiter">&quot;</span></span>, err);
            context.fail(err);
          }
      });

    } <span class="keyword">else</span> {
      context.fail(reply.cause());
    }
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The Gist creation request payload is a JSON document as outlined in the <a href="https://developer.github.com/v3/gists/#create-a-gist">GitHub API documentation</a>.</p>
</li>
<li>
<p>Each file is an entry under the <code>files</code> object of the payload, where the title is the key and the value is the text.</p>
</li>
<li>
<p>The web client needs to issue a <code>POST</code> request on port 443 (HTTPS), and the path must be <code>/gists</code>.</p>
</li>
<li>
<p>It is mandatory to have a <code>Accept</code> header in the request with the <code>application/vnd.github.v3+json</code> MIME type, otherwise the request fails. It is also important to specify that the payload is a JSON object at the next line.</p>
</li>
<li>
<p>The <code>BodyCodec</code> class provides a helper to specify that the response will be directly converted to a Vert.x <code>JsonObject</code> instance. It is also possible to use <code>BodyCodec#json(Class&lt;T&gt;)</code> and the JSON data will be mapped to a Java object of type <code>T</code> (this uses Jackson data mapping under the hood).</p>
</li>
<li>
<p><code>sendJsonObject</code> is a helper for triggering the HTTP request with a JSON payload.</p>
</li>
<li>
<p>Upon success we can traverse the JSON data (<code>html_url</code> key) to get the user-friendly URL of the newly created Gist.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exposing_a_web_api">Exposing a web API</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The corresponding source code is in the <code>step-6</code> folder of the guide repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Exposing a web HTTP/JSON API is very straightforward using what we have already covered from the <code>vertx-web</code> module.
We are going to expose a web API with the following URL scheme:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET /api/pages</code> gives a document will all wiki page names and identifiers,</p>
</li>
<li>
<p><code>POST /api/pages</code> creates a new wiki page from a document,</p>
</li>
<li>
<p><code>PUT /api/pages/:id</code> updates a wiki page from a document,</p>
</li>
<li>
<p><code>DELETE /api/pages/:id</code> deletes a wiki page.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is a screenshot of interacting with the API using the <a href="https://httpie.org/">HTTPie command-line tool</a>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-6/images/webapi-httpie.png" alt="webapi httpie">
</div>
</div>
<div class="sect2">
<h3 id="_web_sub_routers">Web sub-routers</h3>
<div class="paragraph">
<p>We are going to add new route handlers to the <code>HttpServerVerticle</code>.
While we could just add handlers to the existing router, we can also take advantage of <em>sub-routers</em>.
They allow a router to be mounted as a sub-router of another one, which can be useful for organizing and/or re-using handlers.</p>
</div>
<div class="paragraph">
<p>Here is the code for the API router:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Router apiRouter = Router.router(vertx);
apiRouter.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/pages</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::apiRoot);
apiRouter.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/pages/:id</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::apiGetPage);
apiRouter.post().handler(BodyHandler.create());
apiRouter.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/pages</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::apiCreatePage);
apiRouter.put().handler(BodyHandler.create());
apiRouter.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">/pages/:id</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::apiUpdatePage);
apiRouter.delete(<span class="string"><span class="delimiter">&quot;</span><span class="content">/pages/:id</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::apiDeletePage);
router.mountSubRouter(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api</span><span class="delimiter">&quot;</span></span>, apiRouter); <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This is where we mount our router, so requests starting with the <code>/api</code> path will be directed to <code>apiRouter</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_handlers">Handlers</h3>
<div class="paragraph">
<p>Here is the code for the different API router handlers.</p>
</div>
<div class="sect3">
<h4 id="_root_resource">Root resource</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> apiRoot(RoutingContext context) {
  dbService.fetchAllPagesData(reply -&gt; {
    JsonObject response = <span class="keyword">new</span> JsonObject();
    <span class="keyword">if</span> (reply.succeeded()) {
      <span class="predefined-type">List</span>&lt;JsonObject&gt; pages = reply.result()
        .stream()
        .map(obj -&gt; <span class="keyword">new</span> JsonObject()
          .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, obj.getInteger(<span class="string"><span class="delimiter">&quot;</span><span class="content">ID</span><span class="delimiter">&quot;</span></span>))  <b class="conum">(1)</b>
          .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, obj.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">NAME</span><span class="delimiter">&quot;</span></span>)))
        .collect(Collectors.toList());
      response
        .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>)
        .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">pages</span><span class="delimiter">&quot;</span></span>, pages); <b class="conum">(2)</b>
      context.response().setStatusCode(<span class="integer">200</span>);
      context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);
      context.response().end(response.encode()); <b class="conum">(3)</b>
    } <span class="keyword">else</span> {
      response
        .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>)
        .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>, reply.cause().getMessage());
      context.response().setStatusCode(<span class="integer">500</span>);
      context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);
      context.response().end(response.encode());
    }
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We just remap database results in page information entry objects.</p>
</li>
<li>
<p>The resulting JSON array becomes the value for the <code>pages</code> key in the response payload.</p>
</li>
<li>
<p><code>JsonObject#encode()</code> gives a compact <code>String</code> representation of the JSON data.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_getting_a_page">Getting a page</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> apiGetPage(RoutingContext context) {
  <span class="type">int</span> id = <span class="predefined-type">Integer</span>.valueOf(context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>));
  dbService.fetchPageById(id, reply -&gt; {
    JsonObject response = <span class="keyword">new</span> JsonObject();
    <span class="keyword">if</span> (reply.succeeded()) {
      JsonObject dbObject = reply.result();
      <span class="keyword">if</span> (dbObject.getBoolean(<span class="string"><span class="delimiter">&quot;</span><span class="content">found</span><span class="delimiter">&quot;</span></span>)) {
        JsonObject payload = <span class="keyword">new</span> JsonObject()
          .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, dbObject.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>))
          .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, dbObject.getInteger(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>))
          .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>, dbObject.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>))
          .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">html</span><span class="delimiter">&quot;</span></span>, Processor.process(dbObject.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">content</span><span class="delimiter">&quot;</span></span>)));
        response
          .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>)
          .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">page</span><span class="delimiter">&quot;</span></span>, payload);
        context.response().setStatusCode(<span class="integer">200</span>);
      } <span class="keyword">else</span> {
        context.response().setStatusCode(<span class="integer">404</span>);
        response
          .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>)
          .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">There is no page with ID </span><span class="delimiter">&quot;</span></span> + id);
      }
    } <span class="keyword">else</span> {
      response
        .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>)
        .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>, reply.cause().getMessage());
      context.response().setStatusCode(<span class="integer">500</span>);
    }
    context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);
    context.response().end(response.encode());
  });
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creating_a_page">Creating a page</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> apiCreatePage(RoutingContext context) {
  JsonObject page = context.getBodyAsJson();
  <span class="keyword">if</span> (!validateJsonPageDocument(context, page, <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>)) {
    <span class="keyword">return</span>;
  }
  dbService.createPage(page.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>), page.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>), reply -&gt; {
    <span class="keyword">if</span> (reply.succeeded()) {
      context.response().setStatusCode(<span class="integer">201</span>);
      context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);
      context.response().end(<span class="keyword">new</span> JsonObject().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>).encode());
    } <span class="keyword">else</span> {
      context.response().setStatusCode(<span class="integer">500</span>);
      context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);
      context.response().end(<span class="keyword">new</span> JsonObject()
        .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>)
        .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>, reply.cause().getMessage()).encode());
    }
  });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This handler and other handlers need to deal with incoming JSON documents.
The following <code>validateJsonPageDocument</code> method is a helper for doing validation and early error reporting, so that the remainder of the processing assume the presence of certain JSON entries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">boolean</span> validateJsonPageDocument(RoutingContext context, JsonObject page, <span class="predefined-type">String</span>... expectedKeys) {
  <span class="keyword">if</span> (!<span class="predefined-type">Arrays</span>.stream(expectedKeys).allMatch(page::containsKey)) {
    LOGGER.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Bad page creation JSON payload: </span><span class="delimiter">&quot;</span></span> + page.encodePrettily() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> from </span><span class="delimiter">&quot;</span></span> + context.request().remoteAddress());
    context.response().setStatusCode(<span class="integer">400</span>);
    context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);
    context.response().end(<span class="keyword">new</span> JsonObject()
      .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>)
      .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bad request payload</span><span class="delimiter">&quot;</span></span>).encode());
    <span class="keyword">return</span> <span class="predefined-constant">false</span>;
  }
  <span class="keyword">return</span> <span class="predefined-constant">true</span>;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_updating_a_page">Updating a page</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> apiUpdatePage(RoutingContext context) {
  <span class="type">int</span> id = <span class="predefined-type">Integer</span>.valueOf(context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>));
  JsonObject page = context.getBodyAsJson();
  <span class="keyword">if</span> (!validateJsonPageDocument(context, page, <span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>)) {
    <span class="keyword">return</span>;
  }
  dbService.savePage(id, page.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>), reply -&gt; {
    handleSimpleDbReply(context, reply);
  });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>handleSimpleDbReply</code> method is a helper for finishing the request processing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> handleSimpleDbReply(RoutingContext context, AsyncResult&lt;<span class="predefined-type">Void</span>&gt; reply) {
  <span class="keyword">if</span> (reply.succeeded()) {
    context.response().setStatusCode(<span class="integer">200</span>);
    context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);
    context.response().end(<span class="keyword">new</span> JsonObject().put(<span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>).encode());
  } <span class="keyword">else</span> {
    context.response().setStatusCode(<span class="integer">500</span>);
    context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">application/json</span><span class="delimiter">&quot;</span></span>);
    context.response().end(<span class="keyword">new</span> JsonObject()
      .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>)
      .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>, reply.cause().getMessage()).encode());
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_deleting_a_page">Deleting a page</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> apiDeletePage(RoutingContext context) {
  <span class="type">int</span> id = <span class="predefined-type">Integer</span>.valueOf(context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>));
  dbService.deletePage(id, reply -&gt; {
    handleSimpleDbReply(context, reply);
  });
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_unit_testing_the_api">Unit testing the API</h3>
<div class="paragraph">
<p>We write a basic test case in the <code>io.vertx.guides.wiki.http.ApiTest</code> class.</p>
</div>
<div class="paragraph">
<p>The preamble consists in preparing the test environment.
The HTTP server verticle needs the database verticle to be running, so we need to deploy both in our test Vert.x context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RunWith</span>(VertxUnitRunner.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ApiTest</span> {

  <span class="directive">private</span> Vertx vertx;
  <span class="directive">private</span> WebClient webClient;

  <span class="annotation">@Before</span>
  <span class="directive">public</span> <span class="type">void</span> prepare(TestContext context) {
    vertx = Vertx.vertx();

    JsonObject dbConf = <span class="keyword">new</span> JsonObject()
      .put(WikiDatabaseVerticle.CONFIG_WIKIDB_JDBC_URL, <span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:hsqldb:mem:testdb;shutdown=true</span><span class="delimiter">&quot;</span></span>) <b class="conum">(1)</b>
      .put(WikiDatabaseVerticle.CONFIG_WIKIDB_JDBC_MAX_POOL_SIZE, <span class="integer">4</span>);

    vertx.deployVerticle(<span class="keyword">new</span> WikiDatabaseVerticle(),
      <span class="keyword">new</span> DeploymentOptions().setConfig(dbConf), context.asyncAssertSuccess());

    vertx.deployVerticle(<span class="keyword">new</span> HttpServerVerticle(), context.asyncAssertSuccess());

    webClient = WebClient.create(vertx, <span class="keyword">new</span> WebClientOptions()
      .setDefaultHost(<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>)
      .setDefaultPort(<span class="integer">8080</span>));
  }

  <span class="annotation">@After</span>
  <span class="directive">public</span> <span class="type">void</span> finish(TestContext context) {
    vertx.close(context.asyncAssertSuccess());
  }

  <span class="comment">// (...)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We use a different JDBC URL to use an in-memory database for the tests.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The proper test case is a simple scenario where all types of requests are being made.
It creates a page, fetches it, updates it then deletes it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> play_with_api(TestContext context) {
  Async async = context.async();

  JsonObject page = <span class="keyword">new</span> JsonObject()
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Sample</span><span class="delimiter">&quot;</span></span>)
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content"># A page</span><span class="delimiter">&quot;</span></span>);

  <span class="predefined-type">Future</span>&lt;JsonObject&gt; postRequest = <span class="predefined-type">Future</span>.future();
  webClient.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages</span><span class="delimiter">&quot;</span></span>)
    .as(BodyCodec.jsonObject())
    .sendJsonObject(page, ar -&gt; {
      <span class="keyword">if</span> (ar.succeeded()) {
        HttpResponse&lt;JsonObject&gt; postResponse = ar.result();
        postRequest.complete(postResponse.body());
      } <span class="keyword">else</span> {
        context.fail(ar.cause());
      }
    });

  <span class="predefined-type">Future</span>&lt;JsonObject&gt; getRequest = <span class="predefined-type">Future</span>.future();
  postRequest.compose(h -&gt; {
    webClient.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages</span><span class="delimiter">&quot;</span></span>)
      .as(BodyCodec.jsonObject())
      .send(ar -&gt; {
        <span class="keyword">if</span> (ar.succeeded()) {
          HttpResponse&lt;JsonObject&gt; getResponse = ar.result();
          getRequest.complete(getResponse.body());
        } <span class="keyword">else</span> {
          context.fail(ar.cause());
        }
      });
  }, getRequest);

  <span class="predefined-type">Future</span>&lt;JsonObject&gt; putRequest = <span class="predefined-type">Future</span>.future();
  getRequest.compose(response -&gt; {
    JsonArray array = response.getJsonArray(<span class="string"><span class="delimiter">&quot;</span><span class="content">pages</span><span class="delimiter">&quot;</span></span>);
    context.assertEquals(<span class="integer">1</span>, array.size());
    context.assertEquals(<span class="integer">0</span>, array.getJsonObject(<span class="integer">0</span>).getInteger(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>));
    webClient.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages/0</span><span class="delimiter">&quot;</span></span>)
      .as(BodyCodec.jsonObject())
      .sendJsonObject(<span class="keyword">new</span> JsonObject()
        .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>)
        .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Oh Yeah!</span><span class="delimiter">&quot;</span></span>), ar -&gt; {
        <span class="keyword">if</span> (ar.succeeded()) {
          HttpResponse&lt;JsonObject&gt; putResponse = ar.result();
          putRequest.complete(putResponse.body());
        } <span class="keyword">else</span> {
          context.fail(ar.cause());
        }
      });
  }, putRequest);

  <span class="predefined-type">Future</span>&lt;JsonObject&gt; deleteRequest = <span class="predefined-type">Future</span>.future();
  putRequest.compose(response -&gt; {
    context.assertTrue(response.getBoolean(<span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>));
    webClient.delete(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages/0</span><span class="delimiter">&quot;</span></span>)
      .as(BodyCodec.jsonObject())
      .send(ar -&gt; {
        <span class="keyword">if</span> (ar.succeeded()) {
          HttpResponse&lt;JsonObject&gt; delResponse = ar.result();
          deleteRequest.complete(delResponse.body());
        } <span class="keyword">else</span> {
          context.fail(ar.cause());
        }
      });
  }, deleteRequest);

  deleteRequest.compose(response -&gt; {
    context.assertTrue(response.getBoolean(<span class="string"><span class="delimiter">&quot;</span><span class="content">success</span><span class="delimiter">&quot;</span></span>));
    async.complete();
  }, <span class="predefined-type">Future</span>.failedFuture(<span class="string"><span class="delimiter">&quot;</span><span class="content">Oh?</span><span class="delimiter">&quot;</span></span>));
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The test uses <code>Future</code> objects composition rather than nested callbacks.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_securing_and_controlling_access">Securing and controlling access</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The corresponding source code is in the <code>step-7</code> folder of the guide repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Securing and controlling access is easy to do with Vert.x.
In this section, we will:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>move from HTTP to HTTPS, and</p>
</li>
<li>
<p>add user authentication with group-based privileges to the web application, and</p>
</li>
<li>
<p>control access to the web API using <a href="https://jwt.io/"><em>JSON web tokens</em> (JWT)</a>.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_https_support_in_vert_x">HTTPS support in Vert.x</h3>
<div class="paragraph">
<p>Vert.x provides support for SSL-encrypted network connections.
It is common to expose HTTP servers in production through a front HTTP server / proxy like Nginx, and have it use HTTPS for incoming connections.
Vert.x can also expose HTTPS by itself, so as to provide end-to-end encryption.</p>
</div>
<div class="paragraph">
<p>Certificates can be stored in Java <em>KeyStore</em> files.
You will likely need a <em>self-signed certificate</em> for testing purposes, and here is how to create one in a <code>server-keystore.jks</code> KeyStore where the password is <code>secret</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">keytool -genkey \
  -alias test \
  -keyalg RSA \
  -keystore server-keystore.jks \
  -keysize 2048 \
  -validity 360 \
  -dname CN=localhost \
  -keypass secret \
  -storepass secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can then change the HTTP server creation to pass a <code>HttpServerOptions</code> object to specify that we want SSL, and to point to our KeyStore file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">HttpServer server = vertx.createHttpServer(<span class="keyword">new</span> HttpServerOptions()
  .setSsl(<span class="predefined-constant">true</span>)
  .setKeyStoreOptions(<span class="keyword">new</span> JksOptions()
    .setPath(<span class="string"><span class="delimiter">&quot;</span><span class="content">server-keystore.jks</span><span class="delimiter">&quot;</span></span>)
    .setPassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can point a web browser to <a href="https://localhost:8080/" class="bare">https://localhost:8080/</a>, but since the certificate is a self-signed one any good browser will rightfully yield a security warning:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-7/images/invalid-cert.png" alt="invalid cert">
</div>
</div>
<div class="paragraph">
<p>Last but not least, we need to update the test case in <code>ApiTest</code> since the original code was made for issuing HTTP requests with the web client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">webClient = WebClient.create(vertx, <span class="keyword">new</span> WebClientOptions()
  .setDefaultHost(<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>)
  .setDefaultPort(<span class="integer">8080</span>)
  .setSsl(<span class="predefined-constant">true</span>) <b class="conum">(1)</b>
  .setTrustOptions(<span class="keyword">new</span> JksOptions().setPath(<span class="string"><span class="delimiter">&quot;</span><span class="content">server-keystore.jks</span><span class="delimiter">&quot;</span></span>).setPassword(<span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>))); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ensures SSL.</p>
</li>
<li>
<p>Since the certificate is self-signed, we need to explicitly trust it otherwise the web client connections will fail just like a web browser would.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_access_control_and_authentication">Access control and authentication</h3>
<div class="paragraph">
<p>Vert.x provides a wide range of options for doing authentication and authorization.
The officially supported modules cover JDBC, MongoDB, <a href="https://shiro.apache.org/">Apache Shiro</a>, OAuth2 with well-known providers and JWT (JSON web tokens).</p>
</div>
<div class="paragraph">
<p>While the next section will cover JWT, this one focuses on using Apache Shiro which is especially interesting when authentication must be backed by a LDAP or Active Directory server.
In our case we will simply store the credentials in a properties file to keep things simple, but the API usage against a LDAP server remains the same.</p>
</div>
<div class="paragraph">
<p>The goal is to require users to authenticate for using the wiki, and have role-based permissions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>having no role only allows reading pages,</p>
</li>
<li>
<p>having a <em>writer</em> role allows editing pages,</p>
</li>
<li>
<p>having an <em>editor</em> role allows creating, editing and deleting pages,</p>
</li>
<li>
<p>having an <em>admin</em> role is equivalent to having all possible roles.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The Vert.x Shiro integration has some issues due to the inner workings of Apache Shiro. Some parts are blocking which can hinder performance, and some data is stored using thread local state. You should not try abusing the exposed internal state APIs either.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_adding_apache_shiro_authentication_to_routes">Adding Apache Shiro authentication to routes</h4>
<div class="paragraph">
<p>The first step is to add the <code>vertx-auth-shiro</code> module to the Maven dependencies list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.vertx<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>vertx-auth-shiro<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The properties file definition that we use is the following, located in <code>src/main/resources/wiki-users.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>user.root=w00t,admin
user.foo=bar,editor,writer
user.bar=baz,writer
user.baz=baz

role.admin=*
role.editor=create,delete,update
role.writer=update</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>user</code>-prefixed entry is a user account, where the first value entry is the password possibly followed by roles.
In this example user <code>bar</code> has password <code>baz</code>, is a <code>writer</code>, and a <code>writer</code> has <code>update</code> permission.</p>
</div>
<div class="paragraph">
<p>Back to the <code>HttpServerVerticle</code> class code, we create an authentication provider using Apache Shiro:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">AuthProvider</span> auth = ShiroAuth.create(vertx, <span class="keyword">new</span> ShiroAuthOptions()
  .setType(ShiroAuthRealmType.PROPERTIES)
  .setConfig(<span class="keyword">new</span> JsonObject()
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">properties_path</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:wiki-users.properties</span><span class="delimiter">&quot;</span></span>)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ShiroAuth</code> object instance is then used to deal with server-side user sessions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Router router = Router.router(vertx);

router.route().handler(<span class="predefined-type">CookieHandler</span>.create());
router.route().handler(BodyHandler.create());
router.route().handler(SessionHandler.create(LocalSessionStore.create(vertx)));
router.route().handler(UserSessionHandler.create(auth));  <b class="conum">(1)</b>

AuthHandler authHandler = RedirectAuthHandler.create(auth, <span class="string"><span class="delimiter">&quot;</span><span class="content">/login</span><span class="delimiter">&quot;</span></span>); <b class="conum">(2)</b>
router.route(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>).handler(authHandler);  <b class="conum">(3)</b>
router.route(<span class="string"><span class="delimiter">&quot;</span><span class="content">/wiki/*</span><span class="delimiter">&quot;</span></span>).handler(authHandler);
router.route(<span class="string"><span class="delimiter">&quot;</span><span class="content">/action/*</span><span class="delimiter">&quot;</span></span>).handler(authHandler);

router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::indexHandler);
router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/wiki/:page</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::pageRenderingHandler);
router.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/action/save</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::pageUpdateHandler);
router.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/action/create</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::pageCreateHandler);
router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/action/backup</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::backupHandler);
router.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/action/delete</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::pageDeletionHandler);</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We install a user session handler for all routes.</p>
</li>
<li>
<p>This automatically redirects requests to <code>/login</code> when there is no user session for the request.</p>
</li>
<li>
<p>We install <code>authHandler</code> for all routes where authentication is required.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Finally, we need to create 3 routes for displaying a login form, handling login form submissions and logging out users:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/login</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::loginHandler);
router.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/login-auth</span><span class="delimiter">&quot;</span></span>).handler(FormLoginHandler.create(auth));  <b class="conum">(1)</b>

router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/logout</span><span class="delimiter">&quot;</span></span>).handler(context -&gt; {
  context.clearUser();  <b class="conum">(2)</b>
  context.response()
    .setStatusCode(<span class="integer">302</span>)
    .putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Location</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>)
    .end();
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>FormLoginHandler</code> is a helper for processing login submission requests. By default it expects the HTTP POST request to have: <code>username</code> as the login, <code>password</code> as the password, and <code>return_url</code> as the URL to redirect to upon success.</p>
</li>
<li>
<p>Logging out a user is a simple as clearing it from the current <code>RoutingContext</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The code for the <code>loginHandler</code> method is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> loginHandler(RoutingContext context) {
  context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Login</span><span class="delimiter">&quot;</span></span>);
  templateEngine.render(context, <span class="string"><span class="delimiter">&quot;</span><span class="content">templates/login.ftl</span><span class="delimiter">&quot;</span></span>, ar -&gt; {
    <span class="keyword">if</span> (ar.succeeded()) {
      context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/html</span><span class="delimiter">&quot;</span></span>);
      context.response().end(ar.result());
    } <span class="keyword">else</span> {
      context.fail(ar.cause());
    }
  });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The HTML template is placed in <code>src/main/resources/templates/login.ftl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="error">&lt;</span>#include &quot;header.ftl&quot;<span class="error">&gt;</span>

<span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">row</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-12 mt-1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;form</span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/login-auth</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-group</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">placeholder</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">login</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">placeholder</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hidden</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">return_url</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-primary</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Login<span class="tag">&lt;/button&gt;</span>
      <span class="tag">&lt;/div&gt;</span>
    <span class="tag">&lt;/form&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

<span class="tag">&lt;/div&gt;</span>

<span class="error">&lt;</span>#include &quot;footer.ftl&quot;<span class="error">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The login page looks as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-7/images/login-form.png" alt="login form">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_supporting_features_based_on_roles">Supporting features based on roles</h4>
<div class="paragraph">
<p>Features need to be activated only if the user has sufficient permissions.
In the following screenshot an administrator can create a page and perform a backup:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-7/images/as-root.png" alt="as root">
</div>
</div>
<div class="paragraph">
<p>By contrast a user with no role cannot perform these actions:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-7/images/as-baz.png" alt="as baz">
</div>
</div>
<div class="paragraph">
<p>To do that, we can access the <code>RoutingContext</code> user reference, and query for permissions.
Here is how this is implemented for the <code>indexHandler</code> handler method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> indexHandler(RoutingContext context) {
  context.user().isAuthorised(<span class="string"><span class="delimiter">&quot;</span><span class="content">create</span><span class="delimiter">&quot;</span></span>, res -&gt; {  <b class="conum">(1)</b>
    <span class="type">boolean</span> canCreatePage = res.succeeded() &amp;&amp; res.result();  <b class="conum">(2)</b>
    dbService.fetchAllPages(reply -&gt; {
      <span class="keyword">if</span> (reply.succeeded()) {
        context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Wiki home</span><span class="delimiter">&quot;</span></span>);
        context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">pages</span><span class="delimiter">&quot;</span></span>, reply.result().getList());
        context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">canCreatePage</span><span class="delimiter">&quot;</span></span>, canCreatePage);  <b class="conum">(3)</b>
        context.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>, context.user().principal().getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>));  <b class="conum">(4)</b>
        templateEngine.render(context, <span class="string"><span class="delimiter">&quot;</span><span class="content">templates</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/index.ftl</span><span class="delimiter">&quot;</span></span>, ar -&gt; {
          <span class="keyword">if</span> (ar.succeeded()) {
            context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/html</span><span class="delimiter">&quot;</span></span>);
            context.response().end(ar.result());
          } <span class="keyword">else</span> {
            context.fail(ar.cause());
          }
        });
      } <span class="keyword">else</span> {
        context.fail(reply.cause());
      }
    });
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This is how a permission query is made. Note that this is an asynchronous operation.</p>
</li>
<li>
<p>We use the result to&#8230;&#8203;</p>
</li>
<li>
<p>&#8230;&#8203;leverage it is the HTML template.</p>
</li>
<li>
<p>We also have access to the user login.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The template code has been modified to only render certain fragments based on the value of <code>canCreatePage</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="error">&lt;</span>#include &quot;header.ftl&quot;<span class="error">&gt;</span>

<span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">row</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-12 mt-1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="error">&lt;</span>#if context.canCreatePage<span class="error">&gt;</span>
    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">float-xs-right</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;form</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-inline</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/action/create</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">post</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-group</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-control</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">placeholder</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">New page name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;/div&gt;</span>
        <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-primary</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Create<span class="tag">&lt;/button&gt;</span>
      <span class="tag">&lt;/form&gt;</span>
    <span class="tag">&lt;/div&gt;</span>
  <span class="tag">&lt;/</span>#if<span class="error">&gt;</span>
    <span class="tag">&lt;h1</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">display-4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${context.title}<span class="tag">&lt;/h1&gt;</span>
    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">float-xs-right</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;a</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-outline-danger</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/logout</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">button</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">aria-pressed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Logout (${context.username})<span class="tag">&lt;/a&gt;</span>
    <span class="tag">&lt;/div&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-12 mt-1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="error">&lt;</span>#list context.pages<span class="error">&gt;</span>
    <span class="tag">&lt;h2&gt;</span>Pages:<span class="tag">&lt;/h2&gt;</span>
    <span class="tag">&lt;ul&gt;</span>
      <span class="error">&lt;</span>#items as page<span class="error">&gt;</span>
        <span class="tag">&lt;li&gt;</span><span class="tag">&lt;a</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/wiki/${page}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${page}<span class="tag">&lt;/a&gt;</span><span class="tag">&lt;/li&gt;</span>
      <span class="tag">&lt;/</span>#items<span class="error">&gt;</span>
    <span class="tag">&lt;/ul&gt;</span>
  <span class="error">&lt;</span>#else<span class="error">&gt;</span>
    <span class="tag">&lt;p&gt;</span>The wiki is currently empty!<span class="tag">&lt;/p&gt;</span>
  <span class="tag">&lt;/</span>#list<span class="error">&gt;</span>

  <span class="error">&lt;</span>#if context.canCreatePage<span class="error">&gt;</span>
    <span class="error">&lt;</span>#if context.backup_gist_url?has_content<span class="error">&gt;</span>
      <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">alert alert-success</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">alert</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        Successfully created a backup:
        <span class="tag">&lt;a</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${context.backup_gist_url}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">alert-link</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>${context.backup_gist_url}<span class="tag">&lt;/a&gt;</span>
      <span class="tag">&lt;/div&gt;</span>
    <span class="error">&lt;</span>#else<span class="error">&gt;</span>
      <span class="tag">&lt;p&gt;</span>
        <span class="tag">&lt;a</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-outline-secondary btn-sm</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/action/backup</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">button</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">aria-pressed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Backup<span class="tag">&lt;/a&gt;</span>
      <span class="tag">&lt;/p&gt;</span>
    <span class="tag">&lt;/</span>#if<span class="error">&gt;</span>
  <span class="tag">&lt;/</span>#if<span class="error">&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

<span class="tag">&lt;/div&gt;</span>

<span class="error">&lt;</span>#include &quot;footer.ftl&quot;<span class="error">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code is similar for ensuring that updating or deleting a page is restricted to certain roles and is available from the guide Git repository.</p>
</div>
<div class="paragraph">
<p>It is important to ensure that checks are also being done on HTTP POST request handlers and not just when rendering HTML pages.
Indeed, malicious attackers could still craft requests and perform actions while not being authenticated.
Here is how to protect page deletions by wrapping the <code>pageDeletionHandler</code> code inside a topmost permission check:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> pageDeletionHandler(RoutingContext context) {
  context.user().isAuthorised(<span class="string"><span class="delimiter">&quot;</span><span class="content">delete</span><span class="delimiter">&quot;</span></span>, res -&gt; {
    <span class="keyword">if</span> (res.succeeded() &amp;&amp; res.result()) {

      <span class="comment">// Original code:</span>
      dbService.deletePage(<span class="predefined-type">Integer</span>.valueOf(context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>)), reply -&gt; {
        <span class="keyword">if</span> (reply.succeeded()) {
          context.response().setStatusCode(<span class="integer">303</span>);
          context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Location</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>);
          context.response().end();
        } <span class="keyword">else</span> {
          context.fail(reply.cause());
        }
      });

    } <span class="keyword">else</span> {
      context.response().setStatusCode(<span class="integer">403</span>).end();
    }
  });
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_authenticating_web_api_requests_with_jwt">Authenticating web API requests with JWT</h3>
<div class="paragraph">
<p><a href="https://jwt.io/">JSON Web Tokens</a> (<a href="https://tools.ietf.org/html/rfc7519">RFC 7519</a>) is a standard for issuing JSON-encoded tokens containing <em>claims</em>, typically identifying a user and permissions, although claims can be just about anything.</p>
</div>
<div class="paragraph">
<p>A token is issued by a server and it is signed with the server key.
A client can send a token back along with subsequent requests: both the client and the server can check that a token is authentic and unaltered.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
While a JWT token is signed, its content is not encrypted. It must be transported over a secure channel (e.g., HTTPS) and it should never have sensitive data as a claim (e.g., passwords, private API keys, etc).
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_adding_jwt_support">Adding JWT support</h4>
<div class="paragraph">
<p>We start by adding the <code>vertx-auth-jwt</code> module to the Maven dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.vertx<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>vertx-auth-jwt<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will have a JCEKS keystore to hold the keys for our tests.
Here is how to generate a <code>keystore.jceks</code> with the suitable keys of various lengths:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">keytool -genseckey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg HMacSHA256 -keysize 2048 -alias HS256 -keypass secret
keytool -genseckey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg HMacSHA384 -keysize 2048 -alias HS384 -keypass secret
keytool -genseckey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg HMacSHA512 -keysize 2048 -alias HS512 -keypass secret
keytool -genkey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg RSA -keysize 2048 -alias RS256 -keypass secret -sigalg SHA256withRSA -dname &quot;CN=,OU=,O=,L=,ST=,C=&quot; -validity 360
keytool -genkey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg RSA -keysize 2048 -alias RS384 -keypass secret -sigalg SHA384withRSA -dname &quot;CN=,OU=,O=,L=,ST=,C=&quot; -validity 360
keytool -genkey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg RSA -keysize 2048 -alias RS512 -keypass secret -sigalg SHA512withRSA -dname &quot;CN=,OU=,O=,L=,ST=,C=&quot; -validity 360
keytool -genkeypair -keystore keystore.jceks -storetype jceks -storepass secret -keyalg EC -keysize 256 -alias ES256 -keypass secret -sigalg SHA256withECDSA -dname &quot;CN=,OU=,O=,L=,ST=,C=&quot; -validity 360
keytool -genkeypair -keystore keystore.jceks -storetype jceks -storepass secret -keyalg EC -keysize 256 -alias ES384 -keypass secret -sigalg SHA384withECDSA -dname &quot;CN=,OU=,O=,L=,ST=,C=&quot; -validity 360
keytool -genkeypair -keystore keystore.jceks -storetype jceks -storepass secret -keyalg EC -keysize 256 -alias ES512 -keypass secret -sigalg SHA512withECDSA -dname &quot;CN=,OU=,O=,L=,ST=,C=&quot; -validity 360</code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to install a JWT token handler on API routes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Router apiRouter = Router.router(vertx);

JWTAuth jwtAuth = JWTAuth.create(vertx, <span class="keyword">new</span> JsonObject()
  .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">keyStore</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> JsonObject()
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">path</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">keystore.jceks</span><span class="delimiter">&quot;</span></span>)
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jceks</span><span class="delimiter">&quot;</span></span>)
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>)));

apiRouter.route().handler(JWTAuthHandler.create(jwtAuth, <span class="string"><span class="delimiter">&quot;</span><span class="content">/api/token</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>We pass <code>/api/token</code> as a parameter for the <code>JWTAuthHandler</code> object creation to specify that this URL shall be ignored.
Indeed, this URL is being used to generate new JWT tokens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">apiRouter.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/token</span><span class="delimiter">&quot;</span></span>).handler(context -&gt; {

  JsonObject creds = <span class="keyword">new</span> JsonObject()
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>, context.request().getHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">login</span><span class="delimiter">&quot;</span></span>))
    .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>, context.request().getHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>));
  auth.authenticate(creds, authResult -&gt; {  <b class="conum">(1)</b>

    <span class="keyword">if</span> (authResult.succeeded()) {
      User user = authResult.result();
      user.isAuthorised(<span class="string"><span class="delimiter">&quot;</span><span class="content">create</span><span class="delimiter">&quot;</span></span>, canCreate -&gt; {  <b class="conum">(2)</b>
        user.isAuthorised(<span class="string"><span class="delimiter">&quot;</span><span class="content">delete</span><span class="delimiter">&quot;</span></span>, canDelete -&gt; {
          user.isAuthorised(<span class="string"><span class="delimiter">&quot;</span><span class="content">update</span><span class="delimiter">&quot;</span></span>, canUpdate -&gt; {

            <span class="predefined-type">String</span> token = jwtAuth.generateToken( <b class="conum">(3)</b>
              <span class="keyword">new</span> JsonObject()
                .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>, context.request().getHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">login</span><span class="delimiter">&quot;</span></span>))
                .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">canCreate</span><span class="delimiter">&quot;</span></span>, canCreate.succeeded() &amp;&amp; canCreate.result())
                .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">canDelete</span><span class="delimiter">&quot;</span></span>, canDelete.succeeded() &amp;&amp; canDelete.result())
                .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">canUpdate</span><span class="delimiter">&quot;</span></span>, canUpdate.succeeded() &amp;&amp; canUpdate.result()),
              <span class="keyword">new</span> JWTOptions()
                .setSubject(<span class="string"><span class="delimiter">&quot;</span><span class="content">Wiki API</span><span class="delimiter">&quot;</span></span>)
                .setIssuer(<span class="string"><span class="delimiter">&quot;</span><span class="content">Vert.x</span><span class="delimiter">&quot;</span></span>));
            context.response().putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/plain</span><span class="delimiter">&quot;</span></span>).end(token);
          });
        });
      });
    } <span class="keyword">else</span> {
      context.fail(<span class="integer">401</span>);
    }
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We expect login and password information to have been passed through HTTP request headers, and we authenticate using the Apache Shiro authentication provider of the previous section.</p>
</li>
<li>
<p>Upon success we can query for roles.</p>
</li>
<li>
<p>We generate a token with <code>username</code>, <code>canCreate</code>, <code>canDelete</code> and <code>canUpdate</code> claims.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Each API handler method can now query the current user principal and claims.
Here is how the <code>apiDeletePage</code> does it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> apiDeletePage(RoutingContext context) {
  <span class="keyword">if</span> (context.user().principal().getBoolean(<span class="string"><span class="delimiter">&quot;</span><span class="content">canDelete</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">false</span>)) {
    <span class="type">int</span> id = <span class="predefined-type">Integer</span>.valueOf(context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>));
    dbService.deletePage(id, reply -&gt; {
      handleSimpleDbReply(context, reply);
    });
  } <span class="keyword">else</span> {
    context.fail(<span class="integer">401</span>);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_jwt_tokens">Using JWT tokens</h4>
<div class="paragraph">
<p>To illustrate how to work with JWT tokens, let&#8217;s create a new one for the <code>root</code> user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ http --verbose --verify no GET https://localhost:8080/api/token login:root password:w00t
GET /api/token HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate
Connection: keep-alive
Host: localhost:8080
User-Agent: HTTPie/0.9.8
login: root
password: w00t



HTTP/1.1 200 OK
Content-Length: 242
Content-Type: text/plain
Set-Cookie: vertx-web.session=8cbb38ac4ce96737bfe31cc0ceaae2b9; Path=/

eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6InJvb3QiLCJjYW5DcmVhdGUiOnRydWUsImNhbkRlbGV0ZSI6dHJ1ZSwiY2FuVXBkYXRlIjp0cnVlLCJpYXQiOjE0ODk0NDE1OTAsImlzcyI6IlZlcnQueCIsInN1YiI6Ildpa2kgQVBJIn0=.RmtJb81QKVUFreXL-ajZ8ktLGasoKEqG8GSQncRWrN8=</pre>
</div>
</div>
<div class="paragraph">
<p>The response text is the token value and shall be retained.</p>
</div>
<div class="paragraph">
<p>We can check that performing an API request without the token results in a denial of access:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ http --verbose --verify no GET https://localhost:8080/api/pages
GET /api/pages HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate
Connection: keep-alive
Host: localhost:8080
User-Agent: HTTPie/0.9.8



HTTP/1.1 401 Unauthorized
Content-Length: 12

Unauthorized</pre>
</div>
</div>
<div class="paragraph">
<p>Sending a JWT token along with a request is done using a <code>Authorization</code> HTTP request header where the value must be <code>Bearer &lt;token value&gt;</code>.
Here is how to fix the API request above by passing the JWT token that had been issued to us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ http --verbose --verify no GET https://localhost:8080/api/pages 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6InJvb3QiLCJjYW5DcmVhdGUiOnRydWUsImNhbkRlbGV0ZSI6dHJ1ZSwiY2FuVXBkYXRlIjp0cnVlLCJpYXQiOjE0ODk0NDE1OTAsImlzcyI6IlZlcnQueCIsInN1YiI6Ildpa2kgQVBJIn0=.RmtJb81QKVUFreXL-ajZ8ktLGasoKEqG8GSQncRWrN8='
GET /api/pages HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6InJvb3QiLCJjYW5DcmVhdGUiOnRydWUsImNhbkRlbGV0ZSI6dHJ1ZSwiY2FuVXBkYXRlIjp0cnVlLCJpYXQiOjE0ODk0NDE1OTAsImlzcyI6IlZlcnQueCIsInN1YiI6Ildpa2kgQVBJIn0=.RmtJb81QKVUFreXL-ajZ8ktLGasoKEqG8GSQncRWrN8=
Connection: keep-alive
Host: localhost:8080
User-Agent: HTTPie/0.9.8



HTTP/1.1 200 OK
Content-Length: 99
Content-Type: application/json
Set-Cookie: vertx-web.session=0598697483371c7f3cb434fbe35f15e4; Path=/

{
    "pages": [
        {
            "id": 0,
            "name": "Hello"
        },
        {
            "id": 1,
            "name": "Apple"
        },
        {
            "id": 2,
            "name": "Vert.x"
        }
    ],
    "success": true
}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adapting_the_api_test_fixture">Adapting the API test fixture</h4>
<div class="paragraph">
<p>The <code>ApiTest</code> class needs to be updated to support JWT tokens.</p>
</div>
<div class="paragraph">
<p>We add a new field for retrieving the token value to be used in test cases:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="predefined-type">String</span> jwtTokenHeaderValue;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We add first step to retrieve a JTW token authenticated as user <code>foo</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> play_with_api(TestContext context) {
  Async async = context.async();

  <span class="predefined-type">Future</span>&lt;<span class="predefined-type">String</span>&gt; tokenRequest = <span class="predefined-type">Future</span>.future();
  webClient.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/token</span><span class="delimiter">&quot;</span></span>)
    .putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">login</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>)  <b class="conum">(1)</b>
    .putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>)
    .as(BodyCodec.string()) <b class="conum">(2)</b>
    .send(ar -&gt; {
      <span class="keyword">if</span> (ar.succeeded()) {
        tokenRequest.complete(ar.result().body());  <b class="conum">(3)</b>
      } <span class="keyword">else</span> {
        context.fail(ar.cause());
      }
    });
    <span class="comment">// (...)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Credentials are passed as headers.</p>
</li>
<li>
<p>The response payload is of <code>text/plain</code> type, so we use that for the body decoding codec.</p>
</li>
<li>
<p>Upon success we complete the <code>tokenRequest</code> future with the token value.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Using the JWT token is now a matter of passing it back as a header to HTTP requests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Future</span>&lt;JsonObject&gt; postRequest = <span class="predefined-type">Future</span>.future();
tokenRequest.compose(token -&gt; {
  jwtTokenHeaderValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">Bearer </span><span class="delimiter">&quot;</span></span> + token;  <b class="conum">(1)</b>
  webClient.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages</span><span class="delimiter">&quot;</span></span>)
    .putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Authorization</span><span class="delimiter">&quot;</span></span>, jwtTokenHeaderValue)  <b class="conum">(2)</b>
    .as(BodyCodec.jsonObject())
    .sendJsonObject(page, ar -&gt; {
      <span class="keyword">if</span> (ar.succeeded()) {
        HttpResponse&lt;JsonObject&gt; postResponse = ar.result();
        postRequest.complete(postResponse.body());
      } <span class="keyword">else</span> {
        context.fail(ar.cause());
      }
    });
}, postRequest);

<span class="predefined-type">Future</span>&lt;JsonObject&gt; getRequest = <span class="predefined-type">Future</span>.future();
postRequest.compose(h -&gt; {
  webClient.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages</span><span class="delimiter">&quot;</span></span>)
    .putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Authorization</span><span class="delimiter">&quot;</span></span>, jwtTokenHeaderValue)
    .as(BodyCodec.jsonObject())
    .send(ar -&gt; {
      <span class="keyword">if</span> (ar.succeeded()) {
        HttpResponse&lt;JsonObject&gt; getResponse = ar.result();
        getRequest.complete(getResponse.body());
      } <span class="keyword">else</span> {
        context.fail(ar.cause());
      }
    });
}, getRequest);
<span class="comment">// (...)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We store the token with the <code>Bearer</code> prefix to the field for the next requests.</p>
</li>
<li>
<p>We pass the token as a header.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reactive_programming_with_rxjava">Reactive programming with RxJava</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The corresponding source code is in the <code>step-8</code> folder of the guide repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So far we have explored various areas of the Vert.x stack, using the callback-based APIs.
It just works and this programming model is well-known from developers in many languages.
However, it can become a bit tedious, especially when you combine several sources of events, or deal with complex data flows.</p>
</div>
<div class="paragraph">
<p>This is exactly where RxJava shines, and Vert.x integrates with it seamlessly.</p>
</div>
<div class="sect2">
<h3 id="_enabling_the_rxjava_apis">Enabling the RxJava APIs</h3>
<div class="paragraph">
<p>In addition to the callback-based API, the Vert.x modules offer an <em>"Rxified"</em> API.
To enable it, start by adding the <code>vertx-rx-java</code> module to the Maven POM file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>io.vertx<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>vertx-rx-java<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Verticles then have to be modified so that they extend <code>io.vertx.rxjava.core.AbstractVerticle</code> instead of <code>io.vertx.core.AbstractVerticle</code>.
How is this different? The former class extends the latter and exposes a <code>io.vertx.rxjava.core.Vertx</code> field.</p>
</div>
<div class="paragraph">
<p><code>io.vertx.rxjava.core.Vertx</code> defines extra <code>rxSomething(&#8230;&#8203;)</code> methods that are equivalent to their callback-based counterparts.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take a look at the <code>MainVerticle</code> to get a better idea of how it works in practice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Single&lt;<span class="predefined-type">String</span>&gt; dbVerticleDeployment = vertx.rxDeployVerticle(
  <span class="string"><span class="delimiter">&quot;</span><span class="content">io.vertx.guides.wiki.database.WikiDatabaseVerticle</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>rxDeploy</code> method does not take a <code>Handler&lt;AsyncResult&lt;String&gt;&gt;</code> as final parameter.
Instead, it returns a <code>Single&lt;String&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Besides, the operation does not start when the method is called.
It starts when you subscribe to the <code>Single</code>.
When the operation completes, it emits the deployment <code>id</code> or signals the cause of the problem with a <code>Throwable</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deploying_verticles_in_order">Deploying verticles in order</h3>
<div class="paragraph">
<p>To finalize the <code>MainVerticle</code> refactoring, we must make sure the deployment operations get triggered and happen in order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">dbVerticleDeployment
  .flatMap(id -&gt; { <b class="conum">(1)</b>

    Single&lt;<span class="predefined-type">String</span>&gt; httpVerticleDeployment = vertx.rxDeployVerticle(
      <span class="string"><span class="delimiter">&quot;</span><span class="content">io.vertx.guides.wiki.http.HttpServerVerticle</span><span class="delimiter">&quot;</span></span>,
      <span class="keyword">new</span> DeploymentOptions().setInstances(<span class="integer">2</span>));

    <span class="keyword">return</span> httpVerticleDeployment;
  })
  .subscribe(id -&gt; startFuture.complete(), startFuture::fail); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>flatMap</code> operator applies the function to the result of <code>dbVerticleDeployment</code>. Here it schedules the deployment of the <code>HttpServerVerticle</code>.</p>
</li>
<li>
<p>Operations start when subscribing. On success or on error, the <code>MainVerticle</code> start future is either completed or failed.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_executing_authorization_queries_concurrently">Executing authorization queries concurrently</h3>
<div class="paragraph">
<p>In the previous example, we saw how to use RxJava operators and the Rxified Vert.x API to execute asynchronous operations in order.
But sometimes this guarantee is not required, or you simply want them to run concurrently for performance reasons.</p>
</div>
<div class="paragraph">
<p>The JWT token generation process in the <code>HttpServerVerticle</code> is a good example of such a situation.
To create a token, we need all authorization query results to complete, but queries are independent from each other:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Single&lt;<span class="predefined-type">Boolean</span>&gt; create = user.rxIsAuthorised(<span class="string"><span class="delimiter">&quot;</span><span class="content">create</span><span class="delimiter">&quot;</span></span>); <b class="conum">(1)</b>
Single&lt;<span class="predefined-type">Boolean</span>&gt; delete = user.rxIsAuthorised(<span class="string"><span class="delimiter">&quot;</span><span class="content">delete</span><span class="delimiter">&quot;</span></span>);
Single&lt;<span class="predefined-type">Boolean</span>&gt; update = user.rxIsAuthorised(<span class="string"><span class="delimiter">&quot;</span><span class="content">update</span><span class="delimiter">&quot;</span></span>);

<span class="keyword">return</span> Single.zip(create, delete, update, (canCreate, canDelete, canUpdate) -&gt; { <b class="conum">(2)</b>
  <span class="keyword">return</span> jwtAuth.generateToken(
    <span class="keyword">new</span> JsonObject()
      .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>, context.request().getHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">login</span><span class="delimiter">&quot;</span></span>))
      .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">canCreate</span><span class="delimiter">&quot;</span></span>, canCreate)
      .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">canDelete</span><span class="delimiter">&quot;</span></span>, canDelete)
      .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">canUpdate</span><span class="delimiter">&quot;</span></span>, canUpdate),
    <span class="keyword">new</span> JWTOptions()
      .setSubject(<span class="string"><span class="delimiter">&quot;</span><span class="content">Wiki API</span><span class="delimiter">&quot;</span></span>)
      .setIssuer(<span class="string"><span class="delimiter">&quot;</span><span class="content">Vert.x</span><span class="delimiter">&quot;</span></span>));
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Three <code>Single</code> objects are created, representing the different authorization queries.</p>
</li>
<li>
<p>When the three operations complete successfully, the <code>zip</code> operator callback is invoked with the results.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_database_connections">Working with database connections</h3>
<div class="paragraph">
<p>To acquire a database connection from the pool, all you have to do is calling <code>rxGetConnection</code> on the <code>JDBCClient</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Single&lt;SQLConnection&gt; connection = dbClient.rxGetConnection();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The method returns a <code>Single&lt;Connection&gt;</code> which you can easily transform with <code>flatMap</code> to execute SQL queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Single&lt;<span class="predefined-type">ResultSet</span>&gt; resultSet = connection
  .flatMap(conn -&gt; conn.rxQueryWithParams(sqlQueries.get(SqlQuery.GET_PAGE_BY_ID), <span class="keyword">new</span> JsonArray().add(id)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>But how can we release the connection if the <code>SQLConnection</code> reference is no longer reachable?
A simple and convenient way to do this is to invoke <code>close</code> when the <code>Single&lt;SQLConnection&gt;</code> is unsubscribed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> Single&lt;SQLConnection&gt; getConnection() {
  <span class="keyword">return</span> dbClient.rxGetConnection().flatMap(conn -&gt; {
    Single&lt;SQLConnection&gt; connectionSingle = Single.just(conn); <b class="conum">(1)</b>
    <span class="keyword">return</span> connectionSingle.doOnUnsubscribe(conn::close); <b class="conum">(2)</b>
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>After the connection is acquired we wrap it into a <code>Single</code></p>
</li>
<li>
<p>The <code>Single</code> is modified to invoke <code>close</code> when unsubscribed</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now we shall use <code>getConnection</code> anytime we need to execute SQL queries in our database verticle.</p>
</div>
</div>
<div class="sect2">
<h3 id="_bridging_the_gap_between_callbacks_and_rxjava">Bridging the gap between callbacks and RxJava</h3>
<div class="paragraph">
<p>At times, you may have to mix your RxJava code with a callback-based API.
For example, service proxy interfaces can only be defined with callbacks, but the implementation uses the Vert.x Rxified API.</p>
</div>
<div class="paragraph">
<p>In this case, the <code>io.vertx.rx.java.RxHelper</code> class can adapt a <code>Handler&lt;AsyncResult&lt;T&gt;&gt;</code> to an RxJava <code>Subscriber&lt;T&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> WikiDatabaseService fetchAllPagesData(<span class="predefined-type">Handler</span>&lt;AsyncResult&lt;<span class="predefined-type">List</span>&lt;JsonObject&gt;&gt;&gt; resultHandler) { <b class="conum">(1)</b>
  getConnection()
    .flatMap(connection -&gt; connection.rxQuery(sqlQueries.get(SqlQuery.ALL_PAGES_DATA)))
    .map(<span class="predefined-type">ResultSet</span>::getRows)
    .subscribe(RxHelper.toSubscriber(resultHandler));  <b class="conum">(2)</b>
  <span class="keyword">return</span> <span class="local-variable">this</span>;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>fetchAllPagesData</code> is an asynchronous service proxy operation, defined with a <code>Handler&lt;AsyncResult&lt;List&lt;JsonObject&gt;&gt;&gt;</code> callback.</p>
</li>
<li>
<p>The <code>toSubscriber</code> method adapts the <code>resultHandler</code> to a <code>Subscriber&lt;List&lt;JsonObject&gt;&gt;</code>, so that the handler is invoked when the list of rows is emitted.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_data_flows">Data flows</h3>
<div class="paragraph">
<p>RxJava is not only great at combining different sources of events, it is also very helpful with data flows.
Unlike a Vert.x or JDK future, an <code>Observable</code> emits a stream of events, not just a single one.
And it comes with an extensive set of data manipulation operators.</p>
</div>
<div class="paragraph">
<p>We can use a few of them to refactor the <code>fetchAllPages</code> database verticle method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> WikiDatabaseService fetchAllPages(<span class="predefined-type">Handler</span>&lt;AsyncResult&lt;JsonArray&gt;&gt; resultHandler) {
  getConnection()
    .flatMap(conn -&gt; conn.rxQuery(sqlQueries.get(SqlQuery.ALL_PAGES)))
    .flatMapObservable(res -&gt; {  <b class="conum">(1)</b>
      <span class="predefined-type">List</span>&lt;JsonArray&gt; results = res.getResults();
      <span class="keyword">return</span> <span class="predefined-type">Observable</span>.from(results); <b class="conum">(2)</b>
    })
    .map(json -&gt; json.getString(<span class="integer">0</span>)) <b class="conum">(3)</b>
    .sorted() <b class="conum">(4)</b>
    .collect(JsonArray::<span class="keyword">new</span>, JsonArray::add) <b class="conum">(5)</b>
    .subscribe(RxHelper.toSubscriber(resultHandler));
  <span class="keyword">return</span> <span class="local-variable">this</span>;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>With <code>flatMapObservable</code> we will create an <code>Observable</code> from the item emitted by the <code>Single&lt;Result&gt;</code>.</p>
</li>
<li>
<p><code>from</code> converts the database <code>results</code> iterable into an <code>Observable</code> emitting the database row items.</p>
</li>
<li>
<p>Since we only need the page name we can <code>map</code> each <code>JsonObject</code> row to the first column.</p>
</li>
<li>
<p>The client expects the data to be <code>sorted</code> in alphabetical order.</p>
</li>
<li>
<p>The event bus service reply consists in a single <code>JsonArray</code>. <code>collect</code> creates a new one with <code>JsonArray::new</code> and later adds items as they are emitted with <code>JsonArray::add</code>.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_client_side_web_application_using_angularjs">Client-side web application using AngularJS</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The corresponding source code is in the <code>step-9</code> folder of the guide repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>So far our web interface was using traditional server-side rendering of HTML content.
Some types of applications can take advantage of client-side rendering to improve user experience by avoiding full page reloads, and approaching the experience of native applications.</p>
</div>
<div class="paragraph">
<p>Many popular frameworks exist for that purpose.
We chose the popular <a href="http://angularjs.org/">AngularJS framework</a> for this guide, but one could equally choose <a href="https://facebook.github.io/react/">React</a>, <a href="https://vuejs.org/">Vue.js</a>, <a href="http://riotjs.com/">Riot</a> or another framework/library without any loss of generality.</p>
</div>
<div class="sect2">
<h3 id="_single_page_application">Single page application</h3>
<div class="paragraph">
<p>The wiki editing application that we are building allows to select a page, and edit it with the first half of the screen being a HTML preview, and the other half being the Markdown editor:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-9/images/edit-page.png" alt="edit page">
</div>
</div>
<div class="paragraph">
<p>The HTML preview is being rendered by calling a new endpoint in our backend.
Rendering is triggered when the Markdown editor text changes.
To avoid overloading the backend with unnecessary requests when the user is busy typing Markdown, a delay is being introduced so as to only trigger the rendering when no change has been made during that delay.</p>
</div>
<div class="paragraph">
<p>The application interface is also dynamic, as new pages make the deletion button disappear:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-9/images/new-page.png" alt="new page">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_vert_x_backend">Vert.x Backend</h3>
<div class="sect3">
<h4 id="_simplifying_the_http_verticle_code">Simplifying the HTTP verticle code</h4>
<div class="paragraph">
<p>A client-side application needs a backend that exposes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>the static HTML, CSS and JavaScript content to bootstrap applications in web browsers, and</p>
</li>
<li>
<p>a web API, typically a HTTP/JSON service.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We simplified the HTTP verticle implementation to <em>just</em> cover what is needed.
Starting from the RxJava version from <em>step #8</em>, we removed all server-side rendering code as well as the authentication and JWT token issuing code to expose a plain open HTTP/JSON interface.</p>
</div>
<div class="paragraph">
<p>Of course building a version that leverages JWT tokens and authentication makes sense for a real-world deployments, but now that we have covered these features we would rather focus on the essential bits in this part of the guide.</p>
</div>
<div class="paragraph">
<p>As an example, the <code>apiUpdatePage</code> method implementation code is now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="type">void</span> apiUpdatePage(RoutingContext context) {
  <span class="type">int</span> id = <span class="predefined-type">Integer</span>.valueOf(context.request().getParam(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>));
  JsonObject page = context.getBodyAsJson();
  <span class="keyword">if</span> (!validateJsonPageDocument(context, page, <span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>)) {
    <span class="keyword">return</span>;
  }
  dbService.rxSavePage(id, page.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>)).subscribe(
    v -&gt; apiResponse(context, <span class="integer">200</span>, <span class="predefined-constant">null</span>, <span class="predefined-constant">null</span>),
    t -&gt; apiFailure(context, t));
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_exposed_routes">Exposed routes</h4>
<div class="paragraph">
<p>The HTTP/JSON API is exposed through the sames routes as in the previous steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::apiRoot);
router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages/:id</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::apiGetPage);
router.post().handler(BodyHandler.create());
router.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::apiCreatePage);
router.put().handler(BodyHandler.create());
router.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages/:id</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::apiUpdatePage);
router.delete(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages/:id</span><span class="delimiter">&quot;</span></span>).handler(<span class="local-variable">this</span>::apiDeletePage);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The front application static assets are being served from <code>/app</code>, and we redirect requests to <code>/</code> to the <code>/app/index.html</code> static file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/app/*</span><span class="delimiter">&quot;</span></span>).handler(StaticHandler.create().setCachingEnabled(<span class="predefined-constant">false</span>));  <b class="conum">(1)</b> <b class="conum">(2)</b>
router.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>).handler(context -&gt; context.reroute(<span class="string"><span class="delimiter">&quot;</span><span class="content">/app/index.html</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Disabling caching is useful in development.</p>
</li>
<li>
<p>By default the files are expected to be in the <code>webroot</code> package on the <em>classpath</em>, so the files shall be placed under <code>src/main/resources/webroot</code> in a Maven or Gradle project.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Last but not least, we anticipate that the application will need the backend to render Markdown to HTML, so we offer a HTTP POST endpoint for this purpose:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">router.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/app/markdown</span><span class="delimiter">&quot;</span></span>).handler(context -&gt; {
  <span class="predefined-type">String</span> html = Processor.process(context.getBodyAsString());
  context.response()
    .putHeader(<span class="string"><span class="delimiter">&quot;</span><span class="content">Content-Type</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text/html</span><span class="delimiter">&quot;</span></span>)
    .setStatusCode(<span class="integer">200</span>)
    .end(html);
});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_angularjs_frontend">AngularJS frontend</h3>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
This guide is not a proper introduction to AngularJS (<a href="https://docs.angularjs.org/tutorial">see the official tutorial instead</a>), we assume some familiarity with the framework from the reader.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_application_view">Application view</h4>
<div class="paragraph">
<p>The interface fits in a single HTML file located at <code>src/main/resources/webroot/index.html</code>.
The <code>head</code> section is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;html</span> <span class="attribute-name">lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">en</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ng-app</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">wikiApp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <b class="conum">(1)</b>
<span class="tag">&lt;head&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">viewport</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">width=device-width, initial-scale=1, shrink-to-fit=no</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;title&gt;</span>Wiki Angular App<span class="tag">&lt;/title&gt;</span>
  <span class="tag">&lt;link</span> <span class="attribute-name">rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;link</span> <span class="attribute-name">rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
  <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
  <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/app/wiki.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>  <b class="conum">(2)</b>
  <span class="tag">&lt;style&gt;</span>
<span class="inline">    <span class="tag">body</span> {
      <span class="key">padding-top</span>: <span class="float">2</span><span class="value">rem</span>;
      <span class="key">padding-bottom</span>: <span class="float">2</span><span class="value">rem</span>;
    }</span>
  <span class="tag">&lt;/style&gt;</span>
<span class="tag">&lt;/head&gt;</span>
<span class="tag">&lt;body&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The AngularJS module is named <code>wikiApp</code>.</p>
</li>
<li>
<p><code>wiki.js</code> holds the code for our AngularJS module and controller.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As you can see beyond AngularJS we are using the following dependencies from external CDNs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://getbootstrap.com/">Boostrap</a> to style our interface,</p>
</li>
<li>
<p><a href="http://fontawesome.io/">Font Awesome</a> to provide icons,</p>
</li>
<li>
<p><a href="https://lodash.com/">Lodash</a> to help with some functional idioms in our JavaScript code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Bootstrap requires some further scripts that can be loaded at the end of the document for performance reasons:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://code.jquery.com/jquery-3.1.1.slim.min.js</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>

<span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our AngularJS controller is called <code>WikiController</code> and it is bound to a <code>div</code> which is also a Bootstrap container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">container</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ng-controller</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">WikiController</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="comment">&lt;!-- (...) --&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The buttons on top of the interface consist of the following elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">row</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-12</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dropdown</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;button</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-secondary dropdown-toggle</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">button</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pageDropdownButton</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">data-toggle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dropdown</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">aria-haspopup</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">aria-expanded</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;i</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fa fa-file-text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">aria-hidden</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/i&gt;</span> Pages
      <span class="tag">&lt;/button&gt;</span>
      <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dropdown-menu</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">aria-labelledby</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pageDropdownButton</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;a</span> <span class="attribute-name">ng-repeat</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">page in pages track by page.id</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dropdown-item</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ng-click</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load(page.id)</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>{{page.name}}<span class="tag">&lt;/a&gt;</span> <b class="conum">(1)</b>
      <span class="tag">&lt;/div&gt;</span>
    <span class="tag">&lt;/span&gt;</span>
    <span class="tag">&lt;span&gt;</span>
      <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">button</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-secondary</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ng-click</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reload()</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;i</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fa fa-refresh</span><span class="delimiter">&quot;</span></span>
                                                                             <span class="attribute-name">aria-hidden</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/i&gt;</span> Reload<span class="tag">&lt;/button&gt;</span> <b class="conum">(2)</b>
    <span class="tag">&lt;/span&gt;</span>
    <span class="tag">&lt;span&gt;</span>
      <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">button</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-secondary</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ng-click</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">newPage()</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;i</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fa fa-plus-square</span><span class="delimiter">&quot;</span></span>
                                                                              <span class="attribute-name">aria-hidden</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/i&gt;</span> New page<span class="tag">&lt;/button&gt;</span>
    <span class="tag">&lt;/span&gt;</span>
    <span class="tag">&lt;span</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">float-right</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">button</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-secondary</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ng-click</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">delete()</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ng-show</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pageExists()</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;i</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fa fa-trash</span><span class="delimiter">&quot;</span></span>
                                                                                                    <span class="attribute-name">aria-hidden</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/i&gt;</span> Delete page<span class="tag">&lt;/button&gt;</span> <b class="conum">(3)</b>
    <span class="tag">&lt;/span&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-12</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <b class="conum">(4)</b>
    <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">invisible alert</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">alert</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">alertMessage</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      {{alertMessage}}
    <span class="tag">&lt;/div&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

<span class="tag">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>For each wiki page name we generate an element using <code>ng-repeat</code> and <code>ng-click</code> to define the controller action (<code>load</code>) when it is being clicked.</p>
</li>
<li>
<p>The refresh button is bound to the <code>reload</code> controller action. All other buttons work the same way.</p>
</li>
<li>
<p>The <code>ng-show</code> directive allows us to show or hide the element depending on the controller <code>pageExists</code> method value.</p>
</li>
<li>
<p>This <code>div</code> is used to display notifications of success or failures.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Markdown preview and editor elements are the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">row</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-6</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rendering</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/div&gt;</span>

  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-6</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;form&gt;</span>
      <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-group</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;label</span> <span class="attribute-name">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Markdown<span class="tag">&lt;/label&gt;</span>
        <span class="tag">&lt;textarea</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-control</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">rows</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">25</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ng-model</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pageMarkdown</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/textarea&gt;</span> <b class="conum">(1)</b>
      <span class="tag">&lt;/div&gt;</span>
      <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-group</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;label</span> <span class="attribute-name">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pageName</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Name<span class="tag">&lt;/label&gt;</span>
        <span class="tag">&lt;input</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">form-control</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pageName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ng-model</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pageName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ng-disabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pageExists()</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;/div&gt;</span>
      <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">button</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">btn btn-secondary</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ng-click</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">save()</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;i</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fa fa-pencil</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">aria-hidden</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/i&gt;</span> Save<span class="tag">&lt;/button&gt;</span>
    <span class="tag">&lt;/form&gt;</span>
  <span class="tag">&lt;/div&gt;</span>

<span class="tag">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>ng-model</code> binds the <code>textarea</code> content to the <code>pageMarkdown</code> property of the controller.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_application_controller">Application controller</h4>
<div class="paragraph">
<p>The <code>wiki.js</code> JavaScript starts with an AngularJS module declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="string"><span class="delimiter">'</span><span class="content">use strict</span><span class="delimiter">'</span></span>;

angular.module(<span class="string"><span class="delimiter">&quot;</span><span class="content">wikiApp</span><span class="delimiter">&quot;</span></span>, [])
  .controller(<span class="string"><span class="delimiter">&quot;</span><span class="content">WikiController</span><span class="delimiter">&quot;</span></span>, [<span class="string"><span class="delimiter">&quot;</span><span class="content">$scope</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">$http</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">$timeout</span><span class="delimiter">&quot;</span></span>, <span class="keyword">function</span> (<span class="predefined">$scope</span>, <span class="predefined">$http</span>, <span class="predefined">$timeout</span>) {

    <span class="keyword">var</span> DEFAULT_PAGENAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">Example page</span><span class="delimiter">&quot;</span></span>;
    <span class="keyword">var</span> DEFAULT_MARKDOWN = <span class="string"><span class="delimiter">&quot;</span><span class="content"># Example page</span><span class="char">\n</span><span class="char">\n</span><span class="content">Some text _here_.</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>;

    <span class="comment">// (...)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>wikiApp</code> module has no plugin dependency, and declares a single <code>WikiController</code> controller.
The controller requires dependency injection of the following objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>$scope</code> to provide DOM scoping to the controller, and</p>
</li>
<li>
<p><code>$http</code> to perform asynchronous HTTP requests to the backend, and</p>
</li>
<li>
<p><code>$timeout</code> to trigger actions after a given delay while staying tied to the AngularJS life-cycle (e.g., to ensure that any state modification triggers view changes, which is not the case when using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout">classic setTimeout function</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Controller methods are being tied to the <code>$scope</code> object.
Let us start with 3 simple methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="predefined">$scope</span>.<span class="function">newPage</span> = <span class="keyword">function</span>() {
  <span class="predefined">$scope</span>.pageId = <span class="predefined-constant">undefined</span>;
  <span class="predefined">$scope</span>.pageName = DEFAULT_PAGENAME;
  <span class="predefined">$scope</span>.pageMarkdown = DEFAULT_MARKDOWN;
};

<span class="predefined">$scope</span>.<span class="function">reload</span> = <span class="keyword">function</span> () {
  <span class="predefined">$http</span>.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages</span><span class="delimiter">&quot;</span></span>).then(<span class="keyword">function</span> (response) {
    <span class="predefined">$scope</span>.pages = response.data.pages;
  });
};

<span class="predefined">$scope</span>.<span class="function">pageExists</span> = <span class="keyword">function</span>() {
  <span class="keyword">return</span> <span class="predefined">$scope</span>.pageId !== <span class="predefined-constant">undefined</span>;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Creating a new page consists in initializing controller properties that are attached to the <code>$scope</code> object.
Reloading the pages objects from the backend is a matter of performing a HTTP GET request (note that the <code>$http</code> request methods return promises).
The <code>pageExists</code> method is being used to show / hide elements in the interface.</p>
</div>
<div class="paragraph">
<p>Loading the content of the page is also a matter of performing a HTTP GET request, and updating the preview a DOM manipulation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="predefined">$scope</span>.<span class="function">load</span> = <span class="keyword">function</span> (id) {
  <span class="predefined">$http</span>.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages/</span><span class="delimiter">&quot;</span></span> + id).then(<span class="keyword">function</span>(response) {
    <span class="keyword">var</span> page = response.data.page;
    <span class="predefined">$scope</span>.pageId = page.id;
    <span class="predefined">$scope</span>.pageName = page.name;
    <span class="predefined">$scope</span>.pageMarkdown = page.markdown;
    <span class="predefined">$scope</span>.updateRendering(page.html);
  });
};

<span class="predefined">$scope</span>.<span class="function">updateRendering</span> = <span class="keyword">function</span>(html) {
  document.getElementById(<span class="string"><span class="delimiter">&quot;</span><span class="content">rendering</span><span class="delimiter">&quot;</span></span>).innerHTML = html;
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next methods support saving / updating and deleting pages.
For these operations we used the full <code>then</code> promise method with the first argument being called on success, and the second one being called on error.
We also introduce the <code>success</code> and <code>error</code> helper methods to display notifications (3 seconds on success, 5 seconds on error):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="predefined">$scope</span>.<span class="function">save</span> = <span class="keyword">function</span>() {
  <span class="keyword">var</span> payload;
  <span class="keyword">if</span> (<span class="predefined">$scope</span>.pageId === <span class="predefined-constant">undefined</span>) {
    payload = {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="predefined">$scope</span>.pageName,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>: <span class="predefined">$scope</span>.pageMarkdown
    };
    <span class="predefined">$http</span>.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages</span><span class="delimiter">&quot;</span></span>, payload).then(<span class="keyword">function</span>(ok) {
      <span class="predefined">$scope</span>.reload();
      <span class="predefined">$scope</span>.success(<span class="string"><span class="delimiter">&quot;</span><span class="content">Page created</span><span class="delimiter">&quot;</span></span>);
      <span class="keyword">var</span> guessMaxId = _.maxBy(<span class="predefined">$scope</span>.pages, <span class="keyword">function</span>(page) { <span class="keyword">return</span> page.id; });
      <span class="predefined">$scope</span>.load(guessMaxId.id || <span class="integer">0</span>);
    }, <span class="keyword">function</span>(err) {
      <span class="predefined">$scope</span>.error(err.data.error);
    });
  } <span class="keyword">else</span> {
    <span class="keyword">var</span> payload = {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>: <span class="predefined">$scope</span>.pageMarkdown
    };
    <span class="predefined">$http</span>.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages/</span><span class="delimiter">&quot;</span></span> + <span class="predefined">$scope</span>.pageId, payload).then(<span class="keyword">function</span>(ok) {
      <span class="predefined">$scope</span>.success(<span class="string"><span class="delimiter">&quot;</span><span class="content">Page saved</span><span class="delimiter">&quot;</span></span>);
    }, <span class="keyword">function</span>(err) {
      <span class="predefined">$scope</span>.error(err.data.error);
    });
  }
};

<span class="predefined">$scope</span>.<span class="keyword">delete</span> = <span class="keyword">function</span>() {
  <span class="predefined">$http</span>.<span class="keyword">delete</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/pages/</span><span class="delimiter">&quot;</span></span> + <span class="predefined">$scope</span>.pageId).then(<span class="keyword">function</span>(ok) {
    <span class="predefined">$scope</span>.reload();
    <span class="predefined">$scope</span>.newPage();
    <span class="predefined">$scope</span>.success(<span class="string"><span class="delimiter">&quot;</span><span class="content">Page deleted</span><span class="delimiter">&quot;</span></span>);
  }, <span class="keyword">function</span>(err) {
    <span class="predefined">$scope</span>.error(err.data.error);
  });
};

<span class="predefined">$scope</span>.<span class="function">success</span> = <span class="keyword">function</span>(message) {
  <span class="predefined">$scope</span>.alertMessage = message;
  <span class="keyword">var</span> alert = document.getElementById(<span class="string"><span class="delimiter">&quot;</span><span class="content">alertMessage</span><span class="delimiter">&quot;</span></span>);
  alert.classList.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">alert-success</span><span class="delimiter">&quot;</span></span>);
  alert.classList.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">invisible</span><span class="delimiter">&quot;</span></span>);
  <span class="predefined">$timeout</span>(<span class="keyword">function</span>() {
    alert.classList.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">invisible</span><span class="delimiter">&quot;</span></span>);
    alert.classList.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">alert-success</span><span class="delimiter">&quot;</span></span>);
  }, <span class="integer">3000</span>);
};

<span class="predefined">$scope</span>.<span class="function">error</span> = <span class="keyword">function</span>(message) {
  <span class="predefined">$scope</span>.alertMessage = message;
  <span class="keyword">var</span> alert = document.getElementById(<span class="string"><span class="delimiter">&quot;</span><span class="content">alertMessage</span><span class="delimiter">&quot;</span></span>);
  alert.classList.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">alert-danger</span><span class="delimiter">&quot;</span></span>);
  alert.classList.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">invisible</span><span class="delimiter">&quot;</span></span>);
  <span class="predefined">$timeout</span>(<span class="keyword">function</span>() {
    alert.classList.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">invisible</span><span class="delimiter">&quot;</span></span>);
    alert.classList.remove(<span class="string"><span class="delimiter">&quot;</span><span class="content">alert-danger</span><span class="delimiter">&quot;</span></span>);
  }, <span class="integer">5000</span>);
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>initializing the application state and views is done by fetching the pages list, and starting with a blank new page editor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="predefined">$scope</span>.reload();
<span class="predefined">$scope</span>.newPage();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally here is how we perform live rendering of Markdown text:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">var</span> markdownRenderingPromise = <span class="predefined-constant">null</span>;
<span class="predefined">$scope</span>.<span class="predefined">$watch</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">pageMarkdown</span><span class="delimiter">&quot;</span></span>, <span class="keyword">function</span>(text) {  <b class="conum">(1)</b>
  <span class="keyword">if</span> (markdownRenderingPromise !== <span class="predefined-constant">null</span>) {
    <span class="predefined">$timeout</span>.cancel(markdownRenderingPromise);  <b class="conum">(3)</b>
  }
  markdownRenderingPromise = <span class="predefined">$timeout</span>(<span class="keyword">function</span>() {
    markdownRenderingPromise = <span class="predefined-constant">null</span>;
    <span class="predefined">$http</span>.post(<span class="string"><span class="delimiter">&quot;</span><span class="content">/app/markdown</span><span class="delimiter">&quot;</span></span>, text).then(<span class="keyword">function</span>(response) { <b class="conum">(4)</b>
      <span class="predefined">$scope</span>.updateRendering(response.data);
    });
  }, <span class="integer">300</span>); <b class="conum">(2)</b>
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>$scope.$watch</code> allows being notified of state changes. Here we monitor changes on the <code>pageMarkdown</code> property that is bound to the editor <code>textarea</code>.</p>
</li>
<li>
<p>300 milliseconds is a <em>fine</em> delay to trigger rendering if nothing has changed in the editor.</p>
</li>
<li>
<p>Timeouts are promise, so if the state has changed we cancel the previous one and create a new one. This is how we delay rendering instead of doing it on every keystroke.</p>
</li>
<li>
<p>We ask the backend to render the editor text into some HTML, then refresh the preview.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_real_time_web_features_using_cross_border_messaging_over_the_event_bus">Real-time web features using cross-border messaging over the event bus</h2>
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The corresponding source code is in the <code>step-10</code> folder of the guide repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Earlier in this guide we saw the event bus in action for verticles to communicate using message-passing inside Vert.x applications.
The developer only has to register a consumer to receive messages and sending / publishing messages.</p>
</div>
<div class="paragraph">
<p>The SockJS event bus bridge extends these capabilities to the client-side, in the web browser.
It creates a distributed event bus which not only spans multiple Vert.x instances in a cluster, but also includes client-side JavaScript running in (many) browsers.
We can therefore create a huge distributed event bus encompassing many browsers and servers, resulting in a consistent message-based programming model across all constituents of a distributed application.</p>
</div>
<div class="paragraph">
<p>In this chapter, we will modify the code from <code>step-9</code> so that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the Markdown content to be rendered is sent to the server without creating new HTTP requests, and</p>
</li>
<li>
<p>the page shows a warning when a user is editing a page which has just been modified by another user.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_setting_up_the_sockjs_event_bus_bridge">Setting up the SockJS event bus bridge</h3>
<div class="sect3">
<h4 id="_on_the_server">On the server</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>SockJS is a client-side JavaScript library and protocol that provides a simple WebSocket-like interface for making connections to SockJS servers, irrespective of whether the actual browser or network will allow real WebSockets.
It does this by supporting various different transports between browser and server, and choosing one at runtime according to their capabilities.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As a first step, we need to setup the <code>SockJSHandler</code> that is provided by the <code>vertx-web</code> project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SockJSHandler sockJSHandler = SockJSHandler.create(vertx); <b class="conum">(1)</b>
BridgeOptions bridgeOptions = <span class="keyword">new</span> BridgeOptions()
  .addInboundPermitted(<span class="keyword">new</span> PermittedOptions().setAddress(<span class="string"><span class="delimiter">&quot;</span><span class="content">app.markdown</span><span class="delimiter">&quot;</span></span>))  <b class="conum">(2)</b>
  .addOutboundPermitted(<span class="keyword">new</span> PermittedOptions().setAddress(<span class="string"><span class="delimiter">&quot;</span><span class="content">page.saved</span><span class="delimiter">&quot;</span></span>)); <b class="conum">(3)</b>
sockJSHandler.bridge(bridgeOptions); <b class="conum">(4)</b>
router.route(<span class="string"><span class="delimiter">&quot;</span><span class="content">/eventbus/*</span><span class="delimiter">&quot;</span></span>).handler(sockJSHandler); <b class="conum">(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Create a new <code>SockJSHandler</code> for this <code>vertx</code> instance.</p>
</li>
<li>
<p>Allow delivery of messages coming from the browser on the <code>app.markdown</code> address.
We will use this address to get the server process the Markdown content as we edit a wiki page.</p>
</li>
<li>
<p>Allow sending messages going to the browser on the <code>page.saved</code> address.
We will use this address to notify browsers that a wiki page has been modified.</p>
</li>
<li>
<p>Configure the handler to bridge SockJS traffic to the event bus.</p>
</li>
<li>
<p>Handle all requests under the <code>/eventbus</code> path with the SockJS handler.</p>
</li>
</ol>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="paragraph">
<p>For most applications you probably do not want client side JavaScript to be able to send just any message to any handler on the server side, or to all other browsers.
For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>you may have a service on the event bus that allows data to be accessed or deleted, and clearly we do not want badly behaved or malicious clients to be able to delete all the data in your database,</p>
</li>
<li>
<p>we do not necessarily want any client to be able to listen on any event bus address.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To deal with this, a SockJS bridge will by default refuse any messages through.
This is why it is up to you to tell the bridge what messages are ok for it to pass through (as an exception reply messages are always allowed to pass through).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_on_the_client">On the client</h4>
<div class="paragraph">
<p>Now that the server is ready to accept messages, we shall configure the client.</p>
</div>
<div class="paragraph">
<p>First, the SockJS library and the Vert.x event bus JavaScript client must be loaded.
The easiest way to get started is to get the files from a public content delivery network:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha256-KWJavOowudybFMUCd547Wvd/u8vUg/2g0uSWYU5Ae+w=</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://cdnjs.cloudflare.com/ajax/libs/vertx/3.4.1/vertx-eventbus.min.js</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha256-EX8Kk2SwcSUXBJ4RORlETHNwHWEw+57C/YDLnbiIl3U=</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The event bus client can be downloaded beforehand and bundled with the application.
It is published on <code>Maven</code>, <code>npm</code>, <code>bower</code> and even <code>webjars</code> repositories.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, we create a new instance of the <code>EventBus</code> Javascript object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">var</span> eb = <span class="keyword">new</span> EventBus(window.location.protocol + <span class="string"><span class="delimiter">&quot;</span><span class="content">//</span><span class="delimiter">&quot;</span></span> + window.location.host + <span class="string"><span class="delimiter">&quot;</span><span class="content">/eventbus</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_the_markdown_content_over_the_event_bus_for_processing">Sending the Markdown content over the event bus for processing</h3>
<div class="paragraph">
<p>The SockJS bridge is now up and running.
In order to process the Markdown content on the server side, we need to register a consumer.
The consumer handles messages sent to the <code>app.markdown</code> address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">vertx.eventBus().&lt;<span class="predefined-type">String</span>&gt;consumer(<span class="string"><span class="delimiter">&quot;</span><span class="content">app.markdown</span><span class="delimiter">&quot;</span></span>, msg -&gt; {
  <span class="predefined-type">String</span> html = Processor.process(msg.body());
  msg.reply(html);
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is nothing new here, we have already been creating event bus consumers before.
Now let&#8217;s turn to what happens in the client code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">eb.send(<span class="string"><span class="delimiter">&quot;</span><span class="content">app.markdown</span><span class="delimiter">&quot;</span></span>, text, <span class="keyword">function</span> (err, reply) { <b class="conum">(1)</b>
  <span class="keyword">if</span> (err === <span class="predefined-constant">null</span>) {
    <span class="predefined">$scope</span>.<span class="predefined">$apply</span>(<span class="keyword">function</span> () { <b class="conum">(2)</b>
      <span class="predefined">$scope</span>.updateRendering(reply.body); <b class="conum">(3)</b>
    });
  } <span class="keyword">else</span> {
    console.warn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Error rendering Markdown content: </span><span class="delimiter">&quot;</span></span> + JSON.stringify(err));
  }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <em>reply handler</em> is a function taking two parameters: an error (if any) and the <code>reply</code> object.
The <code>reply</code> object content is nested inside the <code>body</code> property.</p>
</li>
<li>
<p>Since the event bus client is not managed by AngularJS, <code>$scope.$apply</code> wraps the callback to perform proper scope life-cycle.</p>
</li>
<li>
<p>As we did when working with <code>$http</code>, we invoke <code>updateRendering</code> with the HTML result.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Admittedly, the code is very similar to its HTTP endpoint equivalent.
However the benefit here does not lie in the number of lines of code.</p>
</div>
<div class="paragraph">
<p>Indeed, if you communicate with the server over the event bus, the bridge transparently distributes incoming messages among registered consumers.
Consequently, when Vert.x runs in cluster mode, the browser is not tied to a single server for processing (apart from the SockJS connection).
What&#8217;s more the connection to the server is never closed, so with HTTP/1.1 this saves establishing a TCP connection for each request, which may be useful if you have lots of exchanges between servers and clients.</p>
</div>
</div>
<div class="sect2">
<h3 id="_warning_the_user_when_the_page_is_modified">Warning the user when the page is modified</h3>
<div class="paragraph">
<p>In many applications, the <em>last commit wins</em> principle is how conflicts are being resolved: when two users edit the same resource at the same time, the last one to press the <em>save</em> button overwrites any previous changes.</p>
</div>
<div class="paragraph">
<p>There are ways around this issue, like entity versioning or extensive literature on the topic of distributed consensus.
Nevertheless, let&#8217;s stick to a simple solution and see how we can notify the user when a change has been made so that at the very least (s)he can get a chance to deal with the situation.
As soon as the content has been changed in the database, the user can decide what is the best course of action to take: overwrite or reload.</p>
</div>
<div class="paragraph">
<p>To start with, we need to add an <code>alert alert-warning</code> message <code>div</code> in the page.
But we want it to show-up only when the <code>pageModified</code> scope variable is set to <code>true</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">col-md-12</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;div</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">alert alert-warning ng-class:{'invisible': !pageModified};</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">alert</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    The page has been modified by another user.
    <span class="tag">&lt;a</span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ng-click</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load(pageId)</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Reload<span class="tag">&lt;/a&gt;</span>
  <span class="tag">&lt;/div&gt;</span>
<span class="tag">&lt;/div&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, <code>pageModified</code> must be set to <code>true</code> when this page is saved.
Let&#8217;s register an event bus handler for the <code>page.saved</code> address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">var</span> clientUuid = generateUUID(); <b class="conum">(1)</b>
eb.<span class="function">onopen</span> = <span class="keyword">function</span> () {
  eb.registerHandler(<span class="string"><span class="delimiter">&quot;</span><span class="content">page.saved</span><span class="delimiter">&quot;</span></span>, <span class="keyword">function</span> (error, message) { <b class="conum">(2)</b>
    <span class="keyword">if</span> (message.body <b class="conum">(3)</b>
      &amp;&amp; <span class="predefined">$scope</span>.pageId === message.body.id <b class="conum">(4)</b>
      &amp;&amp; clientUuid !== message.body.client) { <b class="conum">(5)</b>
      <span class="predefined">$scope</span>.<span class="predefined">$apply</span>(<span class="keyword">function</span> () { <b class="conum">(6)</b>
        <span class="predefined">$scope</span>.pageModified = <span class="predefined-constant">true</span>; <b class="conum">(7)</b>
      });
    }
  });
};</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We do not want to print the warning if we modified the content ourselves so we need a client identifier.</p>
</li>
<li>
<p>The callback will be invoked when a message is received on the <code>page.saved</code> address.</p>
</li>
<li>
<p>Check that the body is not empty.</p>
</li>
<li>
<p>Make sure this event is related to the current wiki page.</p>
</li>
<li>
<p>Check that we are not the origin of the changes.</p>
</li>
<li>
<p>Since the event bus client is not managed by AngularJS, <code>$scope.$apply</code> wraps the callback to perform proper scope life cycle.</p>
</li>
<li>
<p>Set <code>pageModified</code> to true.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Eventually we have to push messages when the content of a page is saved in the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">dbService.rxSavePage(id, page.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">markdown</span><span class="delimiter">&quot;</span></span>))
  .doOnSuccess(v -&gt; { <b class="conum">(1)</b>
    JsonObject event = <span class="keyword">new</span> JsonObject()
      .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, id) <b class="conum">(2)</b>
      .put(<span class="string"><span class="delimiter">&quot;</span><span class="content">client</span><span class="delimiter">&quot;</span></span>, page.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">client</span><span class="delimiter">&quot;</span></span>)); <b class="conum">(3)</b>
    vertx.eventBus().publish(<span class="string"><span class="delimiter">&quot;</span><span class="content">page.saved</span><span class="delimiter">&quot;</span></span>, event); <b class="conum">(4)</b>
  })
  .subscribe(v -&gt; apiResponse(context, <span class="integer">200</span>, <span class="predefined-constant">null</span>, <span class="predefined-constant">null</span>), t -&gt; apiFailure(context, t));</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>rxSavePage</code> returns a <code>Single&lt;Void&gt;</code> object.
On success (i.e. no database failure) we publish an event.</p>
</li>
<li>
<p>The message contains the page identifier.</p>
</li>
<li>
<p>The message contains the client identifier.</p>
</li>
<li>
<p>The event is published on the <code>page.saved</code> address.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If we open the application in two tabs inside the same browser (or different browsers), select the same page on both, and update the content in one, the warning message is printed:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="step-10/images/edited-warning.png" alt="edited warning">
</div>
</div>
<div class="paragraph">
<p>We could easily leverage the SockJS bridge for other purposes, like showing how many users are currently on a given page, supporting live comments in a chat box, etc.
The key point is that both the server and the client sides share the same programming model by message passing over the event-bus.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the end of this guide.
Let us take a moment to recapitulate the important takeaways from the previous sections, and then conclude by pointing to further useful resources.</p>
</div>
<div class="sect2">
<h3 id="_summary">Summary</h3>
<div class="paragraph">
<p>We started this guide by building a wiki web application with Vert.x.
While the first iteration was typical of <em>"quick and dirty rapid prototyping"</em> it showed that one could quickly and easily build such an application with server-side rendering of web templates and persistence with a relational database.</p>
</div>
<div class="paragraph">
<p>The next steps showed how to improve the design through successive refactoring: first separating each technical concern as a standalone verticle, then extracting Vert.x services for API cleanliness and finally introducing JUnit tests for asynchronous code.</p>
</div>
<div class="paragraph">
<p>We then ventured into consuming third-party HTTP/JSON services using the web client API that further simplifies the usage of the HTTP client from Vert.x core.
Conversely, we also saw how to expose HTTP/JSON web APIs with the elegant Vert.x web module.</p>
</div>
<div class="paragraph">
<p>From there it is very easy to extend the approach to build API gateways for providing facades to many services.
If you were to build such gateways, we suggest that you take advantage of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the Vert.x RxJava support to describe service consumption data flow streams, and</p>
</li>
<li>
<p>the Vert.x circuit-breaker module to deal consistently with the potential failure of services.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Access control, authentication and security are often neglected or come as an aftermath.
We saw that Vert.x provides a simple pluggable authentication mechanism to leverage databases, files or LDAP directories.
SSL network encryption is very easy to setup for a server, or for a client to use.
Finally Vert.x supports JWT tokens, a very useful and decentralized authentication scheme for web APIs.</p>
</div>
<div class="paragraph">
<p>The Vert.x core API relies on callbacks as it is the most generic way of processing asynchronous events.
Vert.x provides a simple promise / future API.
While Vert.x futures are composable, they shall be confined to limited usages such as dealing with verticle deployments and initialization.
We saw how RxJava is supported in Vert.x, and we encourage you to use it for your own verticles.
What&#8217;s more RxJava is the most popular reactive programming library on the JVM, so you will easily find third-party libraries to integrate consistently in your end-to-end reactive applications.</p>
</div>
<div class="paragraph">
<p>Modern web applications tend to have the server expose <em>just</em> HTTP/JSON APIs, and rely on client-side web frameworks for the user interface.
We saw how to do that with AngularJS so as to turn our wiki into a single-page application.</p>
</div>
<div class="paragraph">
<p>Finally, we saw how elegant it was to extend the event bus of an application to allow web applications to send and receive events from the browser using the SockJS bridge.
While it may initially seem like to be a small feature, in practice it turns out to greatly simplify the development of <em>real-time</em> web application features.
The SockJS bridge can actually be useful also in cases where one would have used an HTTP endpoint: sending a message then getting a response over the event bus can sometimes be simpler than doing an HTTP call, having the server process the HTTP request, forwarding it to a verticle on the event bus and eventually terminating the HTTP exchange by encoding a JSON response.</p>
</div>
</div>
<div class="sect2">
<h3 id="_going_further">Going further</h3>
<div class="paragraph">
<p>The <a href="http://vertx.io/">Vert.x website</a> is of course the authority on all things Vert.x.</p>
</div>
<div class="paragraph">
<p>There are many features and modules that we haven&#8217;t covered in this guide, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>clustering using Hazelcast, Infinispan, Apache Ignite or Apache Zookeeper,</p>
</li>
<li>
<p>how the code looks like with other supported languages,</p>
</li>
<li>
<p>exposing and consuming over HTTP/2, possibly (but not necessarily) with gRPC</p>
</li>
<li>
<p>using NoSQL databases such as MongoDB or Redis,</p>
</li>
<li>
<p>sending emails over SMTP,</p>
</li>
<li>
<p>messaging with AMQP, Stomp, Kafka, MQTT or RabbitMQ,</p>
</li>
<li>
<p>using OAuth2 authentication from custom and popular providers,</p>
</li>
<li>
<p>Vert.x sync for writing blocking-style code that is later turned into <em>fibers</em> non-blocking code at runtime,</p>
</li>
<li>
<p>publishing and discovering micro-services from registries, for instance when deploying on cloud environments like OpenShift,</p>
</li>
<li>
<p>exposing metrics and health checks.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This list is not exhaustive: Vert.x is a toolkit so you are the one to decide what ingredients are required for your project, big or small.</p>
</div>
<div class="paragraph">
<p>You may also find it useful to browse the <a href="https://github.com/vert-x3/vertx-awesome">Vert.x awesome</a> curated list of community projects as it goes beyond what is being supported by the project.</p>
</div>
<div class="paragraph">
<p>If you are developing micro-services, we suggest reading the <a href="https://developers.redhat.com/promotions/building-reactive-microservices-in-java/">"Building Reactive Microservices in Java" book by Clément Escoffier</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_that_s_all_folks">That&#8217;s all folks!</h3>
<div class="paragraph">
<p>We hope that you enjoyed reading this guide, and that it turned out to be useful in your journey towards asynchronous programming with Vert.x.</p>
</div>
<div class="paragraph">
<p>Feel-free to get in touch with the authors, either directly by email or through <a href="https://groups.google.com/forum/?fromgroups#!forum/vertx/">the Vert.x project user group</a>.
Of course we appreciate praise, but we appreciate as much any constructive feedback that can improve this content.</p>
</div>
<div class="paragraph">
<p>Thank you very much!</p>
</div>
</div>
</div>
</div>

        
          <div id="footnotes">
          
            <div class="footnote" id="_footnote_1">
              <a href="#_footnoteref_1">1</a>. Note that the widespread usage of the term "real-time" in the context of web technologies shall not be confused with <em>hard</em> or <em>soft</em> real-time in specialized operating systems.
            </div>
          
        </div>
        

        
          <div id="footer">
            <div id="footer-text">
              
                Version 1.0.1<br>
              
                Last updated 2017-07-27 11:46:46 CEST
              
              
            </div>
          </div>
        
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse Vert.x</h2>
        <ul class="list-unstyled">
          <li><a href="http://vertx.io/">Home</a></li>
          <li><a href="http://vertx.io/download/">Download</a></li>
          <li><a href="http://vertx.io/docs/3.4.2/">Documentation</a></li>
          <li><a href="https://github.com/vert-x3/wiki/wiki">Wiki</a></li>
          <li><a href="http://vertx.io/blog/">Blog</a></li>
          <li><a href="http://vertx.io/vertx2/" class="vertx-2-link">Vert.x 2</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Community</h2>
        <ul class="list-unstyled">
          <li><a href="http://vertx.io/community/">Help &amp; Contributors</a></li>
          <li><a href="http://vertx.io/materials/">Learning materials</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx">User Group</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx-dev">Developer Group</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse</h2>
        <ul class="list-unstyled">
          <li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li>
          <li><a href="https://eclipse.org/legal/privacy.php">Privacy Policy</a></li>
          <li><a href="https://eclipse.org/legal/termsofuse.php">Terms of Use</a></li>
          <li><a href="https://eclipse.org/legal/copyright.php">Copyright Agent</a></li>
          <li><a href="http://www.eclipse.org/legal">Legal Resources</a></li>
        </ul>
      </div>

      <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright">
        <p>Eclipse Vert.x is open source and dual licensed under the <a href="https://www.eclipse.org/org/documents/epl-v10.php">Eclipse Public License 1.0</a> and <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License 2.0</a>.</p>
        <p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>
        Design by <a href="https://www.michel-kraemer.com">Michel Kr&auml;mer</a>.</p>
        <div class="row">
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2">
            <a href="http://eclipse.org">
            <img class="logo eclipse-logo" src="http://vertx.io/assets/eclipse_logo_grey_small.png" width="204" height="48">
            </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0">
            <a href="http://cloudbees.com">
            <img class="logo cloudbees-logo" src="http://vertx.io/assets/Button-Built-on-CB-1-grey.png" width="180" height="48">
           </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler">
            <a href="http://www.ej-technologies.com/products/jprofiler/overview.html"
            style="text-decoration:none">
            <img class="logo jprofiler-logo" src="http://vertx.io/assets/jprofiler-logo.png" width="48" height="48"><span class="jprofiler-logo">&nbsp; JPROFILER</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="http://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script>
<script src="http://vertx.io/javascripts/bootstrap.min.js"></script>
<script src="http://vertx.io/javascripts/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script src="http://vertx.io/javascripts/sidebar.js"></script>


</body>
</html>

