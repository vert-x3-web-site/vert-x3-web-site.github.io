<!DOCTYPE html><html lang=en><head><title>Eclipse Vert.x goes Native</title><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name=description><link href=https://vertx.io/stylesheets/main.css media=screen rel=stylesheet><link href=https://vertx.io/stylesheets/font-awesome.min.css media=screen rel=stylesheet><link href=https://vertx.io/javascripts/styles/rainbow.min.css media=screen rel=stylesheet><!--[if lt IE 9]><script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--><link rel=apple-touch-icon sizes=57x57 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png><link rel=icon type=image/png href=https://vertx.io/assets/favicons/vertx-favicon-7/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://vertx.io/assets/favicons/vertx-favicon-7/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=https://vertx.io/assets/favicons/vertx-favicon-7/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=https://vertx.io/assets/favicons/vertx-favicon-7/favicon-16x16.png sizes=16x16><link rel=manifest href=https://vertx.io/assets/favicons/vertx-favicon-7/manifest.json><link rel=mask-icon href=https://vertx.io/assets/favicons/vertx-favicon-7/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content=#7d3194><meta name=msapplication-TileImage content=https://vertx.io/assets/favicons/vertx-favicon-7/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel=stylesheet type=text/css><link rel=alternate type=application/rss+xml title=RSS href=https://vertx.io/feed.xml><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');</script></head><body><a href="http://www.reactivemanifesto.org/" id=reactive-manifesto-banner><img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000" src=https://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png></a> <a id=skippy class="sr-only sr-only-focusable" href=#content><div class=container><span class=skiplink-text>Skip to main content</span></div></a><header class="navbar navbar-default navbar-static-top" id=top role=banner><div class=container><div class=navbar-header><button class="navbar-toggle collapsed" type=button data-toggle=collapse data-target=#vertx-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href="https://vertx.io/" class=navbar-brand><img alt=Brand src=https://vertx.io/assets/logo-sm.png></a></div><nav class="collapse navbar-collapse" id=vertx-navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href="https://start.vertx.io/">Starter</a></li><li><a href="https://vertx.io/download/">Download</a></li><li><a href="https://how-to.vertx.io/">How-to</a></li><li><a href="https://vertx.io/docs/">Documentation</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>Wiki</a></li><li><a href="https://vertx.io/community/">Community</a></li><li><a href="https://vertx.io/materials/">Materials</a></li><li><a href="https://vertx.io/blog/">Blog</a></li></ul></nav></div></header><div class=container><div class="row blog"><article class="col-xs-12 blog-post"><h2 class=blog-post-title>Eclipse Vert.x goes Native</h2><p class=blog-post-meta>4th June 2018 by <a href=http://github.com/jotschi>jotschi</a></p><article><p>I this blog post I would like to give you a preview on native image generation of Vert.x applications using GraalVM.</p><p>With <a href="https://www.graalvm.org/">GraalVM</a> it is possible to generate native executables. These executables can be directly run without the need of an installed JVM.</p><h2 id=benefits>Benefits</h2><ul><li><p>The start up time is way faster. It is no longer required to wait for the start up of the JVM. The application is usually up and running in a matter of milliseconds.</p></li><li><p>Reduced memory footprint. I measured 40 MB memory usage (RSS) for the Vert.x Web application which Iâ€™m going to showcase.</p></li><li><p>Smaller Containers. No JVM means no overhead. All the needed parts are already contained within the executable. This can be very beneficial when building deployable container images.</p></li></ul><h2 id=demo-project>Demo Project</h2><p>For the demo application I choose a very basic hello world <a href="https://vertx.io/docs/vertx-web/java/">Vert.x Web</a> server.</p><pre><code class="hljs java"><span class=hljs-keyword>package</span> de.jotschi.examples;

<span class=hljs-keyword>import</span> java.io.File;

<span class=hljs-keyword>import</span> io.vertx.core.Vertx;
<span class=hljs-keyword>import</span> io.vertx.core.logging.Logger;
<span class=hljs-keyword>import</span> io.vertx.core.logging.LoggerFactory;
<span class=hljs-keyword>import</span> io.vertx.core.logging.SLF4JLogDelegateFactory;
<span class=hljs-keyword>import</span> io.vertx.ext.web.Router;

<span class=hljs-keyword>public</span> <span class=hljs-class><span class=hljs-keyword>class</span> <span class=hljs-title>Runner</span> </span>{

    <span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>static</span> <span class=hljs-keyword>void</span> <span class=hljs-title>main</span><span class=hljs-params>(String[] args)</span> </span>{
        <span class=hljs-comment>// Use logback for logging</span>
        File logbackFile = <span class=hljs-keyword>new</span> File(<span class=hljs-string>"config"</span>, <span class=hljs-string>"logback.xml"</span>);
        System.setProperty(<span class=hljs-string>"logback.configurationFile"</span>, logbackFile.getAbsolutePath());
        System.setProperty(LoggerFactory.LOGGER_DELEGATE_FACTORY_CLASS_NAME, SLF4JLogDelegateFactory.class.getName());
        Logger log = LoggerFactory.getLogger(Runner.class);

        <span class=hljs-comment>// Setup the http server</span>
        log.info(<span class=hljs-string>"Starting server for: http://localhost:8080/hello"</span>);
        Vertx vertx = Vertx.vertx();
        Router router = Router.router(vertx);

        router.route(<span class=hljs-string>"/hello"</span>).handler(rc -&gt; {
            log.info(<span class=hljs-string>"Got hello request"</span>);
            rc.response().end(<span class=hljs-string>"World"</span>);
        });

        vertx.createHttpServer()
            .requestHandler(router::accept)
            .listen(<span class=hljs-number>8080</span>);

    }

}</code></pre><h2 id=graalvm>GraalVM</h2><p><a href="https://www.graalvm.org/">GraalVM</a>runs a static analysis on the generated application in order to find the reachable code. This process which is run within the <a href=https://github.com/oracle/graal/tree/master/substratevm>Substrate VM</a> will lead to the generation of the native image.</p><h3 id=limitations>Limitations</h3><p>Due to the nature of the static analysis Substrate VM also has some <a href=https://github.com/oracle/graal/blob/master/substratevm/LIMITATIONS.md>limitations</a>.</p><p>Dynamic class loading and unloading for example is not supported because this would in essence alter the available code during runtime.</p><p>Reflection is only partially supported and requires some manual steps which we will cover later on.</p><h3 id=patches-workarounds>Patches / Workarounds</h3><p><div class="admonition-block note"><table><tbody><tr><td class=admonition-icon><i class="admonition-icon fa fa-comment"></i></td><td class=content><span class=title>Work in progress</span><br><span class=content>Next we need to apply some patches / workarounds. Keep in mind that native image generation is a fairly new topic and the these workarounds will hopefully no longer be required once the Substrate VM and Netty have better support for each other.</span></td></tr></tbody></table></div></p><p>I did not manage to get native epoll, kqueue and SSL integration to work with native images. These parts are heavily optimized within Netty and use JNI to directly access the OS features. Substrate VM supports JNI and could in theory integrate these native libraries.</p><p>I created a <a href=https://github.com/Jotschi/vertx-graalvm-native-image-test/tree/netty-native-epoll>reproducer</a> and an <a href=https://github.com/oracle/graal/issues/442>issue</a> so hopefully these problems can be addressed soon.</p><h3 id=vert-x-transport>Vert.x Transport</h3><p>First I needed to patch the <code>io.vertx.core.net.impl.transport.Transport</code> class in order to prevent the loading of EPoll and KQueue native support. Otherwise Substrate VM will try to load these classes and fail.</p><pre><code class="hljs java"><span class=hljs-keyword>public</span> <span class=hljs-class><span class=hljs-keyword>class</span> <span class=hljs-title>Transport</span> </span>{
â€¦
  <span class=hljs-javadoc>/**
   * The native transport, it may be {@code null} or failed.
   */</span>
  <span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-keyword>static</span> Transport <span class=hljs-title>nativeTransport</span><span class=hljs-params>()</span> </span>{
    <span class=hljs-comment>// Patched: I remove the native transport discovery. </span>
    <span class=hljs-comment>// The imports would be picked up by substrate </span>
    <span class=hljs-comment>// and cause further issues. </span>
    <span class=hljs-keyword>return</span> <span class=hljs-keyword>null</span>;
  }
â€¦
}</code></pre><h3 id=netty-ssl>Netty SSL</h3><p>Native SSL support is another problematic area. I created a patched dummy <code>io.netty.handler.ssl.ReferenceCountedOpenSslEngine</code> class in order to prevent Substrate VM from digging deeper into the SSL code of Netty.</p><p>Next we need to set up the reflection configuration within <code>reflectconfigs/netty.json</code>.</p><p>Netty uses reflection to instantiate the socket channels. This is done in the ReflectiveChannelFactory. We need to tell Substrate VM how classes of type NioServerSocketChannel and NioSocketChannel can be instantiated.</p><pre><code class=hljs>[
  {
    "<span class=hljs-attribute>name</span>" : <span class=hljs-value><span class=hljs-string>"io.netty.channel.socket.nio.NioSocketChannel"</span></span>,
    "<span class=hljs-attribute>methods</span>" : <span class=hljs-value>[
      { "<span class=hljs-attribute>name</span>" : <span class=hljs-value><span class=hljs-string>"&lt;init&gt;"</span></span>, "<span class=hljs-attribute>parameterTypes</span>" : <span class=hljs-value>[] </span>}
    ]
  </span>},
  {
    "<span class=hljs-attribute>name</span>" : <span class=hljs-value><span class=hljs-string>"io.netty.channel.socket.nio.NioServerSocketChannel"</span></span>,
    "<span class=hljs-attribute>methods</span>" : <span class=hljs-value>[
      { "<span class=hljs-attribute>name</span>" : <span class=hljs-value><span class=hljs-string>"&lt;init&gt;"</span></span>, "<span class=hljs-attribute>parameterTypes</span>" : <span class=hljs-value>[] </span>}
    ]
  </span>}
]</code></pre><p>If you want to learn more about the state of Netty and GraalVM I can recommend this <a href=https://medium.com/graalvm/instant-netty-startup-using-graalvm-native-image-generation-ed6f14ff7692>GraalVM Blogpost</a> by Codrut Stancu.</p><h2 id=building>Building</h2><p>Finally we can build our maven project to generate a shaded jar.</p><pre><code class="hljs bash">mvn clean package</code></pre><p>Next we need the GraalVM package. You can download it from the <a href="https://www.graalvm.org/">GraalVM website</a>.</p><p>We use the shaded jar as the input source for the <code>native-image</code> command which will generate the executable.</p><pre><code class="hljs bash"><span class=hljs-variable>$GRAALVMDIR</span>/bin/native-image \
 --verbose \
 --no-server \
 -Dio.netty.noUnsafe=<span class=hljs-literal>true</span>  \
 -H:ReflectionConfigurationFiles=./reflectconfigs/netty.json \
 -H:+ReportUnsupportedElementsAtRuntime \
 -Dfile.encoding=UTF-<span class=hljs-number>8</span> \
 -jar target/vertx-graalvm-native-image-test-<span class=hljs-number>0.0</span>.<span class=hljs-number>1</span>-SNAPSHOT.jar</code></pre><h2 id=result>Result</h2><p>Finally we end up with an 27 MB <code>vertx-graalvm-native-image-test-0.0.1-SNAPSHOT</code> executable which we can run.</p><pre><code class="hljs bash">$ ldd vertx-graalvm-native-image-test-<span class=hljs-number>0.0</span>.<span class=hljs-number>1</span>-SNAPSHOT 
  linux-vdso.so.<span class=hljs-number>1</span> (<span class=hljs-number>0</span>x00007ffc65be8000)
  libdl.so.<span class=hljs-number>2</span> =&gt; /lib/x86_64-linux-gnu/libdl.so.<span class=hljs-number>2</span> (<span class=hljs-number>0</span>x00007f8e892f0000)
  libpthread.so.<span class=hljs-number>0</span> =&gt; /lib/x86_64-linux-gnu/libpthread.so.<span class=hljs-number>0</span> (<span class=hljs-number>0</span>x00007f8e890d3000)
  libz.so.<span class=hljs-number>1</span> =&gt; /lib/x86_64-linux-gnu/libz.so.<span class=hljs-number>1</span> (<span class=hljs-number>0</span>x00007f8e88eb9000)
  librt.so.<span class=hljs-number>1</span> =&gt; /lib/x86_64-linux-gnu/librt.so.<span class=hljs-number>1</span> (<span class=hljs-number>0</span>x00007f8e88cb1000)
  libcrypt.so.<span class=hljs-number>1</span> =&gt; /lib/x86_64-linux-gnu/libcrypt.so.<span class=hljs-number>1</span> (<span class=hljs-number>0</span>x00007f8e88a79000)
  libc.so.<span class=hljs-number>6</span> =&gt; /lib/x86_64-linux-gnu/libc.so.<span class=hljs-number>6</span> (<span class=hljs-number>0</span>x00007f8e886da000)
  /lib64/ld-linux-x86-<span class=hljs-number>64</span>.so.<span class=hljs-number>2</span> (<span class=hljs-number>0</span>x00007f8e8afb7000)</code></pre><h3 id=memory>Memory</h3><pre><code class="hljs bash">/usr/bin/time <span class=hljs-operator>-f</span> <span class=hljs-string>"\nmaxRSS\t%MkB"</span> java -jar target/vertx-graalvm-native-image-test-<span class=hljs-number>0.0</span>.<span class=hljs-number>1</span>-SNAPSHOT.jar 
/usr/bin/time <span class=hljs-operator>-f</span> <span class=hljs-string>"\nmaxRSS\t%MkB"</span> ./vertx-graalvm-native-image-test-<span class=hljs-number>0.0</span>.<span class=hljs-number>1</span>-SNAPSHOT</code></pre><ul><li>Native Image: 40 MB</li><li>Java 10: 125 MB</li></ul><p>The full project can be found on <a href=https://github.com/Jotschi/vertx-graalvm-native-image-test>GitHub</a>.</p><p>If you want to read more on the topic I can also recommend <a href=https://sites.google.com/a/athaydes.com/renato-athaydes/posts/a7mbnative-imagejavaappthatrunsin30msandusesonly4mbofram>this article</a> by Renato Athaydes in which he demonstrates how to create a very small light weight low memory application using GraalVM.</p><p>Thanks for reading. If you have any further questions or feedback donâ€™t hesitate to send me a tweet to <a href="https://twitter.com/Jotschi/">@Jotschi</a>.</p></article></article></div></div><footer><div class=container><div class=row><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse Vert.x</h2><ul class=list-unstyled><li><a href="https://vertx.io/">Home</a></li><li><a href="https://vertx.io/download/">Download</a></li><li><a href="https://vertx.io/docs/">Documentation</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>Wiki</a></li><li><a href="https://vertx.io/blog/">Blog</a></li><li><a href="https://vertx.io/vertx2/" class=vertx-2-link>Vert.x 2</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Community</h2><ul class=list-unstyled><li><a href="https://vertx.io/community/">Help &amp; Contributors</a></li><li><a href="https://vertx.io/materials/">Learning materials</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx>User Group</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx-dev>Developer Group</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse</h2><ul class=list-unstyled><li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li><li><a href=https://eclipse.org/legal/privacy.php>Privacy Policy</a></li><li><a href=https://eclipse.org/legal/termsofuse.php>Terms of Use</a></li><li><a href=https://eclipse.org/legal/copyright.php>Copyright Agent</a></li><li><a href=http://www.eclipse.org/legal>Legal Resources</a></li></ul></div><div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright"><p>Eclipse Vert.x is open source and dual-licensed under the <a href=http://www.eclipse.org/legal/epl-v20.html>Eclipse Public License 2.0</a> and <a href=https://www.apache.org/licenses/LICENSE-2.0.html>Apache License 2.0</a>.</p><p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>Design by <a href=https://www.michel-kraemer.com>Michel Kr&auml;mer</a>.</p><div class=row><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2"><a href=http://eclipse.org><img class="logo eclipse-logo" src=https://vertx.io/assets/eclipse_logo_grey_small.png width=204 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0"><a href=http://cloudbees.com><img class="logo cloudbees-logo" src=https://vertx.io/assets/Button-Built-on-CB-1-grey.png width=180 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler"><a href=http://www.ej-technologies.com/products/jprofiler/overview.html style=text-decoration:none><img class="logo jprofiler-logo" src=https://vertx.io/assets/jprofiler-logo.png width=48 height=48><span class=jprofiler-logo>&nbsp; JPROFILER</span></a></div></div></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://vertx.io/javascripts/bootstrap.min.js></script><script src=https://vertx.io/javascripts/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=stylesheet type=text/css href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css"><script src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js></script><script>window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});</script></body></html>