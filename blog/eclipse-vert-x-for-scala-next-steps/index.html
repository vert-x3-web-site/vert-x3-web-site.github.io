<!DOCTYPE html><html lang=en><head><title>Eclipse Vert.x for Scala next steps</title><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name=description><link href=https://vertx.io/stylesheets/main.css media=screen rel=stylesheet><link href=https://vertx.io/stylesheets/font-awesome.min.css media=screen rel=stylesheet><link href=https://vertx.io/javascripts/styles/rainbow.min.css media=screen rel=stylesheet><!--[if lt IE 9]><script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--><link rel=apple-touch-icon sizes=57x57 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png><link rel=icon type=image/png href=https://vertx.io/assets/favicons/vertx-favicon-7/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://vertx.io/assets/favicons/vertx-favicon-7/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=https://vertx.io/assets/favicons/vertx-favicon-7/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=https://vertx.io/assets/favicons/vertx-favicon-7/favicon-16x16.png sizes=16x16><link rel=manifest href=https://vertx.io/assets/favicons/vertx-favicon-7/manifest.json><link rel=mask-icon href=https://vertx.io/assets/favicons/vertx-favicon-7/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content=#7d3194><meta name=msapplication-TileImage content=https://vertx.io/assets/favicons/vertx-favicon-7/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel=stylesheet type=text/css><link rel=alternate type=application/rss+xml title=RSS href=https://vertx.io/feed.xml><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');</script></head><body><a href=https://vertx-web-site.github.io><img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000" src=https://vertx.io/assets/beta-ribbon.svg width=140px></a> <a id=skippy class="sr-only sr-only-focusable" href=#content><div class=container><span class=skiplink-text>Skip to main content</span></div></a><header class="navbar navbar-default navbar-static-top" id=top role=banner><div class=container><div class=navbar-header><button class="navbar-toggle collapsed" type=button data-toggle=collapse data-target=#vertx-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href="https://vertx.io/" class=navbar-brand><img alt=Brand src=https://vertx.io/assets/logo-sm.png></a></div><nav class="collapse navbar-collapse" id=vertx-navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href="https://start.vertx.io/">Starter</a></li><li><a href="https://vertx.io/download/">Download</a></li><li><a href="https://how-to.vertx.io/">How-to</a></li><li><a href="https://vertx.io/docs/">Documentation</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>Wiki</a></li><li><a href="https://vertx.io/community/">Community</a></li><li><a href="https://vertx.io/materials/">Materials</a></li><li><a href="https://vertx.io/blog/">Blog</a></li></ul></nav></div></header><div class=container><div class="row blog"><article class="col-xs-12 blog-post"><h2 class=blog-post-title>Eclipse Vert.x for Scala next steps</h2><p class=blog-post-meta>30th August 2019 by <a href=http://github.com/codepitbull>codepitbull</a></p><article><h1 id=scala-for-eclipse-vert-x-the-next-steps>Scala for Eclipse Vert.x: The next steps</h1><h2 id=tl-dr>TL;DR</h2><ul><li>No Scala 2.13 in Eclipse Vert.x 3.x due to increased support burden</li><li>New value classes based approach for Vert.x 4</li></ul><h2 id=retrospective>Retrospective</h2><p>It’s been more than two years since the inception of <code>vert-lang-scala</code> to the Vert.x ecosystem. And almost as long since I wrote my first <a href="https://vertx.io/blog/scala-is-here/">blog post</a> about it.</p><p>A lot has happened since March 2017:</p><ul><li><code>vertx-lang-scala</code> kept up with new versions of Scala</li><li>all Vert.x-modules are supported (35 so far)</li><li>a Giter8 based <a href=https://github.com/vert-x3/vertx-scala.g8>template</a> was added for easily bootstrapping a Vert.x-Scala-project</li><li>Bugs were squashed</li></ul><p>And most recently we received a great contribution by <a href=https://github.com/NikolajLeischner>Nikolaj Leischner</a> who was kind enough to port the <a href=https://github.com/TechEmpower/FrameworkBenchmarks/tree/master/frameworks/Scala/vertx-web-scala>techempowered</a> benchmark to vert-lang-scala. Which will be part of the next steps.</p><p>The numbers produced by this benchmark were very promising and and additional motivation to move to the next phase of Scala support for Vert.x.</p><h2 id=old-idea>Old idea</h2><p>Before getting to the new ideas I want to take a look at the “old” one.</p><p>The current version of vert-lang-scala is based around the idea of wrapping the Vert.x-API with a dedicated Scala-layer. That layer is created using a Freemarker-based code generator. I took this idea from the first try by Tim Fox for building that support.</p><p>Wrapping the existing Java-API was rather painful but gave me great flexibility to create an idiomatic Scala-API.</p><p>But an approach like that comes with a price:</p><ul><li>There are a lot of intermediate objects being created.</li><li>Many unneccessary conversions between Java/Scala types</li></ul><p>Both increased memory consumption and garbage collection activity quite a bit and has been bugging me from the beginning.</p><h2 id=new-idea>New idea</h2><p>With Vert.x 4 approaching I was finally able to invest time into the rework I had wanted to do for quite a while.</p><p>The core idea is to replace the current wrapping based approach with something more lightweight but native to the Scala-world.</p><p>And that’s where <a href=https://docs.scala-lang.org/overviews/core/value-classes.html>value classes</a> come in.</p><p>Value classes allow the extension of existing classes with additional methods. They make it easy to control <strong>when</strong> methods become visible and do that with a minimum of overhead. To be precise: A wrapping class is normally ever only instantiated <strong>once</strong>.</p><p>A good example is the addition of methods for wrapping the Vert.x approach of Promises with Scala-Futures. Each method returning a Vert.x-Promise needs to receive an alternative version which returns a Scala-Future.</p><p>In Vert.x 3 I achieved that by adding methods to the wrapper and giving them a distinct name. A method called <strong>listen</strong> returning a Promise would receive a companion called <strong>listenFuture</strong> in the Scala layer.</p><p>Let’s look at how this looks in the new approach:</p><pre><code class="hljs scala"><span class=hljs-keyword>package</span> io.vertx.scala
<span class=hljs-keyword>package</span> <span class=hljs-class><span class=hljs-keyword>object</span> <span class=hljs-title>core</span>{</span>
   <span class=hljs-keyword>implicit</span> <span class=hljs-class><span class=hljs-keyword>class</span> <span class=hljs-title>HttpServerScala</span>(</span><span class=hljs-function><span class=hljs-keyword>val</span> <span class=hljs-title>asJava</span>:</span> io.vertx.core.http.<span class=hljs-type>HttpServer</span>) <span class=hljs-keyword>extends</span> <span class=hljs-type>AnyVal</span> {
      <span class=hljs-function><span class=hljs-keyword>def</span> <span class=hljs-title>listenFuture</span>(</span>port: java.lang.<span class=hljs-type>Integer</span>): scala.concurrent.<span class=hljs-type>Future</span>[io.vertx.core.http.<span class=hljs-type>HttpServer</span>] = {..}
      ..
}</code></pre><p>The code above does the following things:</p><ul><li>It creates a package object for <strong>io.vertx.scala.core</strong></li><li>it adds an implict class <strong>HttpServerScala</strong> to wrpa <strong>HttpServer</strong></li><li>it adds a <strong>listenFuture</strong> method</li></ul><p>Using this method in code looks like this:</p><pre><code class="hljs scala"><span class=hljs-keyword>package</span> io.vertx.scala.demo

<span class=hljs-keyword>import</span> io.vertx.lang.scala.<span class=hljs-type>VertxExecutionContext</span>
<span class=hljs-keyword>import</span> io.vertx.scala.core._

<span class=hljs-keyword>import</span> scala.util.{<span class=hljs-type>Failure</span>, <span class=hljs-type>Success</span>}

<span class=hljs-class><span class=hljs-keyword>object</span> <span class=hljs-title>Main</span> {</span>
  <span class=hljs-function><span class=hljs-keyword>def</span> <span class=hljs-title>main</span>(</span>args: <span class=hljs-type>Array</span>[<span class=hljs-type>String</span>]): <span class=hljs-type>Unit</span> = {
    <span class=hljs-function><span class=hljs-keyword>val</span> <span class=hljs-title>vertx</span> =</span> <span class=hljs-type>Vertx</span>.vertx()
    <span class=hljs-keyword>implicit</span> <span class=hljs-function><span class=hljs-keyword>val</span> <span class=hljs-title>ec</span> =</span> <span class=hljs-type>VertxExecutionContext</span>(vertx.getOrCreateContext())
    vertx
      .createHttpServer()
      .requestHandler(r =&gt; {
        r.response().end(<span class=hljs-string>"bye"</span>)
      })
      .listenFuture(<span class=hljs-number>6667</span>)
      .onComplete {
        <span class=hljs-keyword>case</span> <span class=hljs-type>Success</span>(_) =&gt; println(<span class=hljs-string>"Started"</span>)
        <span class=hljs-keyword>case</span> <span class=hljs-type>Failure</span>(exception) =&gt; println(<span class=hljs-string>"Failure"</span>)
      }
  }
}</code></pre><p>Importing the package object using <strong>import io.vertx.scala.core._</strong> brings the extension method into scope and makes them available on all instances of <strong>HttpServer</strong>. In the example above <strong>createHttpServer()</strong> return such an instance and we can now use the idiomatic Scala way of handling a Future.</p><h3 id=even-more>Even more</h3><p>Extending classes with Future-methods is only one of the new things to come. On top of that the support for DataObjects will be considerably improved, both through extending them and by providing type aliases.</p><p>I also switched from doing all conversions for collections automatically to handing the control back to the user. Something which gets even more important for Scala 2.13 and the new collection API.</p><h3 id=the-downside>The downside</h3><p>The clear downside of this approach is that the Java-methods will stay visible since the java-classes won’t be wrapped but extended. This might lead to some confusion but I am pretty sure the benefits outweight this downside.</p><p>The bigger change will be the removal of automatic vonversion between Scala types (Long/Int/String and Collections) and their Java counterparts. I spent considerable time trying to tune that part in the current version bbut always ended up hitting some edgecase. For now I’ve decided to have the user pick the right time to convert.</p><p>I might still add this feature in a later version if user feedback points into that direction.</p><h2 id=when-will-i-get-it->When will I get it?</h2><p>First for the good news: There is already a <a href=https://github.com/vert-x3/vertx-lang-scala/tree/4.0>branch</a> with a full implementation.</p><p>The bad news: It will break until Vert.x 4.0 is finally released.</p><p>Vert.x 4 is in active development with most APIs already finalized but breaking changes still happen. So use at your own risk!</p><h2 id=what-about-scala-2-13->What about Scala 2.13?</h2><p>Scala 2.13 has been released recently which prompted questions from the community about when it will be supported by Vert.x.</p><p>I haven’t done a good job providing the results of our internal discussions on that topic to the community. So here we go:</p><ul><li>Vert.x 3 will stay on 2.12 for the following reasons:<ul><li>Both are still actively supported</li><li>Scala ecosystems takes some time to do the switch to 2.13</li><li>We simply don’t have the capacity to support both versions <strong>AND</strong> the upcoming new version</li></ul></li><li>Vert.x 4 will receive 2.13 support<ul><li>Scala ecosystem will have moved closer to 2.13 adoption when Vert.x 4 comes out</li></ul></li></ul><h2 id=for-the-adventure-seaker>For the adventure seaker</h2><p>I actually did a port of vertx-lang-scala 3.8 to Scala 2.13 and you can grab the work in this <a href=https://github.com/vert-x3/vertx-lang-scala/tree/3.8_2.13>branch</a>.</p><p>Don’t expect <strong>ANY</strong> support for this branch. This was only an experiment to see how much I had to change for initial 2.13 support.</p><h2 id=summary>Summary</h2><p>Vert.x 4 will be an evolutionary step for vertx-lang-scala. Value classes promise to reduce both complexity and allocation rate, two things which have been bugging me quite a bit with the current approach.</p><p>I am eager to hear from you all what you think about this new direction.</p></article></article></div></div><footer><div class=container><div class=row><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse Vert.x</h2><ul class=list-unstyled><li><a href="https://vertx.io/">Home</a></li><li><a href="https://vertx.io/download/">Download</a></li><li><a href="https://vertx.io/docs/">Documentation</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>Wiki</a></li><li><a href="https://vertx.io/blog/">Blog</a></li><li><a href="https://vertx.io/vertx2/" class=vertx-2-link>Vert.x 2</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Community</h2><ul class=list-unstyled><li><a href="https://vertx.io/community/">Help &amp; Contributors</a></li><li><a href="https://vertx.io/materials/">Learning materials</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx>User Group</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx-dev>Developer Group</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse</h2><ul class=list-unstyled><li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li><li><a href=https://eclipse.org/legal/privacy.php>Privacy Policy</a></li><li><a href=https://eclipse.org/legal/termsofuse.php>Terms of Use</a></li><li><a href=https://eclipse.org/legal/copyright.php>Copyright Agent</a></li><li><a href=http://www.eclipse.org/legal>Legal Resources</a></li></ul></div><div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright"><p>Eclipse Vert.x is open source and dual-licensed under the <a href=http://www.eclipse.org/legal/epl-v20.html>Eclipse Public License 2.0</a> and <a href=https://www.apache.org/licenses/LICENSE-2.0.html>Apache License 2.0</a>.</p><p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>Design by <a href=https://www.michel-kraemer.com>Michel Kr&auml;mer</a>.</p><div class=row><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2"><a href=http://eclipse.org><img class="logo eclipse-logo" src=https://vertx.io/assets/eclipse_logo_grey_small.png width=204 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0"><a href=http://cloudbees.com><img class="logo cloudbees-logo" src=https://vertx.io/assets/Button-Built-on-CB-1-grey.png width=180 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler"><a href=http://www.ej-technologies.com/products/jprofiler/overview.html style=text-decoration:none><img class="logo jprofiler-logo" src=https://vertx.io/assets/jprofiler-logo.png width=48 height=48><span class=jprofiler-logo>&nbsp; JPROFILER</span></a></div></div></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://vertx.io/javascripts/bootstrap.min.js></script><script src=https://vertx.io/javascripts/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=stylesheet type=text/css href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css"><script src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js></script><script>window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});</script></body></html>