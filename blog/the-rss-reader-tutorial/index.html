<!DOCTYPE html><html lang=en><head><title>The RSS reader tutorial</title><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta content="width=device-width,initial-scale=1" name=viewport><meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name=description><link href=https://vertx.io/stylesheets/main.css media=screen rel=stylesheet><link href=https://vertx.io/stylesheets/font-awesome.min.css media=screen rel=stylesheet><link href=https://vertx.io/javascripts/styles/rainbow.min.css media=screen rel=stylesheet><!--[if lt IE 9]><script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--><link rel=apple-touch-icon sizes=57x57 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=https://vertx.io/assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png><link rel=icon type=image/png href=https://vertx.io/assets/favicons/vertx-favicon-7/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://vertx.io/assets/favicons/vertx-favicon-7/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=https://vertx.io/assets/favicons/vertx-favicon-7/favicon-96x96.png sizes=96x96><link rel=icon type=image/png href=https://vertx.io/assets/favicons/vertx-favicon-7/favicon-16x16.png sizes=16x16><link rel=manifest href=https://vertx.io/assets/favicons/vertx-favicon-7/manifest.json><link rel=mask-icon href=https://vertx.io/assets/favicons/vertx-favicon-7/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content=#7d3194><meta name=msapplication-TileImage content=https://vertx.io/assets/favicons/vertx-favicon-7/mstile-144x144.png><meta name=theme-color content=#ffffff><link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel=stylesheet type=text/css><link rel=alternate type=application/rss+xml title=RSS href=https://vertx.io/feed.xml><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');</script></head><body><a href=https://vertx-web-site.github.io><img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000" src=https://vertx.io/assets/beta-ribbon.svg width=140px></a> <a id=skippy class="sr-only sr-only-focusable" href=#content><div class=container><span class=skiplink-text>Skip to main content</span></div></a><header class="navbar navbar-default navbar-static-top" id=top role=banner><div class=container><div class=navbar-header><button class="navbar-toggle collapsed" type=button data-toggle=collapse data-target=#vertx-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href="https://vertx.io/" class=navbar-brand><img alt=Brand src=https://vertx.io/assets/logo-sm.png></a></div><nav class="collapse navbar-collapse" id=vertx-navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href="https://start.vertx.io/">Starter</a></li><li><a href="https://vertx.io/download/">Download</a></li><li><a href="https://how-to.vertx.io/">How-to</a></li><li><a href="https://vertx.io/docs/">Documentation</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>Wiki</a></li><li><a href="https://vertx.io/community/">Community</a></li><li><a href="https://vertx.io/materials/">Materials</a></li><li><a href="https://vertx.io/blog/">Blog</a></li></ul></nav></div></header><div class=container><div class="row blog"><article class="col-xs-12 blog-post"><h2 class=blog-post-title>The RSS reader tutorial</h2><p class=blog-post-meta>20th August 2018 by <a href=http://github.com/Sammers21>Sammers21</a></p><article><h1 id=the-rss-reader-tutorial>The RSS reader tutorial</h1><p>This tutorial is dedicated for users who’d like to know how to use the Eclipse Vert.x Cassandra client with in practice.</p><h1 id=before-you-start-this-tutorial>Before you start this tutorial</h1><p>Before starting, you should :</p><ul><li><p>be familiar with <a href="https://vertx.io/">Eclipse Vert.x</a>. If you are not, here is the <a href="https://vertx.io/docs/guide-for-java-devs/">guide for Java developers</a>.</p></li><li><p>have some basic understanding of databases. Extended knowledge of Cassandra is not required.</p></li></ul><p>You also may find it useful to read <a href=https://validator.w3.org/feed/docs/rss2.html>the RSS 2.0</a> specification, because the resulted app is, basically, a storage of RSS 2.0 feeds.</p><p>To give you an idea of what the App is about, here is how it looks like from the fronted side:</p><p><img src=https://i.imgur.com/2V954zx.png alt="see how it looks"></p><p>On the image we see that browser space is split into 2 parts:</p><ol><li>Saved feed names</li><li>List of articles for the selected feed</li></ol><p>Here you also can enter a link to a new feed, so the App will fetch and parse the feed. After that, it will appear in the left column along with other saved feeds.</p><h1 id=requirements>Requirements</h1><p>For completing this tutorial you need:</p><ul><li>Java 8 or higher</li><li>Git</li><li>1 hour of your time</li><li>You favorite code editor</li></ul><p>For running the example you should ensure that Cassandra service is running locally on port 9042. As an option, you can run Cassandra with <a href=https://github.com/riptano/ccm#installation>ccm</a>(Cassandra Cluster Manager). Follow <a href=https://github.com/riptano/ccm#installation>this</a> instructions for installing ccm. After installing you will be able to run a single node cluster:</p><pre><code class="hljs bash">ccm create rss_reader -v <span class=hljs-number>3.11</span>.<span class=hljs-number>2</span> -n <span class=hljs-number>1</span> <span class=hljs-operator>-s</span>
ccm start</code></pre><p>Before completing this step make sure that you have successfully cloned the RSS reader repository and checked out the <code>step_1</code> branch:</p><pre><code class="hljs bash">git clone https://github.com/Sammers21/rss-reader
<span class=hljs-built_in>cd</span> rss-reader
git checkout step_1</code></pre><p>Now you can try to tun this example and see if it works:</p><pre><code class="hljs bash">./gradlew vertxRun</code></pre><h2 id=schema>Schema</h2><p>If you are familiar with <a href="http://cassandra.apache.org/">Apache Cassandra</a> you should know that the way your data is stored in Cassandra is dependent on queries you are running. It means that you need first to figure out what kind of queries you will be running, and then you can produce a storage scheme.</p><p>In our case we’d like our application to have 3 endpoints:</p><ol><li><code>POST /user/{user_id}/rss_link</code> - for adding links to a user’s feed</li><li><code>GET /user/{user_id}/rss_channels</code> - for retrieving information about RSS channels a user subscribed on</li><li><code>GET /articles/by_rss_link?link={rss_link}</code> - for retrieving information about articles on a specific RSS channel</li></ol><p>For implementing this endpoints the schema should look in this way:</p><pre><code class=hljs><span class=hljs-operator><span class=hljs-keyword>CREATE</span> <span class=hljs-keyword>TABLE</span> rss_by_user (login <span class=hljs-built_in>text</span> , rss_link <span class=hljs-built_in>text</span>, <span class=hljs-keyword>PRIMARY</span> <span class=hljs-keyword>KEY</span> (login, rss_link));</span>
<span class=hljs-operator><span class=hljs-keyword>CREATE</span> <span class=hljs-keyword>TABLE</span> articles_by_rss_link(rss_link <span class=hljs-built_in>text</span>, pubDate <span class=hljs-keyword>timestamp</span>, title <span class=hljs-built_in>text</span>, article_link <span class=hljs-built_in>text</span>, description <span class=hljs-built_in>text</span>, <span class=hljs-keyword>PRIMARY</span> <span class=hljs-keyword>KEY</span> ( rss_link , pubDate , article_link));</span>
<span class=hljs-operator><span class=hljs-keyword>CREATE</span> <span class=hljs-keyword>TABLE</span> channel_info_by_rss_link(rss_link <span class=hljs-built_in>text</span>, last_fetch_time <span class=hljs-keyword>timestamp</span>,title <span class=hljs-built_in>text</span>, site_link <span class=hljs-built_in>text</span>, description <span class=hljs-built_in>text</span>, <span class=hljs-keyword>PRIMARY</span> <span class=hljs-keyword>KEY</span>(rss_link));</span></code></pre><h2 id=what-to-do-in-this-step>What to do in this step</h2><p>In this step we will implement only the first endpoint</p><h2 id=project-overview>Project overview</h2><p>There are two notable classes in the project: <code>AppVerticle</code> and <code>FetchVerticle</code>. The first one is a <a href=https://vertx.io/docs/vertx-core/java/#_verticles>Verticle</a> responsible for HTTP request handling and storage schema initialization. The second one is a <a href=https://vertx.io/docs/vertx-core/java/#_verticles>Verticle</a> as well, but responsible for RSS feeds fetching.</p><p>The idea is simple. When the application is starting the <code>AppVerticle</code> is deployed, then it tries to initialize storage schema, described in <code>src/main/resources/schema.cql</code> file by reading it and executing listed queries line by line. After the schema initialization the <code>AppVerticle</code> deploys <code>FetchVerticle</code> and starts a HTTP server.</p><h2 id=implementing-the-endpoint>Implementing the endpoint</h2><p>Now, it is time to implement the first endpoint. Pay attention to <code>TODO</code>s, they are for pointing you out about where changes should be made.</p><p>Now, let’s have a look at the <code>AppVerticle#postRssLink</code> method. This method is called each time the first endpoint is called, so we can figure out what is the posted body and id of the user, who performed the request, directly there. There are 2 main things we want to do in this method:</p><ol><li>Notifying via the <a href=https://vertx.io/docs/vertx-core/java/#event_bus>Event Bus</a> the <code>FetchVerticle</code> to fetch given by user link link to an RSS feed.</li><li>Inserting an entry to the <code>rss_by_user</code> table.</li></ol><p>This is how the <code>AppVerticle#postRssLink</code> method should be implemented:</p><pre><code class="hljs java"><span class=hljs-function><span class=hljs-keyword>private</span> <span class=hljs-keyword>void</span> <span class=hljs-title>postRssLink</span><span class=hljs-params>(RoutingContext ctx)</span> </span>{
    ctx.request().bodyHandler(body -&gt; {
        JsonObject bodyAsJson = body.toJsonObject();
        String link = bodyAsJson.getString(<span class=hljs-string>"link"</span>);
        String userId = ctx.request().getParam(<span class=hljs-string>"user_id"</span>);
        <span class=hljs-keyword>if</span> (link == <span class=hljs-keyword>null</span> || userId == <span class=hljs-keyword>null</span>) {
            responseWithInvalidRequest(ctx);
        } <span class=hljs-keyword>else</span> {
            vertx.eventBus().send(<span class=hljs-string>"fetch.rss.link"</span>, link);
            Future&lt;ResultSet&gt; future = Future.future();
            BoundStatement query = insertNewLinkForUser.bind(userId, link);
            client.execute(query, future);
            future.setHandler(result -&gt; {
                <span class=hljs-keyword>if</span> (result.succeeded()) {
                    ctx.response().end(<span class=hljs-keyword>new</span> JsonObject().put(<span class=hljs-string>"message"</span>, <span class=hljs-string>"The feed just added"</span>).toString());
                } <span class=hljs-keyword>else</span> {
                    ctx.response().setStatusCode(<span class=hljs-number>400</span>).end(result.cause().getMessage());
                }
            });
        }
    });
}

<span class=hljs-function><span class=hljs-keyword>private</span> <span class=hljs-keyword>void</span> <span class=hljs-title>responseWithInvalidRequest</span><span class=hljs-params>(RoutingContext ctx)</span> </span>{
    ctx.response()
            .setStatusCode(<span class=hljs-number>400</span>)
            .putHeader(<span class=hljs-string>"content-type"</span>, <span class=hljs-string>"application/json; charset=utf-8"</span>)
            .end(invalidRequest().toString());
}

<span class=hljs-function><span class=hljs-keyword>private</span> JsonObject <span class=hljs-title>invalidRequest</span><span class=hljs-params>()</span> </span>{
    <span class=hljs-function><span class=hljs-keyword>return</span> <span class=hljs-keyword>new</span> <span class=hljs-title>JsonObject</span><span class=hljs-params>()</span>.<span class=hljs-title>put</span><span class=hljs-params>(<span class=hljs-string>"message"</span>, <span class=hljs-string>"Invalid request"</span>)</span></span>;
}</code></pre><p>You may notice that <code>insertNewLinkForUser</code> is a <code>PreparedStatement</code>, and should be initialized before the <code>AppVerticle</code> start. Let’s do it in the <code>AppVerticle#prepareNecessaryQueries</code> method:</p><pre><code class="hljs java"><span class=hljs-function><span class=hljs-keyword>private</span> Future&lt;Void&gt; <span class=hljs-title>prepareNecessaryQueries</span><span class=hljs-params>()</span> </span>{
    Future&lt;PreparedStatement&gt; insertNewLinkForUserPrepFuture = Future.future();
    client.prepare(<span class=hljs-string>"INSERT INTO rss_by_user (login , rss_link ) VALUES ( ?, ?);"</span>, insertNewLinkForUserPrepFuture);

    <span class=hljs-keyword>return</span> insertNewLinkForUserPrepFuture.compose(preparedStatement -&gt; {
        insertNewLinkForUser = preparedStatement;
        <span class=hljs-keyword>return</span> Future.succeededFuture();
    });
}</code></pre><p>Also, we should not forget to fetch a RSS by the link sent to <code>FetchVerticle</code> via the Event Bus. We can do it in the <code>FetchVerticle#startFetchEventBusConsumer</code> method:</p><pre><code class="hljs java">vertx.eventBus().localConsumer(<span class=hljs-string>"fetch.rss.link"</span>, message -&gt; {
    String rssLink = (String) message.body();
    log.info(<span class=hljs-string>"fetching "</span> + rssLink);
    webClient.getAbs(rssLink).send(response -&gt; {
        <span class=hljs-keyword>if</span> (response.succeeded()) {
            String bodyAsString = response.result().bodyAsString(<span class=hljs-string>"UTF-8"</span>);
            <span class=hljs-keyword>try</span> {
                RssChannel rssChannel = <span class=hljs-keyword>new</span> RssChannel(bodyAsString);

                BatchStatement batchStatement = <span class=hljs-keyword>new</span> BatchStatement();
                BoundStatement channelInfoInsertQuery = insertChannelInfo.bind(
                        rssLink, <span class=hljs-keyword>new</span> Date(System.currentTimeMillis()), rssChannel.description, rssChannel.link, rssChannel.title
                );
                batchStatement.add(channelInfoInsertQuery);

                <span class=hljs-keyword>for</span> (Article article : rssChannel.articles) {
                    batchStatement.add(insertArticleInfo.bind(rssLink, article.pubDate, article.link, article.description, article.title));
                }
                Future&lt;ResultSet&gt; insertArticlesFuture = Future.future();
                cassandraClient.execute(batchStatement, insertArticlesFuture);

                insertArticlesFuture.compose(insertDone -&gt; Future.succeededFuture());
            } <span class=hljs-keyword>catch</span> (Exception e) {
                log.error(<span class=hljs-string>"Unable to fetch: "</span> + rssLink, e);
            }
        } <span class=hljs-keyword>else</span> {
            log.error(<span class=hljs-string>"Unable to fetch: "</span> + rssLink);
        }
    });
});</code></pre><p>And, finally, this code would not work if <code>insertChannelInfo</code> and <code>insertArticleInfo</code> statements will not be initialized at verticle start. Let’s to this in the <code>FetchVerticle#prepareNecessaryQueries</code> method:</p><pre><code class="hljs java"><span class=hljs-function><span class=hljs-keyword>private</span> Future&lt;Void&gt; <span class=hljs-title>prepareNecessaryQueries</span><span class=hljs-params>()</span> </span>{
        Future&lt;PreparedStatement&gt; insertChannelInfoPrepFuture = Future.future();
        cassandraClient.prepare(<span class=hljs-string>"INSERT INTO channel_info_by_rss_link ( rss_link , last_fetch_time, description , site_link , title ) VALUES (?, ?, ?, ?, ?);"</span>, insertChannelInfoPrepFuture);

        Future&lt;PreparedStatement&gt; insertArticleInfoPrepFuture = Future.future();
        cassandraClient.prepare(<span class=hljs-string>"INSERT INTO articles_by_rss_link ( rss_link , pubdate , article_link , description , title ) VALUES ( ?, ?, ?, ?, ?);"</span>, insertArticleInfoPrepFuture);

        <span class=hljs-keyword>return</span> CompositeFuture.all(
                insertChannelInfoPrepFuture.compose(preparedStatement -&gt; {
                    insertChannelInfo = preparedStatement;
                    <span class=hljs-keyword>return</span> Future.succeededFuture();
                }), insertArticleInfoPrepFuture.compose(preparedStatement -&gt; {
                    insertArticleInfo = preparedStatement;
                    <span class=hljs-keyword>return</span> Future.succeededFuture();
                })
        ).mapEmpty();
    }</code></pre><h1 id=observing>Observing</h1><p>After all this changes you should ensure that the first endpoint is working correctly. So you need to run the application, go to localhost:8080 insert a link to a rss feed there(<a href=http://feeds.bbci.co.uk/news/uk/rss.xml>BBC UK feed news</a> for example) and then click the <em>ENTER</em> button. Now you can connect to your local Cassandra instance, for instance with <a href=https://docs.datastax.com/en/cql/3.3/cql/cql_reference/cqlsh.html>cqlsh</a>, and find out how RSS feed data had been saved in the rss_reader keyspace:</p><pre><code class="hljs sh">cqlsh&gt; SELECT * FROM rss_reader.rss_by_user limit <span class=hljs-number>1</span>  ;

 login | rss_link
-------+-----------------------------------------
 Pavel | http://feeds.bbci.co.uk/news/uk/rss.xml

(<span class=hljs-number>1</span> rows)
cqlsh&gt; SELECT description FROM rss_reader.articles_by_rss_link  limit <span class=hljs-number>1</span>;

 description
-------------------------------------
 BBC coverage of latest developments

(<span class=hljs-number>1</span> rows)</code></pre><h1 id=conclusion>Conclusion</h1><p>In this article we figured out how to implement the first endpoint of RSS-reader app. If you have any problems with completing this step you can checkout to <code>step_2</code>, where you can find all changes made for completing this step:</p><pre><code class="hljs bash">git checkout step_2</code></pre><p>Thanks for reading this. I hope you enjoyed reading this article. See you soon on our <a href=https://gitter.im/eclipse-vertx/vertx-users>Gitter channel</a>!</p></article></article></div></div><footer><div class=container><div class=row><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse Vert.x</h2><ul class=list-unstyled><li><a href="https://vertx.io/">Home</a></li><li><a href="https://vertx.io/download/">Download</a></li><li><a href="https://vertx.io/docs/">Documentation</a></li><li><a href=https://github.com/vert-x3/wiki/wiki>Wiki</a></li><li><a href="https://vertx.io/blog/">Blog</a></li><li><a href="https://vertx.io/vertx2/" class=vertx-2-link>Vert.x 2</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Community</h2><ul class=list-unstyled><li><a href="https://vertx.io/community/">Help &amp; Contributors</a></li><li><a href="https://vertx.io/materials/">Learning materials</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx>User Group</a></li><li><a href=https://groups.google.com/forum/?fromgroups#!forum/vertx-dev>Developer Group</a></li></ul></div><div class="col-xs-4 col-sm-4 col-md-2 col-lg-2"><h2>Eclipse</h2><ul class=list-unstyled><li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li><li><a href=https://eclipse.org/legal/privacy.php>Privacy Policy</a></li><li><a href=https://eclipse.org/legal/termsofuse.php>Terms of Use</a></li><li><a href=https://eclipse.org/legal/copyright.php>Copyright Agent</a></li><li><a href=http://www.eclipse.org/legal>Legal Resources</a></li></ul></div><div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright"><p>Eclipse Vert.x is open source and dual-licensed under the <a href=http://www.eclipse.org/legal/epl-v20.html>Eclipse Public License 2.0</a> and <a href=https://www.apache.org/licenses/LICENSE-2.0.html>Apache License 2.0</a>.</p><p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>Design by <a href=https://www.michel-kraemer.com>Michel Kr&auml;mer</a>.</p><div class=row><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2"><a href=http://eclipse.org><img class="logo eclipse-logo" src=https://vertx.io/assets/eclipse_logo_grey_small.png width=204 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0"><a href=http://cloudbees.com><img class="logo cloudbees-logo" src=https://vertx.io/assets/Button-Built-on-CB-1-grey.png width=180 height=48></a></div><div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler"><a href=http://www.ej-technologies.com/products/jprofiler/overview.html style=text-decoration:none><img class="logo jprofiler-logo" src=https://vertx.io/assets/jprofiler-logo.png width=48 height=48><span class=jprofiler-logo>&nbsp; JPROFILER</span></a></div></div></div></div></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js></script><script src=https://vertx.io/javascripts/bootstrap.min.js></script><script src=https://vertx.io/javascripts/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><link rel=stylesheet type=text/css href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css"><script src=//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js></script><script>window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});</script></body></html>